# CI/CD Pipeline and Automation Guide - v1.1.0-beta

**Document Version**: 1.0
**Last Updated**: 2026-01-08
**Status**: Pre-Launch
**Owner**: Engineering Team

---

## Overview

This document defines the complete CI/CD pipeline, automation strategy, and continuous delivery practices for Caro v1.1.0-beta. It ensures reliable, fast, and safe delivery of code changes from development to production.

### Goals

- **Speed**: Push to production in <15 minutes (non-release builds)
- **Safety**: Comprehensive automated testing catches 95%+ of issues
- **Reliability**: <1% pipeline failure rate due to infrastructure
- **Visibility**: Clear status indicators and fast failure feedback

---

## Pipeline Architecture

### High-Level Flow

```
┌─────────────┐
│ Git Push    │
└──────┬──────┘
       │
       v
┌─────────────────────────────────────────────┐
│          GitHub Actions Trigger              │
│  - Push to main/release branches            │
│  - Pull request opened/updated              │
│  - Manual workflow dispatch                 │
└──────┬──────────────────────────────────────┘
       │
       v
┌─────────────────────────────────────────────┐
│          Build Matrix (Parallel)             │
│  ┌──────────┬──────────┬──────────┐         │
│  │  Linux   │  macOS   │ Windows  │         │
│  │  x86_64  │  aarch64 │  x86_64  │         │
│  └────┬─────┴────┬─────┴────┬─────┘         │
└───────┼──────────┼──────────┼───────────────┘
        │          │          │
        v          v          v
┌─────────────────────────────────────────────┐
│     Quality Gates (Per Platform)            │
│  1. Lint (clippy)                           │
│  2. Format check (rustfmt)                  │
│  3. Security audit (cargo-audit)            │
│  4. Unit tests (cargo test)                 │
│  5. Integration tests                       │
│  6. Safety validation tests                 │
│  7. Build release binary                    │
└──────┬──────────────────────────────────────┘
       │
       v
┌─────────────────────────────────────────────┐
│          Artifact Collection                 │
│  - Binaries (per platform)                  │
│  - Test results (JUnit XML)                 │
│  - Coverage reports (codecov)               │
│  - Build logs                               │
└──────┬──────────────────────────────────────┘
       │
       v
┌─────────────────────────────────────────────┐
│     Deployment Decision                      │
│  - PR: Preview deployment only              │
│  - Main: No deployment (trunk-based)        │
│  - Release tag: Production deployment       │
└──────┬──────────────────────────────────────┘
       │
       v (if release tag)
┌─────────────────────────────────────────────┐
│     Production Deployment                    │
│  1. Create GitHub Release                   │
│  2. Upload binaries + checksums             │
│  3. Publish to crates.io                    │
│  4. Update Homebrew tap                     │
│  5. Notify deployment channels              │
└─────────────────────────────────────────────┘
```

---

## GitHub Actions Workflows

### 1. Main CI Workflow (`.github/workflows/ci.yml`)

**Triggers**:
- Push to `main` branch
- Pull request opened/updated
- Manual workflow dispatch

**Jobs**:

#### Job 1: Code Quality (Fast Fail)
```yaml
jobs:
  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Security audit
        run: |
          cargo install cargo-audit
          cargo audit --deny warnings
```

**Success Criteria**: All checks pass
**Typical Duration**: 3-5 minutes

---

#### Job 2: Test Matrix (Parallel)
```yaml
  test:
    name: Test Suite
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, 1.75.0]  # MSRV
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --all-features --verbose

      - name: Run integration tests
        run: cargo test --test '*' --all-features

      - name: Generate coverage (Linux only)
        if: matrix.os == 'ubuntu-latest' && matrix.rust == 'stable'
        run: |
          cargo install cargo-tarpaulin
          cargo tarpaulin --out Xml --all-features

      - name: Upload coverage
        if: matrix.os == 'ubuntu-latest' && matrix.rust == 'stable'
        uses: codecov/codecov-action@v3
```

**Success Criteria**: All tests pass on all platforms
**Typical Duration**: 8-12 minutes

---

#### Job 3: Safety Validation Tests
```yaml
  safety:
    name: Safety Pattern Validation
    needs: quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run safety tests
        run: cargo test --test safety_patterns --verbose

      - name: Validate safety documentation
        run: |
          # Ensure all documented patterns have tests
          python3 scripts/validate_safety_coverage.py
```

**Success Criteria**: All 75 safety tests pass
**Typical Duration**: 5-7 minutes

---

### 2. Release Workflow (`.github/workflows/release.yml`)

**Triggers**:
- Push of tag matching `v*.*.*`

**Jobs**:

#### Job 1: Build Release Binaries
```yaml
jobs:
  build:
    name: Build ${{ matrix.target }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Generate checksum
        run: |
          cd target/${{ matrix.target }}/release
          sha256sum caro > caro.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: caro-${{ matrix.target }}
          path: |
            target/${{ matrix.target }}/release/caro*
            target/${{ matrix.target }}/release/caro.sha256
```

---

#### Job 2: Create GitHub Release
```yaml
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          files: |
            caro-*/caro*
          body_path: .github/RELEASE_TEMPLATE.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

#### Job 3: Publish to Crates.io
```yaml
  publish:
    name: Publish to Crates.io
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish
        run: cargo publish --token ${{ secrets.CARGO_TOKEN }}
```

---

### 3. Nightly Build Workflow (`.github/workflows/nightly.yml`)

**Triggers**:
- Scheduled: Daily at 00:00 UTC
- Manual workflow dispatch

**Purpose**: Catch issues early with extended test suites

**Jobs**:
```yaml
jobs:
  extended-tests:
    name: Extended Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Run extended tests
        run: cargo test --all-features --verbose -- --include-ignored

      - name: Run benchmarks
        run: cargo bench --no-run

      - name: Check documentation
        run: cargo doc --all-features --no-deps
```

---

## Quality Gates

### Pre-Merge Requirements (Pull Requests)

| Gate | Tool | Threshold | Blocking |
|------|------|-----------|----------|
| **Format** | `rustfmt` | 100% compliant | ✅ Yes |
| **Lint** | `clippy` | 0 warnings | ✅ Yes |
| **Security** | `cargo-audit` | 0 vulnerabilities | ✅ Yes |
| **Tests** | `cargo test` | 100% pass | ✅ Yes |
| **Coverage** | `tarpaulin` | >80% line coverage | ⚠️ Warning only |
| **Build** | `cargo build` | Success on all platforms | ✅ Yes |

### Pre-Release Requirements

| Gate | Tool | Threshold | Blocking |
|------|------|-----------|----------|
| **All PR gates** | - | Must pass | ✅ Yes |
| **Safety tests** | Custom suite | 75/75 pass | ✅ Yes |
| **MSRV** | Rust 1.75.0 | Builds + tests pass | ✅ Yes |
| **Documentation** | `cargo doc` | 0 warnings | ✅ Yes |
| **Benchmarks** | `criterion` | Compiles | ⚠️ Warning only |

---

## Caching Strategy

### Rust Dependencies
```yaml
- name: Cache Cargo registry
  uses: actions/cache@v3
  with:
    path: |
      ~/.cargo/registry/index/
      ~/.cargo/registry/cache/
      ~/.cargo/git/db/
    key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    restore-keys: |
      ${{ runner.os }}-cargo-
```

### Build Artifacts
```yaml
- name: Cache build artifacts
  uses: Swatinem/rust-cache@v2
  with:
    shared-key: "build"
    cache-on-failure: true
```

**Expected Impact**:
- First run: ~8 minutes
- Cached run: ~2 minutes (75% faster)

---

## Performance Targets

### Pipeline Duration

| Workflow | Target | Acceptable | Alert |
|----------|--------|------------|-------|
| **PR CI** | <10 min | <15 min | >20 min |
| **Main CI** | <15 min | <20 min | >30 min |
| **Release** | <20 min | <30 min | >45 min |

### Resource Usage

| Metric | Target | Limit |
|--------|--------|-------|
| **Monthly minutes** | <2000 | 3000 (GitHub Free) |
| **Storage** | <500 MB | 500 MB (GitHub Free) |
| **Artifact retention** | 30 days | 90 days max |

---

## Automated Testing Strategy

### Test Pyramid

```
         ┌─────────────┐
         │   Manual    │  (5% - Launch checklist)
         │   Testing   │
         ├─────────────┤
         │ Integration │  (15% - End-to-end flows)
         │    Tests    │
         ├─────────────┤
         │    Unit     │  (80% - Component logic)
         │    Tests    │
         └─────────────┘
```

### Test Categories

#### 1. Unit Tests
- **Location**: Inline in source files (`#[cfg(test)]`)
- **Coverage**: 80%+ line coverage
- **Duration**: <30 seconds total
- **Examples**:
  - Static matcher pattern matching
  - Command validation logic
  - Platform detection
  - Configuration parsing

#### 2. Integration Tests
- **Location**: `tests/` directory
- **Duration**: 1-2 minutes total
- **Examples**:
  - End-to-end command generation
  - Backend integration (static + embedded)
  - Agent loop with validation
  - Configuration file handling

#### 3. Safety Pattern Tests
- **Location**: `tests/safety_patterns.rs`
- **Count**: 75 test cases
- **Duration**: 5-7 minutes
- **Critical**: All must pass for release

#### 4. Property-Based Tests
- **Tool**: `proptest`
- **Usage**: Complex input validation
- **Examples**:
  - Fuzzing command parser
  - Random platform configurations
  - Edge case discovery

---

## Deployment Automation

### Release Process (Automated)

```bash
# Developer action (manual)
$ git tag v1.1.0-beta
$ git push origin v1.1.0-beta

# GitHub Actions (automated)
1. Trigger release workflow
2. Build binaries (6 platforms)
3. Run full test suite
4. Generate checksums
5. Create GitHub release
6. Upload binaries + checksums
7. Publish to crates.io
8. Update Homebrew tap
9. Notify #releases channel
```

**Total Duration**: ~20 minutes from tag push to live

---

### Homebrew Tap Update

```yaml
- name: Update Homebrew tap
  run: |
    cd homebrew-tap
    ./update-formula.sh ${{ github.ref_name }}
    git commit -am "Update caro to ${{ github.ref_name }}"
    git push
```

**Formula Update**:
```ruby
# homebrew-tap/caro.rb
class Caro < Formula
  desc "Natural language shell command generator"
  homepage "https://github.com/example/caro"
  url "https://github.com/example/caro/releases/download/v1.1.0-beta/caro-x86_64-apple-darwin.tar.gz"
  sha256 "..."
  version "1.1.0-beta"

  def install
    bin.install "caro"
  end
end
```

---

## Monitoring and Alerts

### Pipeline Health Dashboard

**GitHub Actions Dashboard**:
- Workflow success rate (target: >98%)
- Average duration by workflow
- Cache hit rate (target: >80%)
- Failed builds by platform

### Alerts

#### Critical (Immediate action)
- Release workflow failure
- Security vulnerability detected
- All tests failing on main

#### Warning (Review within 24h)
- Test flakiness >5%
- Pipeline duration >20% above target
- Coverage drop >10%

#### Info
- Nightly build results
- Dependency updates available
- Performance benchmark changes

---

## Local Development Integration

### Pre-Commit Hooks

Install via `husky` or manual:

```bash
#!/bin/bash
# .git/hooks/pre-commit

# Fast checks before commit
cargo fmt --all -- --check || exit 1
cargo clippy --all-targets -- -D warnings || exit 1
cargo test --lib || exit 1
```

**Duration**: <2 minutes
**Purpose**: Catch issues before push

---

### Pre-Push Hooks

```bash
#!/bin/bash
# .git/hooks/pre-push

# Comprehensive checks before push
cargo test --all-features || exit 1
cargo audit || exit 1
```

**Duration**: <5 minutes
**Purpose**: Ensure CI will pass

---

## Continuous Improvement

### Weekly Review

**Metrics to Track**:
- Pipeline success rate
- Average duration (trend)
- Cache hit rate
- Test flakiness
- Most common failure causes

**Actions**:
- Optimize slow jobs
- Fix flaky tests
- Update dependencies
- Review new Actions/tools

---

### Quarterly Goals

**Q1 2026**:
- Reduce PR CI to <8 minutes
- Achieve 90% cache hit rate
- Implement parallel test execution
- Add visual regression testing

**Q2 2026**:
- Set up self-hosted runners (if needed)
- Implement automated dependency updates (Renovate)
- Add performance regression detection
- Expand cross-platform testing (FreeBSD)

---

## Troubleshooting

### Common Issues

#### 1. Flaky Tests
**Symptom**: Tests pass locally but fail in CI

**Diagnosis**:
```bash
# Run tests 10 times locally
for i in {1..10}; do cargo test || break; done
```

**Solutions**:
- Add `#[serial]` attribute for non-parallel tests
- Increase timeouts for network operations
- Mock external dependencies
- Fix race conditions

---

#### 2. Cache Corruption
**Symptom**: Build fails with strange errors

**Diagnosis**:
- Check cache key changes
- Review recent Cargo.lock updates

**Solution**:
- Clear cache manually in GitHub Actions UI
- Update cache key version

---

#### 3. Platform-Specific Failures
**Symptom**: Tests pass on macOS but fail on Linux

**Diagnosis**:
- Check platform-specific code paths
- Review command differences (BSD vs GNU)

**Solution**:
- Add platform-specific test cases
- Use conditional compilation (`#[cfg(target_os = "...")]`)

---

## Security Considerations

### Secret Management

**GitHub Secrets Used**:
- `CARGO_TOKEN`: crates.io publishing
- `HOMEBREW_TAP_TOKEN`: Homebrew formula updates
- `DISCORD_WEBHOOK`: Deployment notifications (optional)

**Rotation Policy**: Every 90 days or on team member departure

---

### Supply Chain Security

**Automated Checks**:
- Daily `cargo-audit` runs (nightly workflow)
- Dependency review on PRs (GitHub Dependabot)
- SBOM generation for releases

**Response Process**:
- Critical vulnerability: Patch within 24h
- High vulnerability: Patch within 7 days
- Medium/Low: Review in weekly triage

---

## Rollback Procedures

### Rolling Back a Release

**If critical issue discovered after release**:

```bash
# 1. Yank from crates.io (prevents new installs)
$ cargo yank --vers 1.1.0-beta

# 2. Delete GitHub release (optional, retains tag)
$ gh release delete v1.1.0-beta

# 3. Revert Homebrew formula
$ cd homebrew-tap
$ git revert HEAD
$ git push

# 4. Communicate in all channels
# Post to GitHub Discussions, Discord, Twitter/X
```

**Alternative**: Rapid patch release (v1.1.1-beta)

---

## Cost Optimization

### GitHub Actions Minutes

**Current Usage** (estimated):
- PR CI: ~30 PRs/month × 15 min = 450 min
- Main CI: ~60 pushes/month × 20 min = 1200 min
- Nightly: 30 runs × 30 min = 900 min
- **Total**: ~2550 min/month

**Budget**: 3000 min/month (GitHub Free Tier)

**Optimization Strategies**:
1. Skip CI on docs-only changes
2. Use `fail-fast: true` for test matrix
3. Optimize cache usage
4. Consider self-hosted runners for high-volume periods

---

## Documentation

### Pipeline Documentation

**README.md** (Project root):
- Quick start for running tests locally
- Link to this guide

**CONTRIBUTING.md**:
- How to run CI checks before pushing
- Pre-commit hook installation
- Test writing guidelines

**Workflow Files**:
- Inline comments explaining complex steps
- Links to external documentation

---

## Success Metrics

### KPIs (Track Weekly)

| Metric | Target | Current | Trend |
|--------|--------|---------|-------|
| **Pipeline success rate** | >98% | - | - |
| **PR CI duration** | <10 min | - | - |
| **Main CI duration** | <15 min | - | - |
| **Release duration** | <20 min | - | - |
| **Cache hit rate** | >80% | - | - |
| **Test coverage** | >80% | - | - |
| **Flaky test rate** | <2% | - | - |

### Review Schedule

- **Daily**: Check failed workflows
- **Weekly**: Review metrics dashboard
- **Monthly**: Analyze trends and optimize
- **Quarterly**: Major improvements and upgrades

---

## Appendix A: Workflow File Locations

```
.github/
├── workflows/
│   ├── ci.yml                 # Main CI pipeline
│   ├── release.yml            # Release automation
│   ├── nightly.yml            # Extended tests
│   └── dependency-audit.yml   # Daily security checks
├── RELEASE_TEMPLATE.md        # Release notes template
└── CODEOWNERS                 # Auto-assign reviewers
```

---

## Appendix B: Badge Configuration

**README.md badges**:

```markdown
[![CI](https://github.com/example/caro/workflows/CI/badge.svg)](https://github.com/example/caro/actions)
[![codecov](https://codecov.io/gh/example/caro/branch/main/graph/badge.svg)](https://codecov.io/gh/example/caro)
[![Crates.io](https://img.shields.io/crates/v/caro.svg)](https://crates.io/crates/caro)
[![Security Audit](https://github.com/example/caro/workflows/Security%20Audit/badge.svg)](https://github.com/example/caro/actions)
```

---

## Document Control

**Change History**:
- v1.0 (2026-01-08): Initial creation for v1.1.0-beta launch

**Review Cycle**: Update after each major release

**Owner**: Engineering Lead

**Stakeholders**:
- DevOps Engineer
- QA Lead
- Release Manager

---

## References

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Rust CI Best Practices](https://doc.rust-lang.org/cargo/guide/continuous-integration.html)
- [Cargo Release Process](https://doc.rust-lang.org/cargo/reference/publishing.html)
- [Supply Chain Security Guide](../v1.1.0-dependency-management-supply-chain.md)
- [Security Compliance Guide](../v1.1.0-security-compliance-guide.md)

---

**Document Status**: ✅ Ready for Implementation
**Next Review**: Post-Launch (Jan 2026)