# v1.1.0 Dependency Management & Supply Chain Security

**Version**: 1.0
**Last Updated**: 2026-01-08
**Owner**: Security Lead + Engineering Lead
**Status**: Active

---

## Executive Summary

This document defines comprehensive dependency management practices, supply chain security measures, and upgrade strategies for v1.1.0-beta. It ensures our dependency tree remains secure, up-to-date, and auditable throughout the release lifecycle.

**Philosophy**: **Trust but Verify** - Use dependencies judiciously, audit regularly, and maintain control over our supply chain.

**Key Practices**:
- Daily security audits (`cargo audit`)
- Quarterly dependency updates
- License compliance verification
- Minimal dependency footprint
- Transparent dependency attribution

---

## Table of Contents

1. [Dependency Inventory](#dependency-inventory)
2. [Dependency Selection Criteria](#dependency-selection-criteria)
3. [Security Auditing](#security-auditing)
4. [Update Strategy](#update-strategy)
5. [License Compliance](#license-compliance)
6. [Supply Chain Attacks](#supply-chain-attacks)
7. [Dependency Attribution](#dependency-attribution)

---

## Dependency Inventory

### Direct Dependencies (Cargo.toml)

**Core Functionality**:
```toml
[dependencies]
# CLI and async runtime
clap = { version = "4.4", features = ["derive"] }
tokio = { version = "1.35", features = ["full"] }

# Error handling
anyhow = "1.0"
thiserror = "1.0"

# Serialization
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
toml = "0.8"

# ML/AI
candle-core = "0.3"
candle-nn = "0.3"
candle-transformers = "0.3"
hf-hub = "0.3"
tokenizers = "0.15"

# Utilities
lazy_static = "1.4"
regex = "1.10"
log = "0.4"
env_logger = "0.11"

# Storage
rusqlite = { version = "0.30", features = ["bundled"] }

# Platform
dirs = "5.0"
```

**Total Direct**: ~20 crates
**Total Transitive**: ~150 crates (via `cargo tree`)

---

### Dependency Categories

| Category | Count | Purpose | Risk Level |
|----------|-------|---------|------------|
| **CLI/UX** | 2 | clap, tokio | Low |
| **ML/AI** | 5 | candle, hf-hub, tokenizers | Medium |
| **Serialization** | 3 | serde, serde_json, toml | Low |
| **Storage** | 1 | rusqlite | Low |
| **Utilities** | 5 | anyhow, regex, log, etc. | Low |
| **Platform** | 1 | dirs | Low |

**Risk Assessment**:
- **Low**: Well-maintained, widely-used, no native code
- **Medium**: ML dependencies (native code, larger attack surface)
- **High**: None in current inventory

---

### Dependency Tree Visualization

```bash
# Generate full dependency tree
cargo tree > dependency-tree.txt

# Count dependencies
cargo tree --depth 1 | grep -c "‚îú‚îÄ‚îÄ"

# Check for duplicates (multiple versions)
cargo tree --duplicates
```

**Example Output**:
```
caro v1.1.0-beta
‚îú‚îÄ‚îÄ clap v4.4.11
‚îÇ   ‚îú‚îÄ‚îÄ clap_derive v4.4.7
‚îÇ   ‚îî‚îÄ‚îÄ clap_lex v0.6.0
‚îú‚îÄ‚îÄ tokio v1.35.1
‚îÇ   ‚îú‚îÄ‚îÄ bytes v1.5.0
‚îÇ   ‚îî‚îÄ‚îÄ pin-project-lite v0.2.13
‚îú‚îÄ‚îÄ candle-core v0.3.3
‚îÇ   ‚îú‚îÄ‚îÄ safetensors v0.4.1
‚îÇ   ‚îî‚îÄ‚îÄ half v2.3.1
...
```

---

## Dependency Selection Criteria

### Before Adding a New Dependency

**Checklist**:
```markdown
## Dependency Evaluation: [Crate Name]

**Justification**:
- [ ] What problem does it solve?
- [ ] Can we implement it ourselves? (cost/benefit)
- [ ] Is it widely used? (>10K downloads/month)

**Security**:
- [ ] Recent activity? (commits in last 6 months)
- [ ] No known vulnerabilities? (check RustSec)
- [ ] Trusted maintainer or organization?

**Code Quality**:
- [ ] Well-documented?
- [ ] Reasonable code quality? (review on GitHub)
- [ ] Minimal transitive dependencies? (<20 transitive)

**Licensing**:
- [ ] Compatible license? (MIT, Apache-2.0, BSD)
- [ ] No copyleft? (GPL, AGPL)

**Size/Performance**:
- [ ] Reasonable compile time? (<5s)
- [ ] Acceptable binary size impact? (<1MB)
- [ ] No native dependencies? (or audited if necessary)

**Decision**: ‚òê Approve / ‚òê Reject / ‚òê Needs Discussion
```

---

### Red Flags (Auto-Reject)

- ‚ùå **Unmaintained**: No commits in >2 years
- ‚ùå **Unknown Author**: <100 downloads/month, unknown maintainer
- ‚ùå **Native Code**: Heavy C/C++ dependencies (without strong justification)
- ‚ùå **GPL License**: Strong copyleft conflicts with our dual MIT/Apache-2.0
- ‚ùå **Known Vulnerabilities**: Active CVEs listed in RustSec
- ‚ùå **Massive Dependencies**: >50 transitive dependencies

---

### Green Flags (Fast-Track)

- ‚úÖ **Rust Std-Aware**: Part of rust-lang ecosystem (e.g., tokio, serde)
- ‚úÖ **Widely Used**: >100K downloads/month
- ‚úÖ **Security Focused**: Regular audits, responsible disclosure
- ‚úÖ **MIT/Apache-2.0**: Compatible licensing
- ‚úÖ **Pure Rust**: No native code (compile-time safety)

---

## Security Auditing

### Daily Automated Audits

**CI/CD Integration**: `.github/workflows/security-audit.yml`

```yaml
name: Security Audit

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run security audit
        run: cargo audit --deny warnings --deny unmaintained --deny unsound

      - name: Check for yanked crates
        run: cargo audit --deny yanked

      - name: Upload results
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: audit-results
          path: target/audit.log
```

**Alert on Failure**: Slack/Discord notification

---

### Manual Quarterly Reviews

**Schedule**: Every 3 months (January, April, July, October)

**Process**:
1. **Full Dependency Review**:
   ```bash
   cargo tree --depth 1 > deps-current.txt
   diff deps-previous.txt deps-current.txt
   ```

2. **Security Audit**:
   ```bash
   cargo audit
   cargo audit --stale  # Check for outdated advisories
   ```

3. **License Compliance**:
   ```bash
   cargo install cargo-license
   cargo license --json > licenses.json
   python scripts/check_licenses.py
   ```

4. **Update Recommendations**:
   - Which dependencies have updates?
   - Are updates security-related?
   - Breaking changes?

5. **Document Decisions**:
   - `.claude/releases/dependency-reviews/2026-Q1.md`

---

### Vulnerability Response Process

**Trigger**: `cargo audit` reports vulnerability

**Timeline**:
- **T+0**: Vulnerability detected
- **T+4h**: Severity assessed (Critical / High / Medium / Low)
- **T+24h**: Fix PR created (Critical/High)
- **T+7d**: Fix PR created (Medium/Low)

**Actions**:

**Critical (CVSS ‚â•9.0)**:
```bash
# Immediate hotfix
1. Update vulnerable dependency
2. Run full test suite
3. Deploy hotfix (v1.1.1) within 24h
4. Notify users via Discord, Twitter, email
```

**High (CVSS 7.0-8.9)**:
```bash
# Urgent fix
1. Update vulnerable dependency
2. Test thoroughly
3. Deploy fix in next patch (v1.1.1) within 7 days
4. Include in changelog
```

**Medium/Low (CVSS <7.0)**:
```bash
# Scheduled fix
1. Update in next minor release (v1.2.0)
2. Document in CHANGELOG
3. No emergency announcement
```

---

### Example Vulnerability Response

**Scenario**: `rusqlite` has CVE-2024-XXXXX (SQL injection via prepared statements)

**Severity**: High (CVSS 8.2)

**Actions**:
```bash
# 1. Update rusqlite
cargo update -p rusqlite

# 2. Verify fix
cargo audit  # Should show no vulnerabilities

# 3. Test
cargo test --all

# 4. Create PR
git checkout -b security/rusqlite-cve-2024-xxxxx
git add Cargo.lock
git commit -m "fix(deps): update rusqlite to patch CVE-2024-XXXXX

Severity: High (CVSS 8.2)
Impact: SQL injection vulnerability in prepared statements
Fix: rusqlite 0.30.0 ‚Üí 0.30.1

CVE: CVE-2024-XXXXX
RustSec: RUSTSEC-2024-XXXX"

git push origin security/rusqlite-cve-2024-xxxxx
gh pr create --title "Security: Patch rusqlite CVE-2024-XXXXX" --body "..."

# 5. Merge and release
# (After CI passes and review)
git checkout main
git merge security/rusqlite-cve-2024-xxxxx
cargo release --execute 1.1.1

# 6. Notify users
# Discord, Twitter, GitHub Security Advisory
```

---

## Update Strategy

### Update Cadence

| Type | Frequency | Trigger | Process |
|------|-----------|---------|---------|
| **Security Updates** | Immediate | CVE discovered | Hotfix release |
| **Minor Updates** | Quarterly | Scheduled review | PR + testing |
| **Major Updates** | Annually | Major version bumps | Careful evaluation |

---

### Semantic Versioning Strategy

**For Dependencies**:
- `^1.2.3`: Allow patch + minor updates (recommended)
- `~1.2.3`: Allow patch updates only (conservative)
- `=1.2.3`: Pin exact version (avoid unless necessary)

**Current Strategy**:
```toml
[dependencies]
# Major dependencies: Conservative (minor updates only)
tokio = "1.35"        # Allows 1.35.x ‚Üí 1.x.x
clap = "4.4"          # Allows 4.4.x ‚Üí 4.x.x

# Utilities: Flexible (patch + minor)
anyhow = "1.0"        # Allows 1.0.x ‚Üí 1.x.x
log = "0.4"           # Allows 0.4.x ‚Üí 0.x.x

# ML crates: Pinned (breaking changes frequent)
candle-core = "=0.3.3"  # Exact version
```

---

### Update Process

**Quarterly Update Review**:

```bash
# 1. Check for outdated dependencies
cargo outdated

# Example output:
# Name         Project  Compat  Latest
# tokio        1.35.0   1.35.1  1.36.0
# clap         4.4.11   4.4.18  5.0.0
# candle-core  0.3.3    0.3.3   0.4.0

# 2. Categorize updates
# - Patch (1.35.0 ‚Üí 1.35.1): Safe, auto-apply
# - Minor (4.4.11 ‚Üí 4.4.18): Safe, auto-apply
# - Major (4.4.11 ‚Üí 5.0.0): Breaking changes, manual review

# 3. Apply safe updates
cargo update

# 4. Test
cargo test --all
cargo clippy

# 5. Review breaking changes
# (For major updates like clap 4 ‚Üí 5)
# - Read CHANGELOG
# - Identify breaking changes
# - Plan migration

# 6. Commit
git add Cargo.lock
git commit -m "chore(deps): quarterly dependency update Q1 2026

Updated:
- tokio 1.35.0 ‚Üí 1.35.1
- clap 4.4.11 ‚Üí 4.4.18
- anyhow 1.0.75 ‚Üí 1.0.79

Skipped (major updates):
- clap 4.4.18 ‚Üí 5.0.0 (breaking changes, defer to v1.3.0)

Security: cargo audit clean
Tests: All passing"
```

---

### Breaking Change Migration

**Example**: Migrating `clap` 4.x ‚Üí 5.x

**Step 1: Research** (2 hours)
- Read clap 5.0 CHANGELOG
- Read migration guide
- Identify affected code

**Step 2: Create Branch**
```bash
git checkout -b deps/clap-5-migration
```

**Step 3: Update**
```bash
# Update Cargo.toml
sed -i 's/clap = "4.4"/clap = "5.0"/' Cargo.toml

# Try to build (will fail)
cargo build 2> migration-errors.txt
```

**Step 4: Fix Breaking Changes**
```rust
// Old (clap 4):
use clap::{Parser, Subcommand};

#[derive(Parser)]
struct Cli {
    #[clap(subcommand)]
    command: Commands,
}

// New (clap 5):
use clap::{Parser, Subcommand};

#[derive(Parser)]
struct Cli {
    #[command(subcommand)]  // Changed: clap ‚Üí command
    command: Commands,
}
```

**Step 5: Test Thoroughly**
```bash
cargo test --all
cargo clippy
cargo build --release

# Manual testing
./target/release/caro --help
./target/release/caro "list files"
```

**Step 6: PR and Review**
```bash
git commit -m "deps: migrate clap 4.x to 5.x

Breaking changes:
- #[clap(...)] ‚Üí #[command(...)]
- Arg::new() ‚Üí Arg::new().id()

Tested:
- All unit tests pass
- CLI help working
- Command generation working

Migration guide: https://github.com/clap-rs/clap/blob/v5.0.0/CHANGELOG.md"
```

---

## License Compliance

### Acceptable Licenses

**Compatible** (can use freely):
- ‚úÖ MIT
- ‚úÖ Apache-2.0
- ‚úÖ BSD-2-Clause
- ‚úÖ BSD-3-Clause
- ‚úÖ ISC
- ‚úÖ Unlicense
- ‚úÖ Public Domain

**Requires Review**:
- ‚ö†Ô∏è MPL-2.0 (weak copyleft, usually OK)
- ‚ö†Ô∏è LGPL-2.1+ (weak copyleft, requires dynamic linking)

**Prohibited**:
- ‚ùå GPL-2.0
- ‚ùå GPL-3.0
- ‚ùå AGPL-3.0

---

### License Auditing

**Tool**: `cargo-license`

```bash
# Install
cargo install cargo-license

# Generate report
cargo license --json > licenses.json

# Check for prohibited licenses
cargo license | grep -E "GPL|AGPL"

# Example output:
# (empty - all licenses compatible)
```

**Python Script**: `scripts/check_licenses.py`

```python
import json
import sys

PROHIBITED = ["GPL-2.0", "GPL-3.0", "AGPL-3.0"]
REQUIRES_REVIEW = ["MPL-2.0", "LGPL-2.1"]

with open("licenses.json") as f:
    deps = json.load(f)

for dep in deps:
    license = dep.get("license", "UNKNOWN")

    if license in PROHIBITED:
        print(f"‚ùå {dep['name']}: {license} (PROHIBITED)")
        sys.exit(1)

    if license in REQUIRES_REVIEW:
        print(f"‚ö†Ô∏è  {dep['name']}: {license} (REQUIRES REVIEW)")

print("‚úÖ All licenses compatible")
```

**CI Integration**:
```yaml
- name: Check licenses
  run: |
    cargo install cargo-license
    cargo license --json > licenses.json
    python scripts/check_licenses.py
```

---

### NOTICE File Generation

**For Apache-2.0 Compliance**:

```bash
# Generate NOTICE file
cargo install cargo-about
cargo about generate about.hbs > NOTICE

# NOTICE file content:
# caro - Natural Language to Shell Commands
# Copyright 2024-2026 caro Contributors
#
# This product includes software developed by:
# - The Rust Project (https://www.rust-lang.org/)
# - Tokio Contributors (https://tokio.rs/)
# - Clap Contributors (https://github.com/clap-rs/clap)
# ...
```

---

## Supply Chain Attacks

### Threat Model

**Attack Vectors**:

1. **Compromised Maintainer Account**:
   - Attacker gains access to crates.io account
   - Publishes malicious version

2. **Dependency Confusion**:
   - Attacker publishes crate with similar name
   - Typosquatting (e.g., `tokioo` instead of `tokio`)

3. **Compromised Build System**:
   - CI/CD pipeline compromised
   - Malicious code injected during build

4. **Transitive Dependency Attack**:
   - Direct dependency is safe
   - Transitive dependency compromised

---

### Mitigation Strategies

**1. Cargo.lock Committed**

```bash
# Always commit Cargo.lock
git add Cargo.lock
git commit -m "chore: update Cargo.lock"
```

**Why**: Pins exact versions, prevents supply chain drift

---

**2. Crates.io Checksum Verification**

Cargo automatically verifies checksums from crates.io index:

```toml
# Cargo.lock includes checksums
[[package]]
name = "tokio"
version = "1.35.1"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "c89b4efa943be685f629b149f53829423f8f5531ea21249408e8e2f8671ec104"
```

**Verification**:
```bash
cargo verify-project  # Checks Cargo.toml syntax
cargo fetch --locked  # Downloads and verifies checksums
```

---

**3. Dependency Review Before Updates**

**Never blindly run `cargo update`**:

```bash
# Bad: Updates all dependencies without review
cargo update

# Good: Review changes first
cargo outdated > outdated.txt
# Manually review outdated.txt
# Update specific dependencies
cargo update -p tokio
cargo update -p clap
```

---

**4. Monitor for Suspicious Activity**

**Tools**:
- GitHub Dependabot Alerts
- RustSec Advisory Database
- crates.io package yanking notifications

**Suspicious Signals**:
- ‚ö†Ô∏è Sudden maintainer change
- ‚ö†Ô∏è Dependency adds network calls
- ‚ö†Ô∏è Binary size increases significantly
- ‚ö†Ô∏è Build time increases 10x
- ‚ö†Ô∏è New native dependencies added

---

**5. Minimal Dependency Philosophy**

**Question every dependency**:
- Can we implement it ourselves? (cost: 1 day vs. supply chain risk)
- Do we need all its features? (feature flags to reduce transitive deps)
- Is it widely used? (>10K downloads = more eyes on code)

**Example**:
```toml
# Bad: Pulls in 50 transitive dependencies
clap = { version = "4.4", features = ["everything"] }

# Good: Only what we need
clap = { version = "4.4", features = ["derive"] }
```

---

## Dependency Attribution

### THIRD_PARTY_LICENSES File

**Generate Full Attribution**:

```bash
cargo install cargo-about

# Generate attribution
cargo about generate about.hbs > THIRD_PARTY_LICENSES.md
```

**Example Output**:
```markdown
# Third-Party Licenses

This product includes software developed by third parties:

## tokio (1.35.1)
**License**: MIT
**Copyright**: Tokio Contributors
**Repository**: https://github.com/tokio-rs/tokio

Permission is hereby granted, free of charge...

---

## clap (4.4.11)
**License**: MIT OR Apache-2.0
**Copyright**: clap Contributors
**Repository**: https://github.com/clap-rs/clap

Licensed under the Apache License, Version 2.0...

---

[... all dependencies listed ...]
```

---

### Binary Attribution

**Include in Release**:
```bash
# Add to GitHub release
gh release upload v1.1.0-beta \
  THIRD_PARTY_LICENSES.md \
  --clobber
```

**Include in Binary**:
```rust
// src/commands/licenses.rs
pub fn show_licenses() {
    println!("{}", include_str!("../../THIRD_PARTY_LICENSES.md"));
}

// Accessible via:
// $ caro licenses
```

---

## Dependency Health Scorecard

**Monthly Metrics**:

| Metric | Target | Current | Status |
|--------|--------|---------|--------|
| **Total Dependencies** | <25 direct | 20 | ‚úÖ |
| **Outdated Dependencies** | <5 | 3 | ‚úÖ |
| **Security Vulnerabilities** | 0 | 0 | ‚úÖ |
| **Unmaintained Dependencies** | 0 | 0 | ‚úÖ |
| **License Violations** | 0 | 0 | ‚úÖ |

**Report Generation**:
```bash
#!/bin/bash
# scripts/dependency-health.sh

echo "# Dependency Health Report"
echo "Date: $(date)"
echo ""

echo "## Totals"
echo "Direct: $(cargo tree --depth 1 | grep -c "‚îú‚îÄ‚îÄ")"
echo "Transitive: $(cargo tree | grep -c "‚îú‚îÄ‚îÄ")"
echo ""

echo "## Outdated"
cargo outdated | tail -n +3
echo ""

echo "## Security"
cargo audit
echo ""

echo "## Licenses"
cargo license | sort | uniq -c
```

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-08 | Security Lead + Engineering Lead | Initial dependency management & supply chain security guide |

---

**End of Document**

üîí **Supply Chain Security Ready**

Comprehensive dependency management with security auditing, update strategies, license compliance, and supply chain attack mitigation for safe and maintainable v1.1.0-beta release.
