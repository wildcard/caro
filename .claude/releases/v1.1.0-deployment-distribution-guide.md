# Deployment & Distribution Guide
**v1.1.0-beta Release**

---

## Document Metadata

| Field | Value |
|-------|-------|
| **Purpose** | Document build, packaging, distribution, and installation procedures for caro across all platforms |
| **Audience** | Release Manager, DevOps Team, Maintainers, Package Maintainers |
| **Scope** | Multi-platform builds, binary packaging, distribution channels, installation methods, update mechanisms |
| **Last Updated** | 2026-01-08 |
| **Related Documents** | [Hotfix Protocol](v1.1.0-hotfix-protocol.md), [Version Management Guide](v1.1.0-version-management-guide.md) |
| **Status** | DRAFT - Ready for v1.1.0-beta |

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Build Infrastructure](#build-infrastructure)
3. [Platform-Specific Builds](#platform-specific-builds)
4. [Binary Packaging](#binary-packaging)
5. [Distribution Channels](#distribution-channels)
6. [Installation Methods](#installation-methods)
7. [Update Mechanisms](#update-mechanisms)
8. [Release Artifacts](#release-artifacts)
9. [CI/CD Pipeline](#cicd-pipeline)
10. [Distribution Checklist](#distribution-checklist)
11. [Troubleshooting](#troubleshooting)
12. [Appendices](#appendices)

---

## Executive Summary

### Purpose

This guide establishes **comprehensive deployment and distribution procedures** for caro to ensure:

1. ‚úÖ **Multi-Platform Support**: macOS (ARM64, x86_64), Linux (x86_64, ARM64), Windows (x86_64)
2. ‚úÖ **Reproducible Builds**: Consistent binaries across environments
3. ‚úÖ **Secure Distribution**: Checksums, signatures, verified downloads
4. ‚úÖ **Easy Installation**: Multiple methods (curl script, package managers, manual)
5. ‚úÖ **Smooth Updates**: Automatic update notifications, seamless upgrades

### Supported Platforms (v1.1.0-beta)

| Platform | Architecture | Status | Install Method |
|----------|-------------|--------|----------------|
| **macOS** | ARM64 (Apple Silicon) | ‚úÖ PRIMARY | Homebrew, curl script |
| **macOS** | x86_64 (Intel) | ‚úÖ SUPPORTED | Homebrew, curl script |
| **Linux** | x86_64 (GNU libc) | ‚úÖ SUPPORTED | curl script, .deb, .rpm |
| **Linux** | ARM64 | ‚ö†Ô∏è EXPERIMENTAL | curl script |
| **Linux** | musl (Alpine) | ‚ö†Ô∏è EXPERIMENTAL | Static binary |
| **Windows** | x86_64 | ‚è∏Ô∏è PLANNED v1.2.0 | MSI installer |

### Distribution Channels

| Channel | Platform | Audience | Update Frequency |
|---------|----------|----------|------------------|
| **GitHub Releases** | All | All users | Every release |
| **crates.io** | All (source) | Rust developers | Every release |
| **Homebrew** | macOS | macOS users | Within 24 hours |
| **install.sh** | macOS, Linux | Quick installers | Every release |
| **.deb packages** | Debian/Ubuntu | Linux users | Within 48 hours |
| **.rpm packages** | Fedora/RHEL | Linux users | Within 48 hours |

---

## Build Infrastructure

### Build Environment

**Standardized Build Environment** ensures reproducible builds:

#### macOS (ARM64)
```yaml
OS: macOS 14.x (Sonoma)
CPU: Apple M2 Pro (or newer)
RAM: 16GB minimum
Rust: stable (latest)
Xcode: 15.x
Target: aarch64-apple-darwin
```

#### macOS (x86_64)
```yaml
OS: macOS 14.x (Sonoma)
CPU: Intel Core i7 (or newer)
RAM: 16GB minimum
Rust: stable (latest)
Xcode: 15.x
Target: x86_64-apple-darwin
```

#### Linux (x86_64)
```yaml
OS: Ubuntu 22.04 LTS
CPU: AMD Ryzen or Intel (x86_64)
RAM: 8GB minimum
Rust: stable (latest)
Target: x86_64-unknown-linux-gnu
```

#### Linux (ARM64)
```yaml
OS: Ubuntu 22.04 LTS (ARM64)
CPU: ARM Cortex-A72 (or newer)
RAM: 4GB minimum
Rust: stable (latest)
Target: aarch64-unknown-linux-gnu
```

---

### Build Configuration

**Cargo.toml** (Release Profile):
```toml
[profile.release]
opt-level = 3           # Maximum optimization
lto = true              # Link-time optimization
codegen-units = 1       # Single codegen unit for better optimization
strip = true            # Strip debug symbols
panic = "abort"         # Smaller binary size

[profile.release.package."*"]
opt-level = 3
```

**Build Flags**:
```bash
# Standard release build
RUSTFLAGS="-C target-cpu=native" cargo build --release

# macOS: Universal binary (ARM64 + x86_64)
cargo build --release --target aarch64-apple-darwin
cargo build --release --target x86_64-apple-darwin
lipo -create \
  target/aarch64-apple-darwin/release/caro \
  target/x86_64-apple-darwin/release/caro \
  -output caro-universal

# Linux: Static binary (musl)
cargo build --release --target x86_64-unknown-linux-musl
```

---

### Cross-Compilation

**Install Cross-Compilation Targets**:
```bash
# macOS targets
rustup target add aarch64-apple-darwin
rustup target add x86_64-apple-darwin

# Linux targets
rustup target add x86_64-unknown-linux-gnu
rustup target add aarch64-unknown-linux-gnu
rustup target add x86_64-unknown-linux-musl

# Windows target (future)
rustup target add x86_64-pc-windows-msvc
```

**Cross-Compilation Tools**:
```bash
# Install cross for Linux cross-compilation
cargo install cross

# Cross-compile to Linux ARM64 from x86_64
cross build --release --target aarch64-unknown-linux-gnu

# Cross-compile to musl (static linking)
cross build --release --target x86_64-unknown-linux-musl
```

---

## Platform-Specific Builds

### macOS Builds

#### Universal Binary (ARM64 + x86_64)

**Goal**: Single binary that runs natively on both Apple Silicon and Intel Macs.

```bash
#!/bin/bash
# scripts/build_macos_universal.sh

set -e

echo "üçé Building macOS universal binary..."

# 1. Build for Apple Silicon
echo "Building ARM64 binary..."
cargo build --release --target aarch64-apple-darwin

# 2. Build for Intel
echo "Building x86_64 binary..."
cargo build --release --target x86_64-apple-darwin

# 3. Create universal binary
echo "Creating universal binary..."
lipo -create \
  target/aarch64-apple-darwin/release/caro \
  target/x86_64-apple-darwin/release/caro \
  -output target/release/caro-universal

# 4. Verify
echo "Verifying universal binary..."
lipo -info target/release/caro-universal

# 5. Create distribution tarball
echo "Creating tarball..."
cd target/release
tar -czf caro-macos-universal.tar.gz caro-universal
shasum -a 256 caro-macos-universal.tar.gz > caro-macos-universal.tar.gz.sha256

echo "‚úÖ macOS universal binary built successfully"
```

**Output**:
```
Architectures in the fat file: target/release/caro-universal are: x86_64 arm64
```

---

#### Code Signing (macOS)

**Required for Distribution**:
```bash
# Sign binary with Developer ID
codesign --force --sign "Developer ID Application: Your Name" \
  --options runtime \
  --timestamp \
  target/release/caro

# Verify signature
codesign --verify --verbose target/release/caro

# Create DMG (optional)
hdiutil create -volname "Caro" \
  -srcfolder target/release/caro \
  -ov -format UDZO \
  caro-macos.dmg

# Sign DMG
codesign --sign "Developer ID Application: Your Name" \
  caro-macos.dmg
```

**Notarization** (Required for macOS 10.15+):
```bash
# Submit for notarization
xcrun notarytool submit caro-macos.dmg \
  --apple-id "your@email.com" \
  --team-id "TEAMID" \
  --password "@keychain:AC_PASSWORD" \
  --wait

# Staple notarization ticket
xcrun stapler staple caro-macos.dmg

# Verify notarization
spctl -a -v caro-macos.dmg
```

---

### Linux Builds

#### Debian/Ubuntu (.deb)

**Package Structure**:
```
caro_1.1.0-beta_amd64.deb
‚îú‚îÄ‚îÄ DEBIAN/
‚îÇ   ‚îú‚îÄ‚îÄ control       # Package metadata
‚îÇ   ‚îú‚îÄ‚îÄ postinst      # Post-installation script
‚îÇ   ‚îî‚îÄ‚îÄ prerm         # Pre-removal script
‚îî‚îÄ‚îÄ usr/
    ‚îú‚îÄ‚îÄ bin/
    ‚îÇ   ‚îî‚îÄ‚îÄ caro      # Binary
    ‚îî‚îÄ‚îÄ share/
        ‚îú‚îÄ‚îÄ doc/
        ‚îÇ   ‚îî‚îÄ‚îÄ caro/
        ‚îÇ       ‚îú‚îÄ‚îÄ README.md
        ‚îÇ       ‚îî‚îÄ‚îÄ copyright
        ‚îî‚îÄ‚îÄ man/
            ‚îî‚îÄ‚îÄ man1/
                ‚îî‚îÄ‚îÄ caro.1.gz  # Man page
```

**Build Script** (`scripts/build_deb.sh`):
```bash
#!/bin/bash
set -e

VERSION="1.1.0-beta"
ARCH="amd64"
PKG_NAME="caro_${VERSION}_${ARCH}"

echo "üì¶ Building .deb package..."

# 1. Build release binary
cargo build --release --target x86_64-unknown-linux-gnu

# 2. Create package structure
mkdir -p "${PKG_NAME}/DEBIAN"
mkdir -p "${PKG_NAME}/usr/bin"
mkdir -p "${PKG_NAME}/usr/share/doc/caro"
mkdir -p "${PKG_NAME}/usr/share/man/man1"

# 3. Copy binary
cp target/x86_64-unknown-linux-gnu/release/caro \
   "${PKG_NAME}/usr/bin/"
strip "${PKG_NAME}/usr/bin/caro"

# 4. Create control file
cat > "${PKG_NAME}/DEBIAN/control" << EOF
Package: caro
Version: ${VERSION}
Section: utils
Priority: optional
Architecture: ${ARCH}
Maintainer: Caro Team <team@caro-project.org>
Description: Natural language to shell command converter
 Caro converts natural language descriptions into safe,
 platform-aware shell commands using AI.
Homepage: https://github.com/your-org/caro
Depends: libc6 (>= 2.31)
EOF

# 5. Create postinst script
cat > "${PKG_NAME}/DEBIAN/postinst" << 'EOF'
#!/bin/bash
set -e

# Create telemetry directory
mkdir -p /var/lib/caro

# Set permissions
chmod 755 /usr/bin/caro

echo "‚úÖ Caro installed successfully"
echo "Run 'caro --help' to get started"
EOF
chmod 755 "${PKG_NAME}/DEBIAN/postinst"

# 6. Copy documentation
cp README.md "${PKG_NAME}/usr/share/doc/caro/"
cp LICENSE "${PKG_NAME}/usr/share/doc/caro/copyright"

# 7. Create man page (if exists)
if [ -f "docs/caro.1" ]; then
  gzip -c docs/caro.1 > "${PKG_NAME}/usr/share/man/man1/caro.1.gz"
fi

# 8. Build package
dpkg-deb --build "${PKG_NAME}"

# 9. Create checksum
sha256sum "${PKG_NAME}.deb" > "${PKG_NAME}.deb.sha256"

echo "‚úÖ .deb package built: ${PKG_NAME}.deb"
```

**Install .deb**:
```bash
# Install
sudo dpkg -i caro_1.1.0-beta_amd64.deb

# Verify
caro --version

# Uninstall
sudo dpkg -r caro
```

---

#### Red Hat/Fedora (.rpm)

**Build .rpm with `cargo-rpm`**:
```bash
# Install cargo-rpm
cargo install cargo-rpm

# Initialize RPM configuration
cargo rpm init

# Build RPM
cargo rpm build

# Output: target/release/rpmbuild/RPMS/x86_64/caro-1.1.0_beta-1.x86_64.rpm
```

**RPM Spec File** (`.rpm/caro.spec`):
```spec
Name: caro
Version: 1.1.0_beta
Release: 1%{?dist}
Summary: Natural language to shell command converter

License: MIT OR Apache-2.0
URL: https://github.com/your-org/caro
Source0: %{name}-%{version}.tar.gz

BuildRequires: rust >= 1.70
BuildRequires: cargo

%description
Caro converts natural language descriptions into safe,
platform-aware shell commands using AI.

%prep
%setup -q

%build
cargo build --release

%install
mkdir -p %{buildroot}%{_bindir}
install -m 755 target/release/caro %{buildroot}%{_bindir}/caro

%files
%{_bindir}/caro
%license LICENSE
%doc README.md

%changelog
* Wed Jan 08 2026 Caro Team <team@caro-project.org> - 1.1.0-beta-1
- Initial beta release
```

**Install .rpm**:
```bash
# Install
sudo rpm -i caro-1.1.0_beta-1.x86_64.rpm

# Verify
caro --version

# Uninstall
sudo rpm -e caro
```

---

#### Static Binary (musl)

**For Alpine Linux or Distribution-Independent**:
```bash
# Build static binary with musl
cargo build --release --target x86_64-unknown-linux-musl

# Verify it's static
ldd target/x86_64-unknown-linux-musl/release/caro
# Output: "not a dynamic executable"

# Create tarball
cd target/x86_64-unknown-linux-musl/release
tar -czf caro-linux-musl-x86_64.tar.gz caro
sha256sum caro-linux-musl-x86_64.tar.gz > caro-linux-musl-x86_64.tar.gz.sha256
```

---

### Windows Builds (Planned v1.2.0)

**Build Windows Binary**:
```bash
# Cross-compile from Linux/macOS
cargo build --release --target x86_64-pc-windows-msvc

# Or build on Windows
cargo build --release
```

**Create MSI Installer** (using WiX Toolset):
```xml
<!-- caro.wxs -->
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="Caro" Language="1033" Version="1.1.0"
           Manufacturer="Caro Team" UpgradeCode="PUT-GUID-HERE">

    <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />

    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="Caro" />
      </Directory>
    </Directory>

    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="CaroBinary" Guid="PUT-GUID-HERE">
        <File Id="CaroExe" Source="target\release\caro.exe" KeyPath="yes" />
        <Environment Id="PATH" Name="PATH" Value="[INSTALLFOLDER]"
                     Permanent="no" Part="last" Action="set" System="yes" />
      </Component>
    </ComponentGroup>

    <Feature Id="ProductFeature" Title="Caro" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
    </Feature>
  </Product>
</Wix>
```

**Build MSI**:
```bash
# Install WiX Toolset
# https://wixtoolset.org/

# Build MSI
candle caro.wxs
light -ext WixUIExtension caro.wixobj -o caro-1.1.0-beta-x86_64.msi
```

---

## Binary Packaging

### Tarball Creation

**Standard Tarball Structure**:
```
caro-1.1.0-beta-macos-arm64.tar.gz
‚îî‚îÄ‚îÄ caro-1.1.0-beta/
    ‚îú‚îÄ‚îÄ caro              # Binary
    ‚îú‚îÄ‚îÄ README.md         # Documentation
    ‚îú‚îÄ‚îÄ LICENSE-MIT       # MIT license
    ‚îú‚îÄ‚îÄ LICENSE-APACHE    # Apache license
    ‚îî‚îÄ‚îÄ CHANGELOG.md      # Change history
```

**Create Tarball**:
```bash
#!/bin/bash
# scripts/create_tarball.sh

VERSION="1.1.0-beta"
PLATFORM="$1"  # e.g., "macos-arm64"
BINARY_PATH="$2"

RELEASE_DIR="caro-${VERSION}"
TARBALL="${RELEASE_DIR}-${PLATFORM}.tar.gz"

echo "üì¶ Creating tarball: ${TARBALL}"

# 1. Create release directory
mkdir -p "${RELEASE_DIR}"

# 2. Copy binary
cp "${BINARY_PATH}" "${RELEASE_DIR}/caro"
strip "${RELEASE_DIR}/caro" 2>/dev/null || true

# 3. Copy documentation
cp README.md "${RELEASE_DIR}/"
cp LICENSE-MIT "${RELEASE_DIR}/"
cp LICENSE-APACHE "${RELEASE_DIR}/"
cp CHANGELOG.md "${RELEASE_DIR}/"

# 4. Create tarball
tar -czf "${TARBALL}" "${RELEASE_DIR}"

# 5. Create checksum
shasum -a 256 "${TARBALL}" > "${TARBALL}.sha256"

# 6. Clean up
rm -rf "${RELEASE_DIR}"

echo "‚úÖ Tarball created: ${TARBALL}"
echo "   Checksum: $(cat ${TARBALL}.sha256)"
```

---

### Checksums & Signatures

**SHA-256 Checksums**:
```bash
# Generate checksums for all artifacts
for file in caro-*.tar.gz caro-*.deb caro-*.rpm; do
  if [ -f "$file" ]; then
    shasum -a 256 "$file" > "$file.sha256"
  fi
done

# Create combined checksums file
cat *.sha256 > SHA256SUMS
```

**GPG Signatures** (Optional but Recommended):
```bash
# Generate GPG key (one-time)
gpg --full-generate-key

# Sign artifacts
for file in caro-*.tar.gz caro-*.deb caro-*.rpm; do
  if [ -f "$file" ]; then
    gpg --detach-sign --armor "$file"
  fi
done

# Verify signature
gpg --verify caro-1.1.0-beta-macos-arm64.tar.gz.asc \
             caro-1.1.0-beta-macos-arm64.tar.gz
```

---

## Distribution Channels

### GitHub Releases

**Primary Distribution Channel** - All platforms.

**Release Process**:
1. Tag release: `git tag -a v1.1.0-beta -m "Beta release v1.1.0"`
2. Push tag: `git push origin v1.1.0-beta`
3. Create GitHub Release (automated via CI/CD)
4. Upload artifacts:
   - Tarballs (all platforms)
   - .deb packages (Linux)
   - .rpm packages (Linux)
   - Checksums (SHA256SUMS)
   - Signatures (*.asc)

**GitHub Release Template**:
```markdown
## Caro v1.1.0-beta

### üéâ What's New

- Privacy-first telemetry with zero PII collection
- Enhanced command safety validation (100+ dangerous patterns)
- Static matcher at 86.2% pass rate (target: 75%)
- Fire-and-forget telemetry (0.002ms overhead)

### üì¶ Installation

**macOS** (Homebrew):
\`\`\`bash
brew install caro
\`\`\`

**macOS/Linux** (Install Script):
\`\`\`bash
curl -fsSL https://install.caro-project.org | sh
\`\`\`

**Linux** (.deb):
\`\`\`bash
wget https://github.com/your-org/caro/releases/download/v1.1.0-beta/caro_1.1.0-beta_amd64.deb
sudo dpkg -i caro_1.1.0-beta_amd64.deb
\`\`\`

### üìù Full Changelog

See [CHANGELOG.md](CHANGELOG.md) for details.

### üîê Verification

Verify checksums:
\`\`\`bash
shasum -a 256 -c SHA256SUMS
\`\`\`

### üêõ Known Issues

- Windows support planned for v1.2.0
- ARM64 Linux support experimental

---

**Full Release Notes**: [v1.1.0-beta-release-notes.md](.claude/releases/v1.1.0-beta-release-notes.md)
```

---

### crates.io

**Publish to crates.io** - Source distribution for Rust developers.

**Pre-Publish Checklist**:
```bash
# 1. Verify Cargo.toml
cargo publish --dry-run

# 2. Check package contents
cargo package --list

# 3. Test local install
cargo install --path .

# 4. Publish
cargo publish
```

**Cargo.toml Metadata**:
```toml
[package]
name = "caro"
version = "1.1.0-beta"
edition = "2021"
authors = ["Caro Team <team@caro-project.org>"]
license = "MIT OR Apache-2.0"
description = "Natural language to shell command converter"
homepage = "https://caro-project.org"
repository = "https://github.com/your-org/caro"
readme = "README.md"
keywords = ["cli", "shell", "command", "ai", "nlp"]
categories = ["command-line-utilities"]

[badges]
maintenance = { status = "actively-developed" }
```

---

### Homebrew (macOS)

**Homebrew Formula** - macOS package manager.

**Create Formula** (`homebrew-caro/Formula/caro.rb`):
```ruby
class Caro < Formula
  desc "Natural language to shell command converter"
  homepage "https://caro-project.org"
  url "https://github.com/your-org/caro/archive/refs/tags/v1.1.0-beta.tar.gz"
  sha256 "CHECKSUM_HERE"
  license "MIT OR Apache-2.0"
  version "1.1.0-beta"

  depends_on "rust" => :build

  def install
    system "cargo", "build", "--release"
    bin.install "target/release/caro"
  end

  test do
    assert_match "caro 1.1.0-beta", shell_output("#{bin}/caro --version")
  end
end
```

**Publish to Homebrew**:
```bash
# 1. Fork homebrew-core (for popular packages)
# Or create your own tap for beta releases

# 2. Create tap repository
git clone https://github.com/your-org/homebrew-caro
cd homebrew-caro

# 3. Create Formula directory
mkdir -p Formula

# 4. Add formula
cp caro.rb Formula/

# 5. Commit and push
git add Formula/caro.rb
git commit -m "Add caro v1.1.0-beta formula"
git push origin main

# 6. Users can install from your tap
brew tap your-org/caro
brew install caro
```

---

### Install Script (install.sh)

**Curl-based Installation** - Quick, universal installer.

**Script** (`scripts/install.sh`):
```bash
#!/bin/bash
# Caro Installation Script
# Usage: curl -fsSL https://install.caro-project.org | sh

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
REPO="your-org/caro"
VERSION="${CARO_VERSION:-latest}"
INSTALL_DIR="${CARO_INSTALL_DIR:-$HOME/.local/bin}"

echo "üöÄ Installing Caro..."

# 1. Detect platform
detect_platform() {
  local os=$(uname -s | tr '[:upper:]' '[:lower:]')
  local arch=$(uname -m)

  case "$os" in
    darwin*)
      OS="macos"
      ;;
    linux*)
      OS="linux"
      ;;
    *)
      echo -e "${RED}‚ùå Unsupported OS: $os${NC}"
      exit 1
      ;;
  esac

  case "$arch" in
    x86_64|amd64)
      ARCH="x86_64"
      ;;
    aarch64|arm64)
      ARCH="arm64"
      ;;
    *)
      echo -e "${RED}‚ùå Unsupported architecture: $arch${NC}"
      exit 1
      ;;
  esac

  PLATFORM="${OS}-${ARCH}"
  echo "‚úÖ Detected platform: $PLATFORM"
}

# 2. Download binary
download_binary() {
  if [ "$VERSION" = "latest" ]; then
    # Get latest release version
    VERSION=$(curl -sL https://api.github.com/repos/$REPO/releases/latest | \
              grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
  fi

  DOWNLOAD_URL="https://github.com/$REPO/releases/download/v${VERSION}/caro-${VERSION}-${PLATFORM}.tar.gz"
  CHECKSUM_URL="${DOWNLOAD_URL}.sha256"

  echo "üì• Downloading Caro v${VERSION}..."

  TMP_DIR=$(mktemp -d)
  cd "$TMP_DIR"

  # Download tarball
  if command -v curl >/dev/null 2>&1; then
    curl -fsSL "$DOWNLOAD_URL" -o caro.tar.gz
    curl -fsSL "$CHECKSUM_URL" -o caro.tar.gz.sha256
  elif command -v wget >/dev/null 2>&1; then
    wget -q "$DOWNLOAD_URL" -O caro.tar.gz
    wget -q "$CHECKSUM_URL" -O caro.tar.gz.sha256
  else
    echo -e "${RED}‚ùå Neither curl nor wget found${NC}"
    exit 1
  fi
}

# 3. Verify checksum
verify_checksum() {
  echo "üîê Verifying checksum..."

  if command -v sha256sum >/dev/null 2>&1; then
    sha256sum -c caro.tar.gz.sha256
  elif command -v shasum >/dev/null 2>&1; then
    shasum -a 256 -c caro.tar.gz.sha256
  else
    echo -e "${YELLOW}‚ö†Ô∏è  Cannot verify checksum (sha256sum/shasum not found)${NC}"
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      exit 1
    fi
  fi
}

# 4. Extract and install
install_binary() {
  echo "üì¶ Extracting..."
  tar -xzf caro.tar.gz

  echo "üìÇ Installing to $INSTALL_DIR..."
  mkdir -p "$INSTALL_DIR"

  # Find the caro binary (it's in caro-VERSION directory)
  CARO_BINARY=$(find . -name "caro" -type f -executable | head -n 1)

  if [ -z "$CARO_BINARY" ]; then
    echo -e "${RED}‚ùå Binary not found in archive${NC}"
    exit 1
  fi

  cp "$CARO_BINARY" "$INSTALL_DIR/caro"
  chmod +x "$INSTALL_DIR/caro"

  # Clean up
  cd - > /dev/null
  rm -rf "$TMP_DIR"
}

# 5. Update PATH
update_path() {
  # Check if install dir is in PATH
  if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  $INSTALL_DIR is not in your PATH${NC}"
    echo ""
    echo "Add it to your shell profile:"
    echo ""
    echo "  export PATH=\"\$PATH:$INSTALL_DIR\""
    echo ""

    # Offer to add to shell profile
    read -p "Add to shell profile automatically? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      # Detect shell
      if [ -n "$BASH_VERSION" ]; then
        PROFILE="$HOME/.bashrc"
      elif [ -n "$ZSH_VERSION" ]; then
        PROFILE="$HOME/.zshrc"
      else
        PROFILE="$HOME/.profile"
      fi

      echo "export PATH=\"\$PATH:$INSTALL_DIR\"" >> "$PROFILE"
      echo "‚úÖ Added to $PROFILE"
      echo "Run: source $PROFILE"
    fi
  fi
}

# 6. Verify installation
verify_installation() {
  if command -v caro >/dev/null 2>&1; then
    echo ""
    echo -e "${GREEN}‚úÖ Caro installed successfully!${NC}"
    echo ""
    caro --version
    echo ""
    echo "Try it out:"
    echo "  caro \"list files modified today\""
  else
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Installation complete, but 'caro' not found in PATH${NC}"
    echo "You may need to restart your shell or run:"
    echo "  export PATH=\"\$PATH:$INSTALL_DIR\""
  fi
}

# Main installation flow
main() {
  detect_platform
  download_binary
  verify_checksum
  install_binary
  update_path
  verify_installation
}

main
```

**Host Script**:
```bash
# Upload to GitHub Pages or similar
# https://install.caro-project.org -> scripts/install.sh
```

---

## Installation Methods

### Quick Install (Recommended)

**macOS**:
```bash
# Homebrew (recommended)
brew install caro

# Or install script
curl -fsSL https://install.caro-project.org | sh
```

**Linux**:
```bash
# Install script (recommended)
curl -fsSL https://install.caro-project.org | sh

# Or .deb (Debian/Ubuntu)
wget https://github.com/your-org/caro/releases/download/v1.1.0-beta/caro_1.1.0-beta_amd64.deb
sudo dpkg -i caro_1.1.0-beta_amd64.deb

# Or .rpm (Fedora/RHEL)
wget https://github.com/your-org/caro/releases/download/v1.1.0-beta/caro-1.1.0_beta-1.x86_64.rpm
sudo rpm -i caro-1.1.0_beta-1.x86_64.rpm
```

---

### Manual Install

**Download and Extract**:
```bash
# 1. Download tarball
VERSION="1.1.0-beta"
PLATFORM="macos-arm64"  # or macos-x86_64, linux-x86_64, linux-arm64
wget https://github.com/your-org/caro/releases/download/v${VERSION}/caro-${VERSION}-${PLATFORM}.tar.gz

# 2. Verify checksum
wget https://github.com/your-org/caro/releases/download/v${VERSION}/caro-${VERSION}-${PLATFORM}.tar.gz.sha256
shasum -a 256 -c caro-${VERSION}-${PLATFORM}.tar.gz.sha256

# 3. Extract
tar -xzf caro-${VERSION}-${PLATFORM}.tar.gz
cd caro-${VERSION}

# 4. Copy to PATH
sudo cp caro /usr/local/bin/
sudo chmod +x /usr/local/bin/caro

# 5. Verify
caro --version
```

---

### Build from Source

**Prerequisites**:
- Rust 1.70+ (install via https://rustup.rs)
- Git

**Steps**:
```bash
# 1. Clone repository
git clone https://github.com/your-org/caro.git
cd caro

# 2. Checkout release tag
git checkout v1.1.0-beta

# 3. Build release binary
cargo build --release

# 4. Install
sudo cp target/release/caro /usr/local/bin/
sudo chmod +x /usr/local/bin/caro

# 5. Verify
caro --version
```

---

## Update Mechanisms

### Version Checking

**Check for Updates**:
```bash
# User runs
caro --check-update

# Output:
# üîç Current version: 1.1.0-beta
# üåê Checking for updates...
# ‚ú® New version available: 1.1.1
# üì¶ Download: https://github.com/your-org/caro/releases/tag/v1.1.1
#
# Update with:
#   brew upgrade caro                          (macOS Homebrew)
#   curl -fsSL https://install.caro-project.org | sh  (install script)
#   sudo dpkg -i caro_1.1.1_amd64.deb         (Debian/Ubuntu)
```

**Implementation** (`src/cli/update.rs`):
```rust
use reqwest::blocking::Client;
use serde::Deserialize;

const CURRENT_VERSION: &str = env!("CARGO_PKG_VERSION");
const RELEASES_URL: &str = "https://api.github.com/repos/your-org/caro/releases/latest";

#[derive(Deserialize)]
struct Release {
    tag_name: String,
    html_url: String,
}

pub fn check_for_updates() -> Result<()> {
    println!("üîç Current version: {}", CURRENT_VERSION);
    println!("üåê Checking for updates...");

    let client = Client::builder()
        .user_agent("caro/1.1.0-beta")
        .timeout(Duration::from_secs(5))
        .build()?;

    let response = client
        .get(RELEASES_URL)
        .send()?
        .json::<Release>()?;

    let latest_version = response.tag_name.trim_start_matches('v');

    if latest_version > CURRENT_VERSION {
        println!("‚ú® New version available: {}", latest_version);
        println!("üì¶ Download: {}", response.html_url);
        println!();
        print_update_instructions();
    } else {
        println!("‚úÖ You're on the latest version");
    }

    Ok(())
}

fn print_update_instructions() {
    println!("Update with:");

    #[cfg(target_os = "macos")]
    println!("  brew upgrade caro");

    #[cfg(target_os = "linux")]
    {
        println!("  curl -fsSL https://install.caro-project.org | sh");

        // Detect package manager
        if std::path::Path::new("/usr/bin/dpkg").exists() {
            println!("  sudo dpkg -i caro_VERSION_amd64.deb");
        }
        if std::path::Path::new("/usr/bin/rpm").exists() {
            println!("  sudo rpm -U caro-VERSION.x86_64.rpm");
        }
    }
}
```

---

### Auto-Update (Future Feature)

**Planned for v1.2.0** - Optional automatic updates.

```bash
# Enable auto-updates
caro config set auto-update true

# Configure update channel
caro config set update-channel stable  # or beta

# Check update frequency
caro config set update-check-interval daily  # or weekly
```

---

## Release Artifacts

### Artifact Naming Convention

```
caro-{VERSION}-{PLATFORM}.{EXTENSION}

Examples:
- caro-1.1.0-beta-macos-arm64.tar.gz
- caro-1.1.0-beta-macos-x86_64.tar.gz
- caro-1.1.0-beta-linux-x86_64.tar.gz
- caro-1.1.0-beta-linux-arm64.tar.gz
- caro_1.1.0-beta_amd64.deb
- caro-1.1.0_beta-1.x86_64.rpm
```

---

### Complete Artifact List (v1.1.0-beta)

```
# Tarballs
caro-1.1.0-beta-macos-arm64.tar.gz
caro-1.1.0-beta-macos-arm64.tar.gz.sha256
caro-1.1.0-beta-macos-x86_64.tar.gz
caro-1.1.0-beta-macos-x86_64.tar.gz.sha256
caro-1.1.0-beta-macos-universal.tar.gz
caro-1.1.0-beta-macos-universal.tar.gz.sha256
caro-1.1.0-beta-linux-x86_64.tar.gz
caro-1.1.0-beta-linux-x86_64.tar.gz.sha256
caro-1.1.0-beta-linux-arm64.tar.gz
caro-1.1.0-beta-linux-arm64.tar.gz.sha256
caro-1.1.0-beta-linux-musl-x86_64.tar.gz
caro-1.1.0-beta-linux-musl-x86_64.tar.gz.sha256

# Debian packages
caro_1.1.0-beta_amd64.deb
caro_1.1.0-beta_amd64.deb.sha256
caro_1.1.0-beta_arm64.deb
caro_1.1.0-beta_arm64.deb.sha256

# RPM packages
caro-1.1.0_beta-1.x86_64.rpm
caro-1.1.0_beta-1.x86_64.rpm.sha256
caro-1.1.0_beta-1.aarch64.rpm
caro-1.1.0_beta-1.aarch64.rpm.sha256

# Checksums
SHA256SUMS

# Source
caro-1.1.0-beta.tar.gz (source tarball)
```

---

## CI/CD Pipeline

### GitHub Actions Workflow

**Release Build Workflow** (`.github/workflows/release.yml`):
```yaml
name: Release Build

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        target:
          - aarch64-apple-darwin
          - x86_64-apple-darwin

    steps:
    - uses: actions/checkout@v3

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        override: true

    - name: Build
      run: cargo build --release --target ${{ matrix.target }}

    - name: Create tarball
      run: |
        cd target/${{ matrix.target }}/release
        PLATFORM=$(echo "${{ matrix.target }}" | sed 's/-apple-darwin//')
        tar -czf caro-${{ github.ref_name }}-macos-${PLATFORM}.tar.gz caro
        shasum -a 256 caro-${{ github.ref_name }}-macos-${PLATFORM}.tar.gz > \
          caro-${{ github.ref_name }}-macos-${PLATFORM}.tar.gz.sha256

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: macos-${{ matrix.target }}
        path: target/${{ matrix.target }}/release/caro-*.tar.gz*

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          - x86_64-unknown-linux-musl

    steps:
    - uses: actions/checkout@v3

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        override: true

    - name: Install cross
      run: cargo install cross

    - name: Build
      run: cross build --release --target ${{ matrix.target }}

    - name: Create tarball
      run: |
        cd target/${{ matrix.target }}/release
        PLATFORM=$(echo "${{ matrix.target }}" | sed 's/-unknown-linux-gnu//' | sed 's/-unknown-linux-musl/-musl/')
        tar -czf caro-${{ github.ref_name }}-linux-${PLATFORM}.tar.gz caro
        sha256sum caro-${{ github.ref_name }}-linux-${PLATFORM}.tar.gz > \
          caro-${{ github.ref_name }}-linux-${PLATFORM}.tar.gz.sha256

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: linux-${{ matrix.target }}
        path: target/${{ matrix.target }}/release/caro-*.tar.gz*

  build-packages:
    name: Build Packages
    needs: [build-linux]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Download Linux artifacts
      uses: actions/download-artifact@v3

    - name: Build .deb package
      run: |
        ./scripts/build_deb.sh x86_64
        ./scripts/build_deb.sh arm64

    - name: Build .rpm package
      run: |
        ./scripts/build_rpm.sh x86_64
        ./scripts/build_rpm.sh aarch64

    - name: Upload packages
      uses: actions/upload-artifact@v3
      with:
        name: packages
        path: |
          *.deb
          *.deb.sha256
          *.rpm
          *.rpm.sha256

  release:
    name: Create Release
    needs: [build-macos, build-linux, build-packages]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Create SHA256SUMS
      run: |
        find . -name "*.sha256" -exec cat {} \; > SHA256SUMS

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          **/*.tar.gz
          **/*.deb
          **/*.rpm
          SHA256SUMS
        body_path: .github/RELEASE_TEMPLATE.md
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crates-io:
    name: Publish to crates.io
    needs: [build-macos, build-linux]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Publish to crates.io
      run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}
```

---

## Distribution Checklist

### Pre-Release Checklist

```markdown
## Distribution Checklist (v1.1.0-beta)

### Build & Package
- [ ] All platforms built successfully (macOS ARM64, x86_64, Linux x86_64, ARM64)
- [ ] Universal macOS binary created
- [ ] Static musl binary created
- [ ] .deb packages built (x86_64, ARM64)
- [ ] .rpm packages built (x86_64, ARM64)
- [ ] All binaries stripped

### Verification
- [ ] All artifacts have SHA-256 checksums
- [ ] Checksums verified locally
- [ ] Binaries tested on target platforms
- [ ] Install scripts tested
- [ ] Package managers tested (.deb, .rpm, Homebrew)

### Distribution
- [ ] GitHub Release created
- [ ] All artifacts uploaded to GitHub
- [ ] Published to crates.io
- [ ] Homebrew formula updated
- [ ] Install script deployed to install.caro-project.org
- [ ] Release notes published

### Documentation
- [ ] Installation instructions updated
- [ ] Platform compatibility documented
- [ ] Known issues documented
- [ ] Migration guide (if breaking changes)

### Communication
- [ ] Release announcement posted
- [ ] Social media updates
- [ ] Email to beta testers
- [ ] Update website

### Post-Release
- [ ] Monitor for installation issues
- [ ] Respond to GitHub issues within 24 hours
- [ ] Track download metrics
- [ ] Gather user feedback
```

---

## Troubleshooting

### Common Build Issues

#### Issue: "linker `cc` not found"
**Platform**: Linux
**Solution**:
```bash
# Ubuntu/Debian
sudo apt install build-essential

# Fedora/RHEL
sudo dnf groupinstall "Development Tools"
```

---

#### Issue: "error: linking with `cc` failed"
**Platform**: macOS
**Solution**:
```bash
# Install Xcode Command Line Tools
xcode-select --install
```

---

#### Issue: "Cannot find OpenSSL"
**Platform**: All
**Solution**:
```bash
# macOS
brew install openssl
export OPENSSL_DIR=/opt/homebrew/opt/openssl

# Linux
sudo apt install libssl-dev  # Debian/Ubuntu
sudo dnf install openssl-devel  # Fedora/RHEL
```

---

### Common Installation Issues

#### Issue: "caro: command not found"
**Solution**:
```bash
# Check if binary exists
ls -la ~/.local/bin/caro

# Add to PATH
export PATH="$PATH:$HOME/.local/bin"

# Make permanent (bash)
echo 'export PATH="$PATH:$HOME/.local/bin"' >> ~/.bashrc
source ~/.bashrc

# Make permanent (zsh)
echo 'export PATH="$PATH:$HOME/.local/bin"' >> ~/.zshrc
source ~/.zshrc
```

---

#### Issue: "Permission denied"
**Solution**:
```bash
# Make binary executable
chmod +x ~/.local/bin/caro

# Or if installed to /usr/local/bin
sudo chmod +x /usr/local/bin/caro
```

---

#### Issue: "dyld: Library not loaded" (macOS)
**Solution**:
```bash
# Check binary dependencies
otool -L /usr/local/bin/caro

# If missing system libraries, reinstall Xcode Command Line Tools
xcode-select --install
```

---

## Appendices

### Appendix A: Platform Support Matrix

| Platform | Architecture | Tier | Install Methods | Notes |
|----------|-------------|------|-----------------|-------|
| **macOS 11+** | ARM64 (M1/M2) | Tier 1 | Homebrew, install.sh, manual | Primary development platform |
| **macOS 11+** | x86_64 (Intel) | Tier 1 | Homebrew, install.sh, manual | Full support |
| **Ubuntu 20.04+** | x86_64 | Tier 1 | .deb, install.sh, manual | Full support |
| **Ubuntu 20.04+** | ARM64 | Tier 2 | .deb, install.sh | Experimental |
| **Debian 10+** | x86_64 | Tier 1 | .deb, install.sh | Full support |
| **Fedora 35+** | x86_64 | Tier 1 | .rpm, install.sh | Full support |
| **RHEL/CentOS 8+** | x86_64 | Tier 1 | .rpm, install.sh | Full support |
| **Alpine Linux** | x86_64 | Tier 2 | Static binary | musl libc |
| **Windows 10+** | x86_64 | Planned | MSI installer | v1.2.0 |

**Tier Definitions**:
- **Tier 1**: Primary support, tested on every release
- **Tier 2**: Best effort, tested periodically
- **Planned**: Not yet supported

---

### Appendix B: Build Script Reference

```bash
# Complete build script for all platforms
./scripts/build_all.sh

# Individual platform builds
./scripts/build_macos_universal.sh
./scripts/build_linux_x86_64.sh
./scripts/build_linux_arm64.sh
./scripts/build_musl.sh

# Package builds
./scripts/build_deb.sh x86_64
./scripts/build_rpm.sh x86_64

# Create tarballs
./scripts/create_tarball.sh macos-arm64 target/aarch64-apple-darwin/release/caro
./scripts/create_tarball.sh linux-x86_64 target/x86_64-unknown-linux-gnu/release/caro

# Generate checksums
./scripts/generate_checksums.sh
```

---

### Appendix C: Distribution URLs

```
# GitHub Releases
https://github.com/your-org/caro/releases

# Install Script
https://install.caro-project.org

# Homebrew
brew install your-org/caro/caro

# crates.io
https://crates.io/crates/caro

# Documentation
https://docs.caro-project.org

# Website
https://caro-project.org
```

---

### Appendix D: Versioning & Tagging

```bash
# Version bump (use semantic-release or manually)
# Edit Cargo.toml: version = "1.1.1"
# Edit src/version.rs: const VERSION: &str = "1.1.1"

# Update CHANGELOG.md
vim CHANGELOG.md

# Commit changes
git add Cargo.toml src/version.rs CHANGELOG.md
git commit -m "chore: Bump version to 1.1.1"

# Create tag
git tag -a v1.1.1 -m "Release v1.1.1"

# Push tag (triggers CI/CD)
git push origin v1.1.1

# Push main branch
git push origin main
```

---

## Summary

### Key Deployment Principles

1. ‚úÖ **Multi-Platform**: Support macOS, Linux, Windows (future)
2. ‚úÖ **Reproducible Builds**: Consistent artifacts across environments
3. ‚úÖ **Secure Distribution**: Checksums, signatures, HTTPS-only
4. ‚úÖ **Easy Installation**: Multiple methods (Homebrew, apt, yum, curl)
5. ‚úÖ **Automated CI/CD**: GitHub Actions builds and publishes releases

### Distribution Channels

| Channel | Users Reached | Update Latency |
|---------|---------------|----------------|
| **GitHub Releases** | All platforms | Immediate |
| **crates.io** | Rust developers | Immediate |
| **Homebrew** | macOS | < 24 hours |
| **install.sh** | Quick installers | Immediate |
| **.deb/.rpm** | Linux distros | < 48 hours |

### Next Steps

1. **v1.1.0-beta Release** (Jan 24): Execute full deployment pipeline
2. **Monitor Adoption**: Track downloads, installation success rates
3. **Gather Feedback**: Installation issues, platform requests
4. **Windows Support** (v1.2.0): Add MSI installer, Chocolatey package

---

**Document Status**: ‚úÖ READY FOR v1.1.0-beta
**Last Updated**: 2026-01-08
**Next Review**: After beta release (2026-01-24)

---

## Related Documents

- [Hotfix Protocol](v1.1.0-hotfix-protocol.md)
- [Version Management Guide](v1.1.0-version-management-guide.md)
- [Release Timeline](v1.1.0-release-timeline.md)
- [Beta Testing Handbook](v1.1.0-beta-handbook.md)
