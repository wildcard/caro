# v1.1.0 Progressive Rollout Strategy

**Version**: 1.0
**Last Updated**: 2026-01-08
**Owner**: Release Manager + Engineering Lead
**Status**: Ready for Implementation

---

## Executive Summary

This document defines the progressive rollout strategy for v1.1.0-beta, enabling controlled, low-risk deployment with rapid rollback capabilities and gradual user exposure.

**Strategy**: Staged rollout over 7 days with kill switches and feature flags

**Benefits**:
- Limit blast radius of potential issues
- Gather real-world data before full rollout
- Enable rapid rollback without re-deployment
- A/B test controversial features
- Gradual load scaling for infrastructure

**Related Documents**:
- `v1.1.0-launch-day-final-checklist.md` - Launch procedures
- `v1.1.0-release-rollback-recovery-procedures.md` - Rollback playbook
- `v1.1.0-post-launch-monitoring-guide.md` - Metrics tracking

---

## Rollout Phases

### Phase 0: Internal Testing (T-7 to T-1 days)

**Population**: Development team only (5-10 users)

**Purpose**: Final smoke testing in production-like environment

**Duration**: 7 days (January 8-14, 2026)

**Success Criteria**:
- No P0 bugs discovered
- All critical paths work correctly
- Performance within targets
- Team sign-off for launch

**Actions**:
- Team dogfooding (use caro daily)
- Report any issues immediately
- Test edge cases and error paths
- Verify telemetry collection

---

### Phase 1: Canary Release (T+0 to T+24h)

**Population**: 5% of downloads (early adopters)

**Purpose**: Detect critical issues with minimal user impact

**Duration**: 24 hours (January 15, 09:00 UTC - January 16, 09:00 UTC)

**Implementation**:
```bash
# install.sh checks rollout percentage
ROLLOUT_PCT=$(curl -s https://api.caro.sh/rollout/v1.1.0-beta)

if [ "$RANDOM" -le "$((ROLLOUT_PCT * 327))" ]; then
  # Install v1.1.0-beta
  install_version "1.1.0-beta"
else
  # Install v1.0.4 (stable)
  install_version "1.0.4"
fi
```

**Success Criteria**:
- Installation success rate ‚â• 90%
- Command success rate ‚â• 86%
- No P0 bugs reported
- Error rate < 5%
- Latency within targets

**Go/No-Go Decision** (T+24h):
- ‚úÖ **GO**: If all criteria met ‚Üí Phase 2
- ‚ùå **NO-GO**: If any P0 bug ‚Üí Rollback to 0%

**Monitoring**:
- Check metrics every 2 hours
- Respond to issues within 1 hour
- On-call engineer available 24/7

---

### Phase 2: Small Beta (T+24h to T+72h)

**Population**: 25% of downloads

**Purpose**: Validate at moderate scale, diverse user scenarios

**Duration**: 48 hours (January 16-18, 2026)

**Rollout Increase**: 5% ‚Üí 25% (5x growth)

**Success Criteria**:
- All Phase 1 criteria maintained
- User feedback generally positive (>70%)
- No new P0 bugs discovered
- Platform diversity: macOS, Linux, Windows all represented

**Go/No-Go Decision** (T+72h):
- ‚úÖ **GO**: If criteria met ‚Üí Phase 3
- ‚ö†Ô∏è **HOLD**: If minor issues ‚Üí Fix, re-verify, then proceed
- ‚ùå **NO-GO**: If P0 bug ‚Üí Rollback

**Monitoring**:
- Daily metrics review
- Triage all bug reports within 4 hours
- Community engagement (Discord, GitHub)

---

### Phase 3: Large Beta (T+72h to T+120h)

**Population**: 50% of downloads

**Purpose**: Validate at scale, prepare for full rollout

**Duration**: 48 hours (January 18-20, 2026)

**Rollout Increase**: 25% ‚Üí 50% (2x growth)

**Success Criteria**:
- AWU approaching target (‚â• 100)
- Success rate stable at ‚â• 86%
- Infrastructure handling load well
- Community sentiment positive

**Go/No-Go Decision** (T+120h):
- ‚úÖ **GO**: If criteria met ‚Üí Phase 4
- ‚ö†Ô∏è **HOLD**: If performance issues ‚Üí Optimize, then proceed
- ‚ùå **NO-GO**: If critical issues ‚Üí Investigate, possibly rollback

**Monitoring**:
- Infrastructure metrics (CPU, memory, API load)
- Performance degradation checks
- User sentiment analysis

---

### Phase 4: Full Rollout (T+120h to T+168h)

**Population**: 100% of downloads

**Purpose**: Complete migration to v1.1.0-beta

**Duration**: 48 hours (January 20-22, 2026)

**Rollout Increase**: 50% ‚Üí 100% (2x growth)

**Implementation**:
```bash
# install.sh always installs latest
install_version "1.1.0-beta"
```

**Success Criteria**:
- AWU ‚â• 150 (target achieved)
- All metrics green
- Team celebration üéâ

**Monitoring**:
- Continue daily metrics review through end of Week 2
- Gradual reduction in monitoring frequency

---

## Feature Flags

### Implementation

**Configuration File**: `~/.config/caro/features.toml` (optional override)

**Default Values** (embedded in binary):
```rust
pub struct FeatureFlags {
    pub validation_retry: bool,          // Cycle 11 feature
    pub confidence_refinement: bool,     // Cycle 12 feature
    pub static_matcher: bool,            // Primary backend
    pub embedded_backend: bool,          // LLM fallback
    pub telemetry_opt_in: bool,          // Privacy-first default
}

impl Default for FeatureFlags {
    fn default() -> Self {
        Self {
            validation_retry: true,
            confidence_refinement: true,
            static_matcher: true,
            embedded_backend: true,
            telemetry_opt_in: false, // Must opt-in
        }
    }
}
```

**Remote Kill Switch** (emergency):
```bash
# Check remote flag status every 1 hour
curl -s https://api.caro.sh/features/v1.1.0-beta

# Response:
{
  "validation_retry": true,
  "confidence_refinement": true,
  "embedded_backend": true  // Can disable remotely if issues
}
```

---

### Feature Flag Use Cases

#### 1. Validation-Triggered Retry (Cycle 11)

**Flag**: `validation_retry`

**Purpose**: Enable/disable automatic command repair

**Scenarios**:
- **Enabled** (default): Self-healing agent loop
- **Disabled** (emergency): If repair causes issues

**Kill Switch Decision**:
- Repair loop causing infinite retries? ‚Üí Disable
- Repair success rate < 30%? ‚Üí Investigate, possibly disable

**Monitoring**:
```sql
SELECT
  COUNT(*) as repairs_attempted,
  SUM(CASE WHEN repair_succeeded THEN 1 ELSE 0 END) as successful,
  AVG(repair_latency_ms) as avg_latency
FROM telemetry_events
WHERE event_type = 'validation_repair'
  AND timestamp >= NOW() - INTERVAL '1 hour'
```

---

#### 2. Confidence-Based Refinement (Cycle 12)

**Flag**: `confidence_refinement`

**Purpose**: Enable/disable low-confidence refinement

**Scenarios**:
- **Enabled** (default): Quality over speed
- **Disabled** (emergency): If refinement causing latency issues

**Kill Switch Decision**:
- Refinement rate > 50%? ‚Üí Investigate, possibly disable
- Latency p95 > 3000ms? ‚Üí Disable to restore speed

**Monitoring**:
```sql
SELECT
  COUNT(*) as refinements,
  AVG(refinement_latency_ms) as avg_latency,
  AVG(quality_improvement_score) as avg_quality_boost
FROM telemetry_events
WHERE event_type = 'confidence_refinement'
  AND refinement_triggered = true
  AND timestamp >= NOW() - INTERVAL '1 hour'
```

---

#### 3. Embedded Backend (LLM Fallback)

**Flag**: `embedded_backend`

**Purpose**: Enable/disable LLM fallback when static matcher fails

**Scenarios**:
- **Enabled** (default): Comprehensive coverage
- **Disabled** (emergency): If LLM causing issues (latency, quality)

**Kill Switch Decision**:
- Embedded backend success rate < 60%? ‚Üí Disable
- Embedded backend p95 latency > 5000ms? ‚Üí Disable
- Model file corruption detected? ‚Üí Disable

**Fallback Behavior** (if disabled):
```rust
if !flags.embedded_backend {
    return Err(GeneratorError::BackendUnavailable {
        reason: "Embedded backend temporarily disabled".to_string()
    });
}
```

---

## Rollback Procedures

### Partial Rollback (Reduce Rollout %)

**Trigger**: Minor issues affecting subset of users

**Action**: Reduce rollout percentage

```bash
# Emergency rollback to 10%
curl -X POST https://api.caro.sh/rollout/v1.1.0-beta \
  -d '{"percentage": 10}'

# Users installing after this point get v1.0.4 (stable)
```

**Scenarios**:
- Phase 2 discovers platform-specific bug ‚Üí Rollback to 10%, fix, redeploy
- Performance issues at 50% scale ‚Üí Rollback to 25%, optimize

---

### Feature Rollback (Kill Switch)

**Trigger**: Specific feature causing issues

**Action**: Disable feature remotely

```bash
# Disable confidence refinement feature
curl -X POST https://api.caro.sh/features/v1.1.0-beta \
  -d '{"confidence_refinement": false}'

# All running instances pick this up within 1 hour
# Or immediately if user restarts caro
```

**Scenarios**:
- Validation retry causing infinite loops ‚Üí Disable validation_retry
- Confidence refinement causing excessive latency ‚Üí Disable confidence_refinement
- Embedded backend quality issues ‚Üí Disable embedded_backend (static-only mode)

---

### Full Rollback (Emergency)

**Trigger**: Critical P0 bug affecting majority of users

**Action**: Rollback to v1.0.4 stable

```bash
# Emergency full rollback
curl -X POST https://api.caro.sh/rollout/v1.1.0-beta \
  -d '{"percentage": 0}'

# Un-publish GitHub release (mark as draft)
# Yank crates.io version
cargo yank --vers 1.1.0-beta
```

**Communication**:
- Immediate announcement on Discord, social media
- GitHub issue explaining what happened
- Transparent post-mortem within 48 hours

**Criteria for Full Rollback**:
- Data loss or corruption
- Security vulnerability
- Installation failure > 80%
- Success rate < 70% (vs 86% baseline)
- Unrecoverable errors affecting > 50% of users

---

## Rollout Decision Matrix

| Phase | Success Rate | Installation | P0 Bugs | Decision |
|-------|--------------|--------------|---------|----------|
| Canary (5%) | ‚â•86% | ‚â•90% | 0 | ‚úÖ Phase 2 |
| Canary (5%) | 80-85% | ‚â•90% | 0 | ‚ö†Ô∏è Investigate |
| Canary (5%) | <80% | <90% | >0 | ‚ùå Rollback |
| Beta (25%) | ‚â•86% | ‚â•90% | 0 | ‚úÖ Phase 3 |
| Beta (25%) | 80-85% | 85-90% | 0 | ‚ö†Ô∏è Hold & fix |
| Beta (50%) | ‚â•86% | ‚â•90% | 0 | ‚úÖ Phase 4 |
| Full (100%) | ‚â•86% | ‚â•90% | 0 | ‚úÖ Success üéâ |

---

## Monitoring During Rollout

### Canary Phase (5%) - Extra Vigilant

**Frequency**: Check every 2 hours

**Metrics**:
- Installation success rate (per platform)
- Command success rate (overall and per backend)
- Error rate and categories
- Latency (p50, p95, p99)
- User feedback (Discord, GitHub)

**Alert Thresholds**: Stricter than normal
- Success rate < 85% (vs 86% target) ‚Üí Immediate investigation
- Any P0 bug ‚Üí Immediate escalation

---

### Beta Phases (25%, 50%) - Vigilant

**Frequency**: Check every 6 hours (4x daily)

**Metrics**:
- All Canary metrics
- Infrastructure load (CPU, memory, API calls)
- User retention (day 1, day 3, day 7)
- Community sentiment

**Alert Thresholds**: Normal
- Success rate < 86% ‚Üí Investigation
- P0 bug ‚Üí Urgent fix

---

### Full Phase (100%) - Normal

**Frequency**: Check daily

**Metrics**:
- AWU progression toward 150 target
- All quality metrics stable
- Community growth
- Feature adoption

---

## Communication Strategy

### Internal Communication

**Slack Channel**: `#v1-1-0-rollout`

**Daily Updates**:
```
v1.1.0-beta Rollout Status - Day N

Phase: [Canary/Small Beta/Large Beta/Full]
Rollout: [X%]

Metrics (24h):
- Installs: [count]
- AWU: [count] ([% of target])
- Success Rate: [%]
- P0 Bugs: [count]

Status: üü¢ On Track / üü° Minor Issues / üî¥ Critical

Next Decision Point: [date/time]
```

---

### External Communication

**Transparency**: Be open about staged rollout

**GitHub Announcement**:
```markdown
## v1.1.0-beta Progressive Rollout

We're rolling out v1.1.0-beta gradually to ensure quality:

Week 1 (Jan 15-22):
- Day 1: 5% of new installs (canary)
- Day 3: 25% (small beta)
- Day 5: 50% (large beta)
- Day 7: 100% (full rollout)

If you want the latest immediately:
`curl https://get.caro.sh/v1.1.0-beta | sh`

If you prefer stability:
`curl https://get.caro.sh/stable | sh` (v1.0.4)

Follow our progress: [metrics dashboard link]
```

**Discord Updates**: Daily status in #announcements

---

## A/B Testing Opportunities

### Test 1: Confidence Threshold

**Question**: What's the optimal confidence threshold?

**Groups**:
- Control (50%): threshold = 0.8 (default)
- Variant (50%): threshold = 0.85 (more aggressive)

**Metrics**:
- Refinement rate
- Success rate improvement
- Latency impact
- User satisfaction

**Duration**: 7 days

**Decision**: Choose winner based on quality/speed trade-off

---

### Test 2: Static Matcher Priority

**Question**: Should we always try static matcher first?

**Groups**:
- Control (50%): static ‚Üí embedded (current)
- Variant (50%): intelligent routing (complexity-based)

**Metrics**:
- Overall latency
- Success rate
- Backend distribution

**Duration**: 7 days

**Decision**: Choose based on performance and quality

---

## Rollout Automation

### Rollout Control API

**Endpoint**: `https://api.caro.sh/rollout/v1.1.0-beta`

**Authentication**: Admin token required

**Operations**:

1. **Get Current Status**:
```bash
curl https://api.caro.sh/rollout/v1.1.0-beta
# Response: {"percentage": 25, "phase": "small_beta"}
```

2. **Update Rollout Percentage**:
```bash
curl -X POST https://api.caro.sh/rollout/v1.1.0-beta \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -d '{"percentage": 50}'
```

3. **Emergency Stop**:
```bash
curl -X POST https://api.caro.sh/rollout/v1.1.0-beta/emergency-stop \
  -H "Authorization: Bearer $ADMIN_TOKEN"
# Sets percentage to 0, disables all features
```

---

### Automated Decision Bot

**Tool**: GitHub Actions + custom script

**Functionality**:
- Checks metrics every hour
- Auto-advances if criteria met
- Alerts team if issues detected
- Suggests rollback if critical issues

**Guardrails**:
- Never auto-rollback (human decision required)
- Never auto-advance past 50% (Phase 4 requires human approval)
- Always alert team before any action

---

## Risk Mitigation

### Risk: Canary Too Small (5%)

**Mitigation**: Extended duration (24h vs 12h)
- More time to gather statistically significant data
- Multiple time zones covered

### Risk: Intermediate Phases Miss Edge Cases

**Mitigation**: Platform diversity requirements
- Ensure macOS, Linux, Windows represented in each phase
- Monitor platform-specific metrics separately

### Risk: Feature Kill Switch Not Honored

**Mitigation**: Multiple checks
- Check on startup
- Check hourly while running
- Fallback to safe defaults if API unreachable

### Risk: Rollback Too Slow

**Mitigation**: Pre-tested rollback procedures
- Rollback dry-run during Phase 0
- One-command rollback script
- Clear decision tree (no debate)

---

## Success Criteria Summary

**Phase 1 (Canary)**: No P0 bugs, metrics ‚â• targets
**Phase 2 (Small Beta)**: Sustained metrics, diverse users
**Phase 3 (Large Beta)**: Scale proven, AWU growing
**Phase 4 (Full)**: AWU target met, all metrics green

**Overall Success** (End of Week 2):
- ‚úÖ 150+ AWU
- ‚úÖ 86%+ success rate
- ‚úÖ 0 P0 bugs
- ‚úÖ 90%+ installation success
- ‚úÖ Positive community sentiment

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-08 | Release Manager | Initial progressive rollout strategy |

---

**End of Document**

üöÄ **Progressive Rollout Ready**

7-day staged rollout with kill switches, feature flags, and automated monitoring for safe, controlled v1.1.0-beta deployment.
