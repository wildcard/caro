# Release API Stability & Backward Compatibility

**Version**: 1.0
**Last Updated**: 2026-01-08
**Owner**: Engineering Lead + Product Lead
**Status**: Active

---

## Document Purpose

This document defines the API stability guarantees, backward compatibility policies, deprecation processes, and version migration strategies for caro. It ensures users can trust that updates won't break their workflows and provides clear guidance for handling breaking changes when necessary.

**Audience**: Engineering Lead, Product Lead, All Developers, Users, Integration Partners

**Related Documents**:
- `v1.1.0-release-version-control-branching-strategy.md` - Semantic versioning
- `v1.1.0-release-technical-architecture.md` - System architecture
- `v1.1.0-release-partner-integration-ecosystem.md` - Integration guidelines
- `v1.1.0-release-roadmap-timeline.md` - Future roadmap

---

## Table of Contents

1. [Stability Philosophy](#stability-philosophy)
2. [Stability Levels](#stability-levels)
3. [Compatibility Guarantees](#compatibility-guarantees)
4. [Breaking Changes Policy](#breaking-changes-policy)
5. [Deprecation Process](#deprecation-process)
6. [Migration Guides](#migration-guides)
7. [Version Support Policy](#version-support-policy)

---

## Stability Philosophy

### Core Principles

**1. Users First**: Stability over new features when in conflict
**2. Explicit Over Implicit**: Clear, documented contracts for all public interfaces
**3. Gradual Evolution**: Deprecate before removing, provide migration paths
**4. Clear Communication**: Announce breaking changes loudly and early
**5. Semantic Versioning**: Version numbers convey compatibility guarantees

### The Stability Spectrum

```
Experimental → Beta → Stable → Mature → Legacy → Deprecated
    ↓            ↓       ↓        ↓        ↓          ↓
 May break    Mostly   Won't    Won't    Rarely    Will be
 any time     stable   break    break    updated   removed
```

### Target Stability (by Version)

| Version | Stability Level | Guarantees |
|---------|-----------------|------------|
| **v0.x.x** | Experimental | No guarantees, anything can change |
| **v1.0.0-beta** | Beta | Core features stable, polish ongoing |
| **v1.0.0** | Stable | Backward compatible within v1.x |
| **v1.x.x** | Stable | No breaking changes, only additions/fixes |
| **v2.0.0** | Major | Breaking changes allowed, migration guide provided |

---

## Stability Levels

### Level 1: Experimental (Unstable)

**Definition**: Features under active development, subject to change without notice

**Examples**:
- Features behind feature flags
- Alpha releases (v1.2.0-alpha)
- Internal APIs marked `// UNSTABLE`
- Plugins/extensions (future)

**Guarantees**: None
- May change or be removed at any time
- No deprecation warnings required
- No migration guides provided

**User Expectations**:
- Use at your own risk
- Don't build critical workflows on experimental features
- Report bugs, but expect instability

**Documentation**:
```rust
/// Experimental command chaining support.
/// 
/// ⚠️ WARNING: This feature is experimental and may change or be removed
/// without notice. Do not rely on it for production workflows.
/// 
/// # Stability: Experimental
pub fn chain_commands(cmds: Vec<String>) -> Result<String> {
    // Implementation
}
```

---

### Level 2: Beta (Mostly Stable)

**Definition**: Features ready for testing, minor changes possible based on feedback

**Examples**:
- v1.1.0-beta release
- New backends in first release
- Major features in initial version

**Guarantees**: Limited
- Core functionality won't change dramatically
- CLI flags may be renamed (with deprecation)
- Output format may change (with version flag)
- Breaking changes possible but communicated in release notes

**User Expectations**:
- Safe for non-critical use
- Provide feedback to shape final API
- Expect minor breaking changes

**Documentation**:
```rust
/// Command history feature (Beta).
/// 
/// This feature is in beta. The API may change slightly based on user
/// feedback, but core functionality is stable.
/// 
/// # Stability: Beta
/// # Since: v1.1.0-beta
pub fn get_history(limit: usize) -> Vec<HistoryEntry> {
    // Implementation
}
```

---

### Level 3: Stable

**Definition**: Production-ready features with backward compatibility guarantees

**Examples**:
- Core command generation
- Static matcher backend
- Safety validation
- Main CLI interface (v1.0+)

**Guarantees**: Strong
- No breaking changes within MAJOR version
- CLI flags won't be removed (only deprecated)
- Output format stable (unless opt-in to new format)
- Bug fixes only (no behavior changes)

**User Expectations**:
- Safe for production use
- Build critical workflows confidently
- Only MAJOR version bumps break compatibility

**Documentation**:
```rust
/// Generate a shell command from natural language query.
/// 
/// This is a stable API. It will not change in backward-incompatible ways
/// within the v1.x release series.
/// 
/// # Stability: Stable
/// # Since: v1.0.0
pub fn generate_command(query: &str) -> Result<CommandResult> {
    // Implementation
}
```

---

### Level 4: Deprecated

**Definition**: Features marked for removal in next MAJOR version

**Examples**:
- Old CLI flags being replaced
- Legacy backends being sunset
- Outdated configuration formats

**Guarantees**: Removal notice
- Will be removed in next MAJOR version
- Deprecation warnings issued
- Migration path provided
- Minimum 1 MAJOR version warning period

**User Expectations**:
- Start migration immediately
- Warnings will appear in output
- Feature will work until next MAJOR version

**Documentation**:
```rust
/// Generate command with legacy format.
/// 
/// # Deprecated
/// This function is deprecated and will be removed in v2.0.0.
/// Use `generate_command_v2()` instead, which provides structured output.
/// 
/// # Migration
/// ```rust
/// // Old (deprecated):
/// let cmd = generate_command_legacy(query)?;
/// 
/// // New (recommended):
/// let result = generate_command_v2(query)?;
/// let cmd = result.command;
/// ```
#[deprecated(since = "1.5.0", note = "Use generate_command_v2 instead")]
pub fn generate_command_legacy(query: &str) -> Result<String> {
    // Implementation
}
```

---

## Compatibility Guarantees

### CLI Interface Compatibility

**Stable (Won't Break)**:
- Primary command: `caro "<query>"`
- Core flags: `--help`, `--version`, `--backend`, `--dry-run`
- Exit codes: 0 (success), 1 (error), 130 (user cancelled)
- Environment variables: `CARO_BACKEND`, `CARO_CONFIG_PATH`

**May Change (With Deprecation)**:
- Flag names (e.g., `--backend` → `--inference-backend`)
- Flag aliases
- Configuration file format (with migration tool)

**May Change (Without Breaking)**:
- Adding new flags (backward compatible)
- Adding new commands (backward compatible)
- Improving error messages
- Adding output colors/formatting

**Example Compatibility Matrix**:

| Version | `caro "query"` | `--backend` flag | JSON output | Config format |
|---------|----------------|------------------|-------------|---------------|
| v1.0.0 | ✅ Supported | ✅ `static\|ollama` | ✅ `{"cmd":"..."}` | ✅ TOML v1 |
| v1.1.0 | ✅ Supported | ✅ `static\|embedded\|ollama` | ✅ `{"cmd":"..."}` | ✅ TOML v1 |
| v1.2.0 | ✅ Supported | ⚠️ Deprecated → `--inference-backend` | ✅ `{"cmd":"..."}` | ⚠️ TOML v2 (v1 still works) |
| v2.0.0 | ✅ Supported | ❌ Removed (use `--inference-backend`) | ⚠️ New format (opt-in to v1) | ❌ TOML v1 removed |

---

### Output Format Compatibility

**JSON Output** (Stable within MAJOR version):

**v1.x.x format** (guaranteed stable):
```json
{
  "cmd": "find . -name '*.rs'",
  "confidence": 0.95,
  "safe": true,
  "explanation": "Lists all Rust files in current directory"
}
```

**Future v2.0.0 format** (example, will be different):
```json
{
  "version": "2.0",
  "command": {
    "text": "find . -name '*.rs'",
    "tokens": ["find", ".", "-name", "*.rs"]
  },
  "metadata": {
    "confidence": 0.95,
    "safe": true,
    "backend": "embedded",
    "latency_ms": 287
  },
  "explanation": "Lists all Rust files in current directory"
}
```

**Compatibility Strategy**:
```bash
# v1.x: Default to v1 format
caro "find rust files" --json

# v2.x: Default to v2 format, but allow v1 via flag
caro "find rust files" --json --format-version=1
```

---

### Library API Compatibility (Future: when caro becomes a library)

**Public API** (Stable):
```rust
// These functions will NOT change signature in v1.x
pub fn generate_command(query: &str) -> Result<CommandResult>
pub fn validate_command(cmd: &str) -> Result<ValidationResult>
pub enum InferenceBackend { Static, Embedded, Ollama }
```

**Internal API** (Unstable):
```rust
// These can change at any time (marked pub(crate))
pub(crate) fn parse_intent(query: &str) -> Intent
pub(crate) fn select_backend(query: &str) -> InferenceBackend
```

**Versioning Strategy**:
- Semver for library API (MAJOR.MINOR.PATCH)
- MAJOR bump for any breaking change
- MINOR bump for new features (backward compatible)
- PATCH bump for bug fixes only

---

## Breaking Changes Policy

### What Constitutes a Breaking Change?

**CLI Breaking Changes**:
- ✅ Breaking: Removing a flag (e.g., removing `--backend`)
- ✅ Breaking: Renaming a flag (e.g., `--backend` → `--inference-backend`)
- ✅ Breaking: Changing flag semantics (e.g., `--json` changes output format)
- ✅ Breaking: Removing a backend (e.g., removing `ollama` backend)
- ✅ Breaking: Changing exit codes
- ❌ Not Breaking: Adding new flag (e.g., adding `--explain`)
- ❌ Not Breaking: Adding new backend option
- ❌ Not Breaking: Improving error messages

**Configuration Breaking Changes**:
- ✅ Breaking: Removing config keys
- ✅ Breaking: Changing config format (TOML → YAML)
- ✅ Breaking: Changing config file location
- ❌ Not Breaking: Adding new optional config keys
- ❌ Not Breaking: Deprecating old keys (if still work)

**Output Breaking Changes**:
- ✅ Breaking: Changing JSON schema (removing/renaming fields)
- ✅ Breaking: Changing default output format
- ❌ Not Breaking: Adding new JSON fields
- ❌ Not Breaking: Changing text output (if `--json` unchanged)

**Behavior Breaking Changes**:
- ✅ Breaking: Changing command generation logic significantly
- ✅ Breaking: Removing safety checks
- ✅ Breaking: Changing validation rules (rejecting previously allowed commands)
- ❌ Not Breaking: Improving accuracy (generating better commands)
- ❌ Not Breaking: Adding more safety checks

---

### When Breaking Changes Are Allowed

**MAJOR Version Bump Only** (v1.x → v2.0):
- All breaking changes require MAJOR version bump
- Exception: Security fixes (can break in PATCH if critical)

**Beta Releases** (v1.1.0-beta):
- Breaking changes allowed based on user feedback
- Communicated clearly in release notes
- Migration guide provided if significant

**Hotfixes** (v1.1.0-hotfix.1):
- Breaking changes allowed ONLY for critical security issues
- Document breakage clearly
- Provide workaround if possible

---

### Breaking Change Communication

**Timeline** (for planned breaking changes):

**6 Months Before**:
- Announce in roadmap
- Discuss in community (Discord, GitHub Discussions)
- Gather feedback on alternatives

**3 Months Before**:
- Add deprecation warnings to affected features
- Publish migration guide draft
- Provide examples and tools

**1 Month Before**:
- Final migration guide published
- Announce exact removal date
- Offer migration support

**On Release**:
- CHANGELOG with breaking changes section
- GitHub release notes (highlighted)
- Blog post explaining changes and migration
- Discord announcement

**Example Announcement**:

```markdown
# Breaking Change Announcement: `--backend` Flag Deprecation

## What's Changing
The `--backend` flag is deprecated in v1.5.0 and will be removed in v2.0.0.

## Why
The new `--inference-backend` flag is more explicit and supports additional
options for model selection.

## Timeline
- v1.5.0 (Jan 2026): Deprecation warning added, both flags work
- v1.8.0 (Apr 2026): Final warning, migration tool provided
- v2.0.0 (Jul 2026): `--backend` removed, only `--inference-backend` works

## Migration
### Before (deprecated):
```bash
caro "query" --backend embedded
```

### After (recommended):
```bash
caro "query" --inference-backend embedded
```

### Automated Migration:
```bash
# Update shell aliases
sed -i 's/--backend/--inference-backend/g' ~/.bashrc

# Or use migration tool
caro migrate-config --from 1.x --to 2.0
```

## Need Help?
- Migration guide: https://docs.caro.sh/migration/v2
- Questions: Discord #support or GitHub Discussions
```

---

## Deprecation Process

### Step 1: Announce Deprecation

**Add Deprecation Attribute** (for Rust APIs):
```rust
#[deprecated(
    since = "1.5.0",
    note = "Use generate_command_v2 instead. See migration guide: https://docs.caro.sh/migration/v2"
)]
pub fn generate_command_legacy(query: &str) -> Result<String> {
    // Implementation
}
```

**Add Runtime Warning** (for CLI flags):
```rust
if args.backend.is_some() {
    eprintln!("⚠️  Warning: --backend flag is deprecated and will be removed in v2.0.0");
    eprintln!("   Use --inference-backend instead");
    eprintln!("   See: https://docs.caro.sh/migration/v2");
}
```

**Update Documentation**:
- Mark as deprecated in `--help` output
- Add deprecation notice to README
- Update API documentation

---

### Step 2: Provide Migration Path

**Create Migration Guide** (in docs):

```markdown
# Migrating from v1.x to v2.0

## Breaking Changes

### 1. `--backend` flag removed

**Before**:
```bash
caro "query" --backend embedded
```

**After**:
```bash
caro "query" --inference-backend embedded
```

**Migration Script**:
```bash
# Update all scripts in current directory
find . -name "*.sh" -exec sed -i 's/--backend/--inference-backend/g' {} +
```

### 2. Config file format changed

**Before** (v1.x TOML):
```toml
[backend]
default = "embedded"
```

**After** (v2.0 TOML):
```toml
[inference]
backend = "embedded"
model = "auto"
```

**Migration Tool**:
```bash
caro migrate-config --from ~/.config/caro/config.toml --to ~/.config/caro/config-v2.toml
```
```

**Provide Migration Tool** (if complex):
```rust
// caro migrate-config command
pub fn migrate_config_v1_to_v2(old_path: &Path, new_path: &Path) -> Result<()> {
    let old_config: ConfigV1 = parse_config(old_path)?;
    let new_config: ConfigV2 = old_config.into(); // Convert
    write_config(new_path, &new_config)?;
    println!("✅ Config migrated from v1 to v2");
    println!("   Old: {}", old_path.display());
    println!("   New: {}", new_path.display());
    Ok(())
}
```

---

### Step 3: Removal (in MAJOR Version)

**Remove Deprecated Code**:
```rust
// In v2.0.0, this code is completely removed:
// #[deprecated] pub fn generate_command_legacy(...) { ... }
// (No longer exists)
```

**Update CHANGELOG**:
```markdown
## [2.0.0] - 2026-07-15

### Breaking Changes
- **Removed**: `--backend` flag (deprecated in v1.5.0)
  - Use `--inference-backend` instead
  - See migration guide: https://docs.caro.sh/migration/v2
  
- **Removed**: v1.x config format
  - Use `caro migrate-config` to convert
  - New format documented at: https://docs.caro.sh/config

### Migration
See full migration guide: https://docs.caro.sh/migration/v2
```

---

## Migration Guides

### Migration Guide Template

```markdown
# Migrating from v[OLD] to v[NEW]

**Last Updated**: [Date]
**Migration Difficulty**: Easy / Medium / Hard
**Estimated Time**: [X minutes/hours]

---

## Overview

Brief summary of what changed and why.

---

## Breaking Changes

### 1. [Change Title]

**What Changed**: [Description]

**Why**: [Rationale]

**Before** (v[OLD]):
```bash
[old code example]
```

**After** (v[NEW]):
```bash
[new code example]
```

**Migration Steps**:
1. [Step 1]
2. [Step 2]
3. [Step 3]

**Automated Migration**:
```bash
[migration command or script]
```

---

### 2. [Another Change]

[Same structure as above]

---

## Deprecation Warnings

If you see these warnings, here's how to fix them:

### Warning: "X is deprecated"

**Fix**:
[How to resolve]

---

## Testing Your Migration

After migrating, verify everything works:

```bash
# Test basic functionality
caro "test query" --dry-run

# Run integration tests (if you have them)
./run_tests.sh

# Check config is valid
caro config validate
```

---

## Rollback Plan

If migration causes issues, you can rollback:

```bash
# Uninstall v[NEW]
cargo uninstall caro

# Reinstall v[OLD]
cargo install caro@[OLD]

# Restore old config (if you backed it up)
cp ~/.config/caro/config.backup.toml ~/.config/caro/config.toml
```

---

## Need Help?

- Migration issues: GitHub Issues with `migration` label
- Questions: Discord #support or GitHub Discussions
- Bug reports: GitHub Issues with `bug` label
```

---

## Version Support Policy

### Support Tiers

**Tier 1: Active Development** (Current MINOR version):
- Latest: v1.3.x
- Support: Bug fixes, security patches, new features
- Duration: Until next MINOR release

**Tier 2: Maintenance** (Previous MINOR version):
- Example: v1.2.x when v1.3.0 released
- Support: Critical bugs, security patches only
- Duration: 6 months after superseded

**Tier 3: End of Life** (Old MINOR versions):
- Example: v1.1.x when v1.3.0 exists
- Support: Security patches only (if critical)
- Duration: Until next MAJOR release

**Tier 4: Unsupported** (Old MAJOR versions):
- Example: v0.x.x after v1.0.0 released
- Support: None (upgrade required)

### Support Timeline Example

```
Time →
Jan 2026    Apr 2026    Jul 2026    Oct 2026    Jan 2027
   │           │           │           │           │
   v1.1.0      v1.2.0      v1.3.0      v2.0.0      
   │           │           │           │
   ├─Active────┤           │           │
   │           ├─Active────┤           │
   │           │           ├─Active────┤
   │           │           │           └─Active────→
   │           │           │
   └─Maint─────┴─EOL───────┘
               └─Maint─────┴─EOL───────┘
                           └─Maint─────┴─EOL───────→
```

### LTS (Long-Term Support) Policy

**Status**: Not yet (v1.x is too early)

**Future** (when mature):
- Designate specific MINOR versions as LTS (e.g., v2.4 LTS)
- Extended support: 2 years of security patches
- Target: Enterprise users who need stability

---

## Compatibility Testing

### Automated Compatibility Tests

**Test Suite** (run on every PR):

```rust
#[test]
fn test_cli_backward_compatibility_v1() {
    // Verify v1.0.0 CLI commands still work
    let output = Command::new("caro")
        .arg("find rust files")
        .arg("--backend")
        .arg("static")
        .output()
        .unwrap();
    
    assert!(output.status.success());
}

#[test]
fn test_json_output_format_v1() {
    // Verify JSON output matches v1.x schema
    let output = Command::new("caro")
        .arg("list files")
        .arg("--json")
        .output()
        .unwrap();
    
    let result: serde_json::Value = serde_json::from_slice(&output.stdout).unwrap();
    assert!(result.get("cmd").is_some());
    assert!(result.get("confidence").is_some());
}

#[test]
fn test_config_v1_still_loads() {
    // Verify old config format still works
    let config_v1 = r#"
        [backend]
        default = "embedded"
    "#;
    
    let config: Config = toml::from_str(config_v1).unwrap();
    assert_eq!(config.backend.default, "embedded");
}
```

**Compatibility Test Matrix** (run weekly):

| Test | v1.0.0 | v1.1.0 | v1.2.0 | v1.3.0 |
|------|--------|--------|--------|--------|
| Basic command generation | ✅ Pass | ✅ Pass | ✅ Pass | ✅ Pass |
| `--backend static` | ✅ Pass | ✅ Pass | ⚠️ Deprecated | ❌ Removed |
| JSON output v1 format | ✅ Pass | ✅ Pass | ✅ Pass | ⚠️ Opt-in |
| Config TOML v1 | ✅ Pass | ✅ Pass | ⚠️ Migrate | ❌ Removed |

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-08 | Engineering Lead + Product Lead | Initial API stability & backward compatibility policy |

---

**End of Document**
