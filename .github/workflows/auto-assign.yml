name: Auto Assign

on:
  pull_request_target:
    types: [opened, ready_for_review]
  issues:
    types: [opened]

permissions:
  issues: write
  pull-requests: write

jobs:
  assign-pr-author:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: Assign PR author
        uses: actions/github-script@v7
        with:
          script: |
            const prAuthor = context.payload.pull_request.user.login;

            // Don't assign bots
            if (prAuthor.includes('[bot]')) {
              console.log('Skipping bot PR');
              return;
            }

            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              assignees: [prAuthor]
            });

            console.log('Assigned PR #' + context.payload.pull_request.number + ' to ' + prAuthor);

  request-review:
    if: github.event_name == 'pull_request_target' && !github.event.pull_request.draft
    runs-on: ubuntu-latest
    steps:
      - name: Request review from code owners
        uses: actions/github-script@v7
        with:
          script: |
            const prAuthor = context.payload.pull_request.user.login;

            // Don't request review for bot PRs
            if (prAuthor.includes('[bot]')) {
              console.log('Skipping bot PR');
              return;
            }

            // Define maintainers (update this list as needed)
            const maintainers = ['wildcard'];

            // Don't request review from the PR author
            const reviewers = maintainers.filter(m => m !== prAuthor);

            if (reviewers.length === 0) {
              console.log('No reviewers available (author is the only maintainer)');
              return;
            }

            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: reviewers
              });
              console.log('Requested review from: ' + reviewers.join(', '));
            } catch (error) {
              console.log('Could not request reviewers: ' + error.message);
            }

  add-triage-label:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Add triage label to new issues
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // Check if issue already has labels from template
            if (issue.labels && issue.labels.length > 0) {
              console.log('Issue already has labels, skipping triage label');
              return;
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['needs-triage']
            });

            console.log('Added needs-triage label to issue #' + issue.number);
