name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]

    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Run clippy
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: Run all tests (comprehensive)
      run: cargo test --workspace --all-features --verbose -- --test-threads=1
      env:
        RUST_BACKTRACE: 1

    - name: Run MLX backend tests (macOS Apple Silicon only)
      if: matrix.os == 'macos-latest'
      run: |
        echo "Running MLX-specific tests on macOS with default model"
        cargo test --test mlx_backend_contract --verbose
        cargo test --test mlx_integration_test --verbose
      env:
        RUST_BACKTRACE: 1
        CARO_MODEL: qwen-1.5b-q4  # Use default for comprehensive MLX tests

    - name: Run E2E tests per platform
      run: |
        echo "Running comprehensive E2E tests on ${{ matrix.os }}"
        cargo test --test e2e_cli_tests --verbose
        cargo test --test e2e_interactive_execution --verbose
        cargo test --test embedded_integration --verbose
        cargo test --test system_integration --verbose
      env:
        RUST_BACKTRACE: 1

    - name: Run integration tests per platform
      run: |
        cargo test --test integration_tests --verbose
        cargo test --test infrastructure_integration --verbose
        cargo test --test error_handling_tests --verbose
      env:
        RUST_BACKTRACE: 1

    - name: Run contract tests per platform
      run: |
        cargo test --test backend_trait_contract --verbose
        cargo test --test safety_validator_contract --verbose
        cargo test --test platform_detection_contract --verbose
        cargo test --test config_contract --verbose
        cargo test --test execution_contract --verbose
      env:
        RUST_BACKTRACE: 1

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Install cargo-audit
      run: cargo install cargo-audit
    
    - name: Run security audit
      run: cargo audit

  test-models-macos:
    name: Test Models on macOS (${{ matrix.model.name }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        model:
          - id: smollm-135m-q4
            name: SmolLM 135M
            size: 82MB
            description: Ultra-fast CI model
          - id: qwen-0.5b-q4
            name: Qwen 0.5B
            size: 352MB
            description: Balanced CI model (MLX-optimized)
          - id: tinyllama-1.1b-q4
            name: TinyLlama 1.1B
            size: 669MB
            description: Quality CI model
          - id: starcoder-1b-q4
            name: StarCoder 1B
            size: 700MB
            description: Code-specialized model

    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: macos-${{ matrix.model.id }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache model files
      uses: actions/cache@v4
      with:
        path: ~/Library/Caches/caro/models
        key: model-${{ matrix.model.id }}-${{ hashFiles('src/model_catalog.rs') }}
        restore-keys: |
          model-${{ matrix.model.id }}-
    
    - name: Display model info
      run: |
        echo "=========================================="
        echo "Testing with: ${{ matrix.model.name }}"
        echo "Model ID: ${{ matrix.model.id }}"
        echo "Size: ${{ matrix.model.size }}"
        echo "Description: ${{ matrix.model.description }}"
        echo "=========================================="
    
    - name: Run E2E tests with ${{ matrix.model.name }}
      run: |
        echo "Running E2E tests with ${{ matrix.model.name }} (${{ matrix.model.size }})"
        cargo test --test e2e_cli_tests --verbose -- --test-threads=1
        cargo test --test system_integration --verbose -- --test-threads=1
      env:
        RUST_BACKTRACE: 1
        CARO_MODEL: ${{ matrix.model.id }}
    
    - name: Run MLX integration tests with ${{ matrix.model.name }}
      run: |
        echo "Running MLX integration tests with ${{ matrix.model.name }}"
        cargo test --test mlx_integration_test --verbose
      env:
        RUST_BACKTRACE: 1
        CARO_MODEL: ${{ matrix.model.id }}
    
    - name: Run embedded backend tests with ${{ matrix.model.name }}
      run: |
        echo "Running embedded backend tests with ${{ matrix.model.name }}"
        cargo test --test embedded_backend_contract --verbose
      env:
        RUST_BACKTRACE: 1
        CARO_MODEL: ${{ matrix.model.id }}
    
    - name: Report test results
      if: always()
      run: |
        echo "✅ Tests completed for ${{ matrix.model.name }}"
        echo "Model: ${{ matrix.model.id }} (${{ matrix.model.size }})"

  build:
    name: Build Release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: caro-linux-amd64
            features: embedded-cpu,remote-backends
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            name: caro-linux-arm64
            features: embedded-cpu,remote-backends
          - os: macos-latest
            target: x86_64-apple-darwin
            name: caro-macos-intel
            features: embedded-cpu,remote-backends
          - os: macos-latest
            target: aarch64-apple-darwin
            name: caro-macos-silicon
            features: embedded-mlx,embedded-cpu,remote-backends
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: caro-windows-amd64.exe
            features: embedded-cpu,remote-backends

    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: stable
        targets: ${{ matrix.target }}
    
    - name: Install cross (for cross-compilation)
      if: matrix.target == 'aarch64-unknown-linux-gnu'
      run: cargo install cross
    
    - name: Build release binary
      run: |
        if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
          cross build --release --target ${{ matrix.target }} --features ${{ matrix.features }}
        else
          cargo build --release --target ${{ matrix.target }} --features ${{ matrix.features }}
        fi
      shell: bash
    
    - name: Create artifact
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          cp target/${{ matrix.target }}/release/caro.exe ${{ matrix.name }}
        else
          cp target/${{ matrix.target }}/release/caro ${{ matrix.name }}
        fi
      shell: bash
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: ${{ matrix.name }}

  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build benchmarks
      run: cargo bench --no-run --verbose
      
    - name: Run benchmarks (TDD - may fail)
      run: cargo bench --verbose || echo "Benchmarks may fail during TDD phase"
      continue-on-error: true
    
    - name: Check binary size
      run: |
        cargo build --release
        ls -la target/release/caro
        SIZE=$(stat -f%z target/release/caro 2>/dev/null || stat -c%s target/release/caro)
        echo "Binary size: $SIZE bytes"
        # Fail if binary is larger than 50MB (52,428,800 bytes)
        if [ $SIZE -gt 52428800 ]; then
          echo "❌ Binary size ($SIZE bytes) exceeds 50MB limit"
          exit 1
        else
          echo "✅ Binary size ($SIZE bytes) is within 50MB limit"
        fi

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: stable
        components: llvm-tools-preview
    
    - name: Install cargo-llvm-cov
      run: cargo install cargo-llvm-cov
    
    - name: Generate coverage report
      run: cargo llvm-cov --all-features --lcov --output-path lcov.info
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: lcov.info
        fail_ci_if_error: true