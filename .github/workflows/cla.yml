name: "CLA Assistant"

on:
  issue_comment:
    types: [created]
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  actions: write
  contents: write
  pull-requests: write
  statuses: write

jobs:
  cla-check:
    runs-on: ubuntu-latest
    steps:
      # Check if user already signed before running CLA Assistant
      - name: Checkout signatures branch
        if: github.event.comment.body == 'I have read the CLA Document and I hereby sign the CLA'
        uses: actions/checkout@v6
        with:
          ref: cla-signatures
          path: signatures-check
        continue-on-error: true

      - name: Check if already signed or allowlisted
        if: github.event.comment.body == 'I have read the CLA Document and I hereby sign the CLA'
        id: check-signed
        env:
          COMMENTER: ${{ github.event.comment.user.login }}
        run: |
          # Check allowlist patterns (case-insensitive for PR commenters)
          COMMENTER_LOWER=$(echo "$COMMENTER" | tr '[:upper:]' '[:lower:]')
          if [[ "$COMMENTER" == bot* ]] || [[ "$COMMENTER" == dependabot* ]] || \
             [[ "$COMMENTER" == github-actions* ]] || [[ "$COMMENTER_LOWER" == "claude" ]] || \
             [[ "$COMMENTER_LOWER" == "wildcard" ]] || [[ "$COMMENTER_LOWER" == "copilot" ]]; then
            echo "skip-message=true" >> $GITHUB_OUTPUT
            echo "User $COMMENTER is in allowlist"
            exit 0
          fi

          # Check if already signed
          if [ -f signatures-check/.github/cla-signatures.json ]; then
            if jq -e --arg user "$COMMENTER" '.signedContributors[] | select(.name == $user)' signatures-check/.github/cla-signatures.json > /dev/null 2>&1; then
              echo "skip-message=true" >> $GITHUB_OUTPUT
              echo "User $COMMENTER already signed"
              exit 0
            fi
          fi

          echo "skip-message=false" >> $GITHUB_OUTPUT
          echo "User $COMMENTER is signing for the first time"

      - name: "CLA Assistant"
        if: (github.event.comment.body == 'recheck' || github.event.comment.body == 'I have read the CLA Document and I hereby sign the CLA') || github.event_name == 'pull_request_target'
        uses: contributor-assistant/github-action@v2.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Use a Personal Access Token with 'repo' scope for private repos
          # PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        with:
          path-to-signatures: '.github/cla-signatures.json'
          path-to-document: 'https://github.com/wildcard/caro/blob/main/docs/legal/CLA.md'
          # Branch where signatures will be stored
          branch: 'cla-signatures'
          # Allowlist for bots and specific users (case-sensitive for commit authors)
          allowlist: bot*,dependabot*,github-actions*,claude,Claude,wildcard,copilot,Copilot

          # Message to post on PR when CLA is not signed
          custom-pr-sign-comment: |
            Thank you for your contribution to **caro**! ðŸŽ‰

            Before we can merge your pull request, we need you to sign our **Contributor License Agreement (CLA)**.

            ### How to Sign

            Please read our CLA here: [CLA.md](https://github.com/wildcard/caro/blob/main/docs/legal/CLA.md)

            Once you've read and agree to the terms, simply comment on this PR with:
            ```
            I have read the CLA Document and I hereby sign the CLA
            ```

            ### Alternative: Developer Certificate of Origin (DCO)

            If you prefer, you can use DCO instead by signing off your commits with:
            ```bash
            git commit -s -m "Your commit message"
            ```

            See [DCO.txt](https://github.com/wildcard/caro/blob/main/docs/legal/DCO.txt) for details.

            ---

            *Note: You only need to sign once. Your signature will cover all future contributions to caro.*

          # Disable automatic message - we handle this manually below
          custom-allsigned-prcomment: ''

          # Lock PR branch after merge to prevent signature removal
          lock-pullrequest-aftermerge: true

          # Signature verification
          use-dco-flag: false

      # Only post confirmation when user actually signs in this PR (not allowlisted, not already signed)
      - name: Post CLA Signed Confirmation
        if: |
          github.event.comment.body == 'I have read the CLA Document and I hereby sign the CLA' &&
          steps.check-signed.outputs.skip-message != 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `**âœ… CLA Signed!**\n\nThank you for signing the CLA! Your contribution can now be reviewed and merged. ðŸš€`
            });
