name: Community Health Check

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  health-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Generate community health report
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get various metrics
            const [openIssues, openPRs, contributors] = await Promise.all([
              github.rest.issues.listForRepo({
                owner: owner,
                repo: repo,
                state: 'open',
                per_page: 100
              }),
              github.rest.pulls.list({
                owner: owner,
                repo: repo,
                state: 'open',
                per_page: 100
              }),
              github.rest.repos.listContributors({
                owner: owner,
                repo: repo,
                per_page: 100
              })
            ]);

            // Calculate metrics
            const now = new Date();
            const oneWeekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

            const recentIssues = openIssues.data.filter(
              i => new Date(i.created_at) > oneWeekAgo
            );

            const staleIssues = openIssues.data.filter(
              i => new Date(i.updated_at) < oneMonthAgo
            );

            const unlabeledIssues = openIssues.data.filter(
              i => !i.labels || i.labels.length === 0
            );

            const draftPRs = openPRs.data.filter(pr => pr.draft);
            const readyPRs = openPRs.data.filter(pr => !pr.draft);

            const dateStr = now.toISOString().split('T')[0];
            const staleWarning = staleIssues.length > 5 ? 'Consider triaging stale issues' : 'Stale issues under control';
            const labelWarning = unlabeledIssues.length > 3 ? 'Some issues need labels' : 'Issues are well-labeled';
            const prWarning = readyPRs.length > 5 ? 'Several PRs awaiting review' : 'PR queue is manageable';

            const report = '## Weekly Community Health Report\n\n' +
              '**Metrics as of ' + dateStr + '**\n\n' +
              '### Issues\n' +
              '- Open issues: **' + openIssues.data.length + '**\n' +
              '- New this week: **' + recentIssues.length + '**\n' +
              '- Stale (no activity 30+ days): **' + staleIssues.length + '**\n' +
              '- Unlabeled: **' + unlabeledIssues.length + '**\n\n' +
              '### Pull Requests\n' +
              '- Open PRs: **' + openPRs.data.length + '**\n' +
              '- Ready for review: **' + readyPRs.length + '**\n' +
              '- Drafts: **' + draftPRs.length + '**\n\n' +
              '### Contributors\n' +
              '- Total contributors: **' + contributors.data.length + '**\n\n' +
              '### Action Items\n' +
              '- ' + staleWarning + '\n' +
              '- ' + labelWarning + '\n' +
              '- ' + prWarning + '\n\n' +
              '---\n' +
              '*This report is generated automatically every Monday.*';

            console.log(report);

  check-required-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for required community health files
        run: |
          echo "Checking for required community health files..."

          required_files=(
            "README.md"
            "CONTRIBUTING.md"
            "CODE_OF_CONDUCT.md"
            "LICENSE"
            "SECURITY.md"
            ".github/ISSUE_TEMPLATE/bug_report.yml"
            ".github/ISSUE_TEMPLATE/feature_request.yml"
            ".github/PULL_REQUEST_TEMPLATE.md"
          )

          missing=()

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing+=("$file")
            fi
          done

          if [ ${#missing[@]} -eq 0 ]; then
            echo "All required community health files are present"
          else
            echo "Missing files:"
            printf '%s\n' "${missing[@]}"
          fi
