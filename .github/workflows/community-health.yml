name: Community Health Check

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  health-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Generate community health report
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get various metrics
            const [openIssues, openPRs, contributors] = await Promise.all([
              github.rest.issues.listForRepo({
                owner, repo,
                state: 'open',
                per_page: 100
              }),
              github.rest.pulls.list({
                owner, repo,
                state: 'open',
                per_page: 100
              }),
              github.rest.repos.listContributors({
                owner, repo,
                per_page: 100
              })
            ]);

            // Calculate metrics
            const now = new Date();
            const oneWeekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

            const recentIssues = openIssues.data.filter(
              i => new Date(i.created_at) > oneWeekAgo
            );

            const staleIssues = openIssues.data.filter(
              i => new Date(i.updated_at) < oneMonthAgo
            );

            const unlabeledIssues = openIssues.data.filter(
              i => !i.labels || i.labels.length === 0
            );

            const draftPRs = openPRs.data.filter(pr => pr.draft);
            const readyPRs = openPRs.data.filter(pr => !pr.draft);

            const report = `## Weekly Community Health Report

üìä **Metrics as of ${now.toISOString().split('T')[0]}**

### Issues
- üì¨ Open issues: **${openIssues.data.length}**
- üÜï New this week: **${recentIssues.length}**
- ‚è∞ Stale (no activity 30+ days): **${staleIssues.length}**
- üè∑Ô∏è Unlabeled: **${unlabeledIssues.length}**

### Pull Requests
- üìù Open PRs: **${openPRs.data.length}**
- ‚úÖ Ready for review: **${readyPRs.length}**
- üìã Drafts: **${draftPRs.length}**

### Contributors
- üë• Total contributors: **${contributors.data.length}**

### Action Items
${staleIssues.length > 5 ? '‚ö†Ô∏è Consider triaging stale issues' : '‚úÖ Stale issues under control'}
${unlabeledIssues.length > 3 ? '‚ö†Ô∏è Some issues need labels' : '‚úÖ Issues are well-labeled'}
${readyPRs.length > 5 ? '‚ö†Ô∏è Several PRs awaiting review' : '‚úÖ PR queue is manageable'}

---
*This report is generated automatically every Monday.*`;

            console.log(report);

            // Optionally create an issue with the report
            // Uncomment below if you want weekly report issues
            /*
            await github.rest.issues.create({
              owner, repo,
              title: `Community Health Report - Week of ${now.toISOString().split('T')[0]}`,
              body: report,
              labels: ['documentation', 'automated']
            });
            */

  check-required-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for required community health files
        run: |
          echo "Checking for required community health files..."

          required_files=(
            "README.md"
            "CONTRIBUTING.md"
            "CODE_OF_CONDUCT.md"
            "LICENSE"
            "SECURITY.md"
            ".github/ISSUE_TEMPLATE/bug_report.yml"
            ".github/ISSUE_TEMPLATE/feature_request.yml"
            ".github/PULL_REQUEST_TEMPLATE.md"
          )

          missing=()

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing+=("$file")
            fi
          done

          if [ ${#missing[@]} -eq 0 ]; then
            echo "‚úÖ All required community health files are present"
          else
            echo "‚ö†Ô∏è Missing files:"
            printf '%s\n' "${missing[@]}"
          fi
