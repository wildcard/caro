name: LLM Evaluation Harness

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  evaluate:
    strategy:
      fail-fast: false  # Continue testing other backends even if one fails
      matrix:
        backend:
          - static_matcher
          - mlx
          - embedded-smollm
          - embedded-qwen
        include:
          # MLX requires macOS (Apple Silicon)
          - backend: mlx
            runner: macos-latest
          # Other backends can run on Ubuntu
          - backend: static_matcher
            runner: ubuntu-latest
          - backend: embedded-smollm
            runner: ubuntu-latest
          - backend: embedded-qwen
            runner: ubuntu-latest

    runs-on: ${{ matrix.runner }}
    name: Evaluate ${{ matrix.backend }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run Evaluation Harness
        id: evaluation
        run: |
          # Run evaluation with specific backend
          cargo test --test evaluation -- --backend ${{ matrix.backend }} 2>&1 | tee evaluation-${{ matrix.backend }}.log || true

          # Extract pass rate from output (gracefully handle backend unavailability)
          if grep -q "Passed:" evaluation-${{ matrix.backend }}.log; then
            PASS_RATE=$(grep "Passed:" evaluation-${{ matrix.backend }}.log | grep -o '( *[0-9.]*%)' | tr -d '()% ')
            echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
            echo "backend_available=true" >> $GITHUB_OUTPUT
          else
            echo "Backend ${{ matrix.backend }} not available or failed to run"
            echo "backend_available=false" >> $GITHUB_OUTPUT
            echo "pass_rate=0" >> $GITHUB_OUTPUT
          fi

      - name: Check Pass Rate Threshold
        if: steps.evaluation.outputs.backend_available == 'true'
        env:
          PASS_RATE: ${{ steps.evaluation.outputs.pass_rate }}
          BACKEND: ${{ matrix.backend }}
        run: |
          # Per-backend baselines (will be loaded from JSON files in future)
          case "$BACKEND" in
            static_matcher) BASELINE="31.0" ;;
            mlx) BASELINE="0.0" ;;  # TBD - not yet measured
            embedded-smollm) BASELINE="0.0" ;;  # TBD
            embedded-qwen) BASELINE="0.0" ;;  # TBD
            *) BASELINE="0.0" ;;
          esac

          echo "Backend: $BACKEND"
          echo "Pass Rate: $PASS_RATE%"
          echo "Baseline: $BASELINE%"

          # Skip check if baseline not yet established
          if (( $(echo "$BASELINE == 0.0" | bc -l) )); then
            echo "⚠️  Baseline not yet established for $BACKEND - skipping threshold check"
            exit 0
          fi

          # Block release if pass rate drops >5% from baseline
          THRESHOLD=$(echo "$BASELINE - 5.0" | bc -l)
          if (( $(echo "$PASS_RATE < $THRESHOLD" | bc -l) )); then
            echo "❌ Pass rate dropped >5% from baseline: $PASS_RATE% (baseline: $BASELINE%)"
            echo "RELEASE BLOCKED - Critical regression detected for $BACKEND"
            exit 1
          elif (( $(echo "$PASS_RATE < $BASELINE" | bc -l) )); then
            echo "⚠️  Pass rate below baseline: $PASS_RATE% (baseline: $BASELINE%)"
            echo "Warning: Performance regression detected for $BACKEND"
            exit 0  # Warning but don't block
          else
            echo "✅ Pass rate meets or exceeds baseline: $PASS_RATE%"
          fi

      - name: Upload Evaluation Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: evaluation-results-${{ matrix.backend }}
          path: evaluation-${{ matrix.backend }}.log
          retention-days: 30
