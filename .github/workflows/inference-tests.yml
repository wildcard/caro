name: Inference Tests (Real LLM)

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

  workflow_dispatch:
    # Allow manual trigger with options
    inputs:
      model_size:
        description: 'Model size to test'
        required: false
        default: '0.5B'
        type: choice
        options:
          - '0.5B'
          - '1.5B'
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'cpu-only'
          - 'mlx-only'
          - 'quality-only'

  push:
    branches:
      - main
    paths:
      - 'src/backends/**'
      - 'tests/inference/**'
      - '.github/workflows/inference-tests.yml'

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RUST_LOG: info

jobs:
  cpu-inference:
    name: CPU Inference Tests (${{ matrix.model }})
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        model: ['0.5B', '1.5B']
        exclude:
          # For scheduled runs, only test 0.5B to save CI minutes
          - model: ${{ github.event_name == 'schedule' && '1.5B' || 'none' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-inference-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-inference-
            ${{ runner.os }}-cargo-

      - name: Cache inference models
        id: cache-models
        uses: actions/cache@v4
        with:
          path: ~/.cache/cmdai/models
          key: v1-models-${{ matrix.model }}-${{ hashFiles('src/backends/embedded/config.rs', '.github/scripts/setup-inference-model.sh') }}
          restore-keys: |
            v1-models-${{ matrix.model }}-
            v1-models-

      - name: Setup inference model
        run: |
          chmod +x .github/scripts/setup-inference-model.sh
          .github/scripts/setup-inference-model.sh
        env:
          MODEL_SIZE: ${{ matrix.model }}
          MODEL_QUANT: ${{ matrix.model == '0.5B' && 'Q4_K_S' || 'Q4_K_M' }}

      - name: Build with inference support
        run: cargo build --features slow-tests --release
        timeout-minutes: 15

      - name: Run CPU inference tests
        id: inference-tests
        run: |
          # Create results directory
          mkdir -p target/test-results

          # Run tests with JSON output
          cargo test --features slow-tests \
                     --test inference \
                     -- --ignored --nocapture \
                     --format json > target/test-results/raw-output.json || true

          # Also run with human-readable output for logs
          cargo test --features slow-tests \
                     --test inference \
                     -- --ignored --nocapture
        timeout-minutes: 30
        continue-on-error: true

      - name: Parse test results
        if: always()
        run: |
          # Extract test results summary
          if [ -f target/test-results/raw-output.json ]; then
            echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Count passed/failed tests
            PASSED=$(grep -c '"event":"ok"' target/test-results/raw-output.json || echo "0")
            FAILED=$(grep -c '"event":"failed"' target/test-results/raw-output.json || echo "0")
            TOTAL=$((PASSED + FAILED))

            echo "- **Total Tests**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: ‚úÖ $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: ‚ùå $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ $FAILED -gt 0 ]; then
              echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              grep '"event":"failed"' target/test-results/raw-output.json | \
                jq -r '.name' | \
                sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || true
            fi
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpu-inference-results-${{ matrix.model }}
          path: |
            target/test-results/
            ~/.cache/cmdai/models/metadata.json
          retention-days: 30

      - name: Check test success
        if: steps.inference-tests.outcome == 'failure'
        run: |
          echo "‚ùå Inference tests failed"
          exit 1

  mlx-inference:
    name: MLX Inference Tests (Apple Silicon)
    runs-on: macos-14  # Apple Silicon runner
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-mlx-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache models
        uses: actions/cache@v4
        with:
          path: ~/.cache/cmdai/models
          key: v1-models-mlx-0.5B-${{ hashFiles('src/backends/embedded/config.rs') }}

      - name: Setup inference model
        run: |
          chmod +x .github/scripts/setup-inference-model.sh
          .github/scripts/setup-inference-model.sh
        env:
          MODEL_SIZE: "0.5B"
          MODEL_QUANT: "Q4_K_S"

      - name: Build with MLX support
        run: cargo build --features slow-tests,embedded-mlx --release
        timeout-minutes: 20

      - name: Run MLX inference tests
        id: mlx-tests
        run: |
          cargo test --features slow-tests,embedded-mlx \
                     --test inference \
                     -- --ignored --nocapture \
                     test_mlx
        timeout-minutes: 20
        continue-on-error: true

      - name: Run performance benchmarks
        if: success()
        run: |
          cargo bench --features slow-tests,embedded-mlx \
                      mlx_inference || echo "Benchmarks not yet implemented"
        continue-on-error: true

      - name: Upload benchmark results
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: mlx-benchmarks
          path: target/criterion/
          retention-days: 30

      - name: Check test success
        if: steps.mlx-tests.outcome == 'failure'
        run: |
          echo "‚ùå MLX inference tests failed"
          exit 1

  quality-validation:
    name: Command Quality Validation
    runs-on: ubuntu-latest
    needs: cpu-inference
    if: always()
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          pattern: cpu-inference-results-*
          path: test-results/
          merge-multiple: true

      - name: Cache models
        uses: actions/cache@v4
        with:
          path: ~/.cache/cmdai/models
          key: v1-models-0.5B-${{ hashFiles('src/backends/embedded/config.rs') }}

      - name: Setup model
        run: |
          chmod +x .github/scripts/setup-inference-model.sh
          .github/scripts/setup-inference-model.sh
        env:
          MODEL_SIZE: "0.5B"

      - name: Run quality validation tests
        run: |
          cargo test --features slow-tests \
                     --test inference \
                     -- --ignored \
                     test_command_quality
        continue-on-error: true

      - name: Generate quality report
        if: always()
        run: |
          # Placeholder for quality report generation
          # Will be implemented with src/bin/generate-quality-report.rs
          echo "# Command Quality Report" > target/quality-report.md
          echo "" >> target/quality-report.md
          echo "Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> target/quality-report.md
          echo "" >> target/quality-report.md
          echo "See test results artifacts for detailed output." >> target/quality-report.md

      - name: Upload quality report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: target/quality-report.md
          retention-days: 90

      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('target/quality-report.md')) {
              const report = fs.readFileSync('target/quality-report.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## üß™ Inference Quality Report\n\n${report}`
              });
            }

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [cpu-inference, mlx-inference, quality-validation]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results/

      - name: Generate summary
        run: |
          echo "# Inference Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- CPU Inference: ${{ needs.cpu-inference.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- MLX Inference: ${{ needs.mlx-inference.result == 'success' && '‚úÖ Passed' || (needs.mlx-inference.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed') }}" >> $GITHUB_STEP_SUMMARY
          echo "- Quality Validation: ${{ needs.quality-validation.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä View detailed results in workflow artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        if: |
          needs.cpu-inference.result == 'failure' ||
          (needs.mlx-inference.result == 'failure' && needs.mlx-inference.result != 'skipped')
        run: |
          echo "‚ùå One or more inference test suites failed"
          exit 1
