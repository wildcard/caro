name: Install

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - '.github/workflows/installer.yml'
      - 'install.sh'
      - 'setup.sh'

env:
  CARGO_TERM_COLOR: always

jobs:
  install:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-14]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - name: Install zsh for ubuntu
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh

      - name: Install Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Test install.sh on bash
        run: |
          export CARO_INTERACTIVE=false
          /bin/bash ./install.sh
          export PATH="$HOME/.local/bin:$PATH"
          caro --help

      - name: Clean up for next test
        run: |
          rm -rf "$HOME/.local/bin/caro"
          rm -rf "$HOME/.cargo/bin/caro"

      - name: Test install.sh on zsh
        shell: zsh {0}
        run: |
          export CARO_INTERACTIVE=false
          /bin/bash ./install.sh
          export PATH="$HOME/.local/bin:$PATH"
          caro --help

      - name: Clean up for setup.sh test
        run: |
          rm -rf "$HOME/.local/bin/caro"
          rm -rf "$HOME/.cargo/bin/caro"

      - name: Test setup.sh on bash
        run: |
          /bin/bash ./setup.sh
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          caro --help

      - name: Clean up for next test
        run: |
          rm -rf "$HOME/.local/bin/caro"
          rm -rf "$HOME/.cargo/bin/caro"

      - name: Test setup.sh on zsh
        shell: zsh {0}
        run: |
          /bin/bash ./setup.sh
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          caro --help
