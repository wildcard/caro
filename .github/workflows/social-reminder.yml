# Social Media Reminder Workflow
#
# Reminds maintainers to share pending social media content.
# Creates GitHub issues as reminders when content is waiting.

name: Social Media Reminder

on:
  schedule:
    # Run every weekday at 9 AM UTC
    - cron: '0 9 * * 1-5'
  workflow_dispatch:

jobs:
  check-and-remind:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for pending social content
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const queuePath = 'website/src/data/social-queue.json';

            if (!fs.existsSync(queuePath)) {
              console.log('No social queue file found');
              core.setOutput('has_pending', 'false');
              return;
            }

            const queue = JSON.parse(fs.readFileSync(queuePath, 'utf8'));
            const pending = queue.pending || [];

            console.log(`Found ${pending.length} pending items`);

            if (pending.length === 0) {
              core.setOutput('has_pending', 'false');
              return;
            }

            core.setOutput('has_pending', 'true');
            core.setOutput('pending_count', pending.length.toString());

            // Build summary of pending items
            const summary = pending.slice(0, 5).map(item => {
              return `- **${item.title}** (${item.contentType}) - Created: ${new Date(item.createdAt).toLocaleDateString()}`;
            }).join('\n');

            core.setOutput('summary', summary);

            // Calculate oldest item age
            if (pending.length > 0) {
              const oldest = new Date(pending[pending.length - 1].createdAt);
              const age = Math.floor((Date.now() - oldest.getTime()) / (1000 * 60 * 60 * 24));
              core.setOutput('oldest_age', age.toString());
            }

      - name: Check for existing reminder issue
        if: steps.check.outputs.has_pending == 'true'
        id: existing
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'social-reminder',
              per_page: 1
            });

            if (issues.length > 0) {
              console.log(`Found existing reminder issue: #${issues[0].number}`);
              core.setOutput('exists', 'true');
              core.setOutput('issue_number', issues[0].number.toString());
            } else {
              core.setOutput('exists', 'false');
            }

      - name: Create or update reminder issue
        if: steps.check.outputs.has_pending == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pendingCount = parseInt('${{ steps.check.outputs.pending_count }}');
            const summary = `${{ steps.check.outputs.summary }}`;
            const oldestAge = '${{ steps.check.outputs.oldest_age }}';
            const exists = '${{ steps.existing.outputs.exists }}' === 'true';
            const issueNumber = parseInt('${{ steps.existing.outputs.issue_number }}' || '0');

            const dashboardUrl = 'https://caro.sh/social';
            const urgency = parseInt(oldestAge) > 3 ? 'ðŸ”´ URGENT' : parseInt(oldestAge) > 1 ? 'ðŸŸ¡' : 'ðŸŸ¢';

            const body = `## ${urgency} Social Media Content Ready to Share

            **${pendingCount} item(s)** waiting to be shared on social media.

            ### Pending Content

            ${summary}

            ${pendingCount > 5 ? `_...and ${pendingCount - 5} more_` : ''}

            ### Quick Actions

            1. Go to the [Social Media Dashboard](${dashboardUrl})
            2. Review the pre-generated content for each platform
            3. Click "Copy" to copy text, or "Share" to open the platform
            4. Close this issue when done

            ---

            **Oldest item:** ${oldestAge} day(s) old

            _This issue is automatically created by the social reminder workflow._
            `;

            if (exists && issueNumber > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });
              console.log(`Updated issue #${issueNumber}`);
            } else {
              // Create new issue
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Social] ${pendingCount} content item(s) ready to share`,
                body: body,
                labels: ['social-reminder', 'content']
              });
              console.log(`Created issue #${issue.number}`);
            }

      - name: Close reminder if no pending content
        if: steps.check.outputs.has_pending == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'social-reminder',
              per_page: 10
            });

            for (const issue of issues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
              console.log(`Closed issue #${issue.number} - no more pending content`);
            }
