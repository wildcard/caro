name: Mass Translation

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Keys per batch'
        default: '50'
        type: string
      delay_between:
        description: 'Seconds between batches'
        default: '10'
        type: string
      backend:
        description: 'Translation backend'
        type: choice
        options:
          - auto
          - claude
          - openai
          - libretranslate
        default: 'auto'
      locales:
        description: 'Specific locales (comma-separated) or "all"'
        default: 'all'
        type: string
  schedule:
    # Weekly Sunday 3am UTC
    - cron: '0 3 * * 0'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      locales: ${{ steps.set-locales.outputs.locales }}
    steps:
      - name: Set locales to translate
        id: set-locales
        env:
          INPUT_LOCALES: ${{ inputs.locales }}
        run: |
          if [ "$INPUT_LOCALES" = "all" ] || [ -z "$INPUT_LOCALES" ]; then
            echo 'locales=["es","fr","pt","de","ja","ko","he","ar","ru","uk","hi","ur","fil","id"]' >> $GITHUB_OUTPUT
          else
            # Convert comma-separated to JSON array safely
            JSON_ARRAY=$(echo "$INPUT_LOCALES" | jq -R -s -c 'split(",") | map(gsub("^\\s+|\\s+$";""))')
            echo "locales=$JSON_ARRAY" >> $GITHUB_OUTPUT
          fi

  translate:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        locale: ${{ fromJson(needs.prepare.outputs.locales) }}
      max-parallel: 3
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd website
          npm ci

      - name: Run translation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          LOCALE: ${{ matrix.locale }}
          BACKEND: ${{ inputs.backend || 'auto' }}
          BATCH_SIZE: ${{ inputs.batch_size || '50' }}
        run: |
          node .github/scripts/translate-multi-backend.js \
            --locale "$LOCALE" \
            --backend "$BACKEND" \
            --batch-size "$BATCH_SIZE"

      - name: Check for changes
        id: check-changes
        env:
          LOCALE: ${{ matrix.locale }}
        run: |
          if git diff --quiet "website/src/i18n/locales/$LOCALE/"; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "i18n(${{ matrix.locale }}): Mass translation update"
          branch: i18n/mass-translate-${{ matrix.locale }}-${{ github.run_number }}
          delete-branch: true
          title: "i18n(${{ matrix.locale }}): Mass translation update"
          body: |
            ## Translation Update for ${{ matrix.locale }}

            **Backend**: ${{ inputs.backend || 'auto' }}
            **Batch size**: ${{ inputs.batch_size || '50' }}
            **Run**: #${{ github.run_number }}

            ### Review Checklist
            - [ ] Placeholders preserved ({count}, {name})
            - [ ] Brand names preserved (Caro, Claude, POSIX)
            - [ ] Cultural tone appropriate
            - [ ] No machine-translation artifacts
            - [ ] RTL layout correct (if applicable)

            ### How to Test
            ```bash
            cd website
            npm run build
            npm run preview

            # Check these URLs:
            # http://localhost:4321/${{ matrix.locale }}/
            # http://localhost:4321/${{ matrix.locale }}/features
            ```

            ---
            ðŸ¤– Generated by [Mass Translation workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: |
            i18n
            translation
            automated

      - name: Add delay between batches
        if: inputs.delay_between
        env:
          DELAY: ${{ inputs.delay_between }}
        run: sleep "$DELAY"

  report:
    needs: translate
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd website
          npm ci

      - name: Generate status report
        run: |
          cd website
          node scripts/i18n/status.mjs > translation-status.txt

      - name: Upload status report
        uses: actions/upload-artifact@v4
        with:
          name: translation-status-${{ github.run_number }}
          path: website/translation-status.txt

      - name: Comment on workflow
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const status = fs.readFileSync('website/translation-status.txt', 'utf8');

            github.rest.actions.createWorkflowComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
              body: `## Translation Status Report\n\n\`\`\`\n${status}\n\`\`\``
            });
