# Ralph Planning Mode - Caro

You are in **Planning Mode**. Your job is to analyze the codebase against specifications and generate a prioritized implementation plan. Do NOT implement anything - only analyze and plan.

## 0a. Study the Project Architecture

Study these files to understand caro's structure:

```
src/lib.rs              # Library entry point, module exports
Cargo.toml              # Dependencies, features, metadata
.specify/memory/constitution.md  # Project principles (TDD, safety-first)
ROADMAP.md              # Release timeline and priorities
.claude/AGENTS.md       # Build commands, patterns, learnings
```

## 0b. Study Specifications

Study all specification documents:

```
specs/                  # Feature specifications
.specify/specs/         # Spec-Kitty generated specs
kitty-specs/            # Additional specifications
```

Each spec represents a Job to Be Done (JTBD). Understand the requirements fully.

## 0c. Study Current Implementation

Using parallel subagents, analyze:

1. **Core modules** in `src/`:
   - `backends/` - LLM inference (embedded, remote)
   - `safety/` - Command validation patterns
   - `cli/` - User interface
   - `execution/` - Command execution engine
   - `agent/` - Multi-iteration refinement

2. **Test coverage** in `tests/`:
   - Contract tests
   - Integration tests
   - Beta regression tests

3. **Existing gaps**: Run pattern analysis if relevant
   ```bash
   python scripts/pattern_gap_analyzer.py
   ```

**CRITICAL**: Don't assume features are not implemented. Study the code first.

## 0d. Study Current Plan

Read `IMPLEMENTATION_PLAN.md` if it exists. Understand:
- What tasks are pending?
- What was recently completed?
- What is blocked?

## 1. Perform Gap Analysis

Compare specifications against implementation:

| Category | Question |
|----------|----------|
| Implemented | What specs are fully satisfied by current code? |
| Partial | What specs are partially implemented? |
| Missing | What specs have no implementation? |
| Technical Debt | What implementations need refactoring? |
| Test Gaps | What features lack adequate test coverage? |

## 2. Generate Implementation Plan

Create or update `IMPLEMENTATION_PLAN.md` with this format:

```markdown
# Caro Implementation Plan

> Auto-generated by Ralph planning mode
> Last updated: [YYYY-MM-DD HH:MM:SS]
> Branch: [current git branch]

## Summary

- Total tasks: X
- Critical: X | High: X | Medium: X | Low: X
- Estimated completion: X iterations

---

## Priority 1: Critical (Blocking)

Tasks that block other work or affect safety/security.

### Task 1.1: [Title]

- **Spec**: [link to spec file]
- **Why**: [one sentence explaining importance]
- **Files**: [files to modify]
- **Tests**: [test requirements - TDD is non-negotiable]
- **Acceptance**: [how to verify completion]
- **Dependencies**: [other tasks that must complete first, or "None"]

---

## Priority 2: High (Core Features)

Tasks for roadmap features and user-facing improvements.

### Task 2.1: [Title]

[Same format as above]

---

## Priority 3: Medium (Quality)

Performance, code quality, documentation improvements.

### Task 3.1: [Title]

[Same format as above]

---

## Priority 4: Low (Future)

Nice-to-have improvements for later consideration.

### Task 4.1: [Title]

[Same format as above]

---

## Completed

Tasks finished in previous iterations.

### [Title] (Completed YYYY-MM-DD)

- **Commit**: [commit hash]
- **Summary**: [what was done]

---

## Blocked

Tasks that cannot proceed until external dependencies resolve.

### [Title] (Blocked on: [reason])

- **Unblocks when**: [condition]
```

### Prioritization Guidelines

| Priority | Criteria |
|----------|----------|
| Critical | Security vulnerabilities, failing CI, blocking other developers |
| High | Roadmap features, items in current milestone, user-reported issues |
| Medium | Performance improvements, refactoring, test coverage |
| Low | Future considerations, nice-to-have, exploratory |

### Task Scoping Rule

**"One Sentence Without 'And'"** - If describing a task requires "and," split it into multiple tasks.

Good: "Add --dry-run flag to show commands without executing"
Bad: "Add --dry-run flag and update help text and add tests"

## 3. Validate Plan Quality

Before finalizing, verify:

- [ ] Every task has clear acceptance criteria
- [ ] Every task specifies test requirements (TDD is non-negotiable)
- [ ] Dependencies are correctly mapped
- [ ] No task requires "and" in its description
- [ ] Critical tasks address actual blockers
- [ ] Tasks align with ROADMAP.md priorities

## 4. Commit and Exit

```bash
# Stage the plan
git add IMPLEMENTATION_PLAN.md

# Commit with clear message
git commit -m "chore(ralph): update implementation plan

Generated by Ralph planning mode.
Total tasks: [count]
Changes: [brief summary of what changed]
"
```

Then exit cleanly so the loop can proceed.

## 999. Guardrails

### 9990. Planning Only
Do NOT implement any tasks. Do NOT modify source code. Only analyze and plan.

### 9991. Don't Assume Not Implemented
Always study code before marking something as missing. Use `grep`, `rg`, or subagents to search.

### 9992. Reference Specs
Every task must reference a specification or clear requirement source.

### 9993. TDD Requirements
Every task must include test requirements. TDD is non-negotiable per caro's constitution.

### 9994. Atomic Tasks
One task = one focused change. If you can't describe it in one sentence without "and," split it.

### 9995. Keep It Updated
The plan is a living document. Mark completed items, add new discoveries, remove obsolete tasks.
