#!/usr/bin/env bash
#
# release - Automated release script for cmdai
#
# Usage:
#   ./bin/release [options] <version>
#
# Examples:
#   ./bin/release 0.2.0          # Release version 0.2.0
#   ./bin/release 0.3.0-alpha.1  # Pre-release
#   ./bin/release --dry-run 0.2.0 # Preview without creating tag
#
# This script:
#   1. Validates the version format
#   2. Updates Cargo.toml version
#   3. Generates changelog preview
#   4. Commits the changes
#   5. Creates and pushes the version tag
#   6. The GitHub Actions workflow handles the rest
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
CARGO_TOML="$PROJECT_ROOT/Cargo.toml"

# Options
DRY_RUN=false
SKIP_TESTS=false
FORCE=false

usage() {
    cat << EOF
Usage: $(basename "$0") [options] <version>

Create a new release of cmdai.

Arguments:
  version         Semantic version (e.g., 0.2.0, 1.0.0-beta.1)

Options:
  -d, --dry-run   Preview changes without creating tags
  -f, --force     Skip confirmation prompts
  -s, --skip-tests Skip running tests before release
  -h, --help      Show this help message

Examples:
  $(basename "$0") 0.2.0              # Create stable release
  $(basename "$0") 0.3.0-alpha.1      # Create pre-release
  $(basename "$0") --dry-run 0.2.0    # Preview release

Version Format:
  - Stable: X.Y.Z (e.g., 1.0.0, 0.2.0)
  - Pre-release: X.Y.Z-<stage>.<n> (e.g., 1.0.0-alpha.1, 1.0.0-beta.2, 1.0.0-rc.1)
EOF
}

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        -s|--skip-tests)
            SKIP_TESTS=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
        *)
            VERSION="$1"
            shift
            ;;
    esac
done

# Validate version argument
if [[ -z "${VERSION:-}" ]]; then
    log_error "Version argument is required"
    usage
    exit 1
fi

# Validate version format (semver)
if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z]+\.[0-9]+)?$ ]]; then
    log_error "Invalid version format: $VERSION"
    log_error "Expected format: X.Y.Z or X.Y.Z-stage.N (e.g., 1.0.0 or 1.0.0-alpha.1)"
    exit 1
fi

TAG="v$VERSION"

# Check if we're in the project root
cd "$PROJECT_ROOT"

# Check for uncommitted changes
if [[ -n "$(git status --porcelain)" ]]; then
    log_error "Working directory has uncommitted changes. Please commit or stash them first."
    exit 1
fi

# Check if tag already exists
if git rev-parse "$TAG" >/dev/null 2>&1; then
    log_error "Tag $TAG already exists"
    exit 1
fi

# Get current version from Cargo.toml
CURRENT_VERSION=$(grep '^version = ' "$CARGO_TOML" | head -1 | sed 's/version = "\(.*\)"/\1/')
log_info "Current version: $CURRENT_VERSION"
log_info "New version: $VERSION"

# Detect if pre-release
IS_PRERELEASE=false
if [[ "$VERSION" == *"-"* ]]; then
    IS_PRERELEASE=true
    log_info "This is a pre-release"
fi

# Check for git-cliff
if ! command -v git-cliff &> /dev/null; then
    log_warning "git-cliff not found. Install it for changelog preview:"
    log_warning "  cargo install git-cliff"
    log_warning "Continuing without changelog preview..."
    HAS_CLIFF=false
else
    HAS_CLIFF=true
fi

# Preview changelog
if [[ "$HAS_CLIFF" == "true" ]]; then
    log_info "Generating changelog preview..."
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo " CHANGELOG PREVIEW"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    git cliff --unreleased --strip header 2>/dev/null || echo "(No unreleased changes detected)"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
fi

if [[ "$DRY_RUN" == "true" ]]; then
    log_info "Dry run mode - no changes will be made"
    log_info "Would update Cargo.toml version to: $VERSION"
    log_info "Would create tag: $TAG"
    exit 0
fi

# Confirmation
if [[ "$FORCE" != "true" ]]; then
    echo ""
    log_warning "This will:"
    echo "  1. Update Cargo.toml version to $VERSION"
    echo "  2. Commit the version change"
    echo "  3. Create and push tag: $TAG"
    echo "  4. Trigger GitHub Actions release workflow"
    echo ""
    read -p "Continue? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Aborted"
        exit 0
    fi
fi

# Run tests (unless skipped)
if [[ "$SKIP_TESTS" != "true" ]]; then
    log_info "Running tests..."
    if ! cargo test --lib; then
        log_error "Tests failed. Fix tests before releasing."
        exit 1
    fi
    log_success "Tests passed"
fi

# Update Cargo.toml version
log_info "Updating Cargo.toml version to $VERSION..."
sed -i.bak "s/^version = \"$CURRENT_VERSION\"/version = \"$VERSION\"/" "$CARGO_TOML"
rm -f "$CARGO_TOML.bak"

# Update Cargo.lock
log_info "Updating Cargo.lock..."
cargo update --package cmdai

# Commit version change
log_info "Committing version change..."
git add Cargo.toml Cargo.lock
git commit -m "chore(release): prepare for v$VERSION"

# Create tag
log_info "Creating tag $TAG..."
git tag -a "$TAG" -m "Release $TAG"

# Push changes
log_info "Pushing to remote..."
git push origin "$(git rev-parse --abbrev-ref HEAD)"
git push origin "$TAG"

log_success "Release $TAG created successfully!"
echo ""
log_info "GitHub Actions will now:"
echo "  - Build binaries for all platforms"
echo "  - Generate release notes from changelog"
echo "  - Create GitHub Release with all artifacts"
if [[ "$IS_PRERELEASE" == "false" ]]; then
    echo "  - Publish to crates.io"
fi
echo ""
log_info "Monitor the release at:"
echo "  https://github.com/wildcard/caro/actions"
echo ""
log_info "Release will be available at:"
echo "  https://github.com/wildcard/caro/releases/tag/$TAG"
