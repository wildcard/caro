# ADR-003: Monitoring and Audit Trail System

**Status**: Proposed

**Date**: 2025-11-29

**Authors**: cmdai core team

**Target**: Enterprise

**Depends on**:
- ADR-001 (Enterprise vs Community Architecture)
- ADR-002 (Governance and Provisioning System)

## Context

While the Governance and Provisioning System (ADR-002) provides **preventive controls** to block dangerous commands, enterprises also need **detective controls** to:

1. **Detect policy violations**: Know when developers attempt to bypass or violate policies
2. **Identify rogue machines**: Discover machines running unapproved commands
3. **Audit trail compliance**: Demonstrate who executed what command, when, and why
4. **Incident investigation**: Reconstruct timeline of events after security incidents
5. **Agent monitoring**: Track behavior of autonomous agents running on provisioned machines
6. **Behavioral analytics**: Identify anomalous patterns that may indicate compromise

### The Enterprise Visibility Gap

**Current State**: In community edition, cmdai has no visibility beyond the local machine. Each user's command history is private, local, and not centrally aggregated.

**Enterprise Need**: CISOs require centralized visibility into:
- What commands are being generated and executed across the organization
- Which policies are being violated (and by whom)
- When developers attempt risky operations
- Whether autonomous agents are operating safely
- Historical audit trail for compliance and forensics

### Key Scenarios Requiring Monitoring

1. **Rogue Developer Machine**
   - Developer disables safety checks
   - Developer executes unapproved dangerous commands
   - Developer installs prohibited tools
   - â†’ **Need**: Alert CISO within minutes

2. **Compromised Agent**
   - Autonomous agent starts executing malicious commands
   - Agent attempts privilege escalation
   - Agent exfiltrates data via commands
   - â†’ **Need**: Immediate detection and shutdown

3. **Compliance Audit**
   - Auditor asks: "Show me all database access in Q4 2024"
   - Auditor asks: "Who has executed terraform apply in production?"
   - Auditor asks: "Prove all high-risk commands were approved"
   - â†’ **Need**: Complete, searchable audit trail

4. **Security Incident**
   - Data breach detected, need to trace source
   - Unusual activity on production systems
   - Need to identify patient zero machine
   - â†’ **Need**: Forensic timeline reconstruction

5. **Policy Effectiveness**
   - Are developers frequently hitting policy blocks?
   - Which policies cause most friction?
   - Are there legitimate use cases being blocked?
   - â†’ **Need**: Analytics and reporting

### Monitoring Paradigm Shift

The enterprise offering changes cmdai from **opt-in** to **opt-out** for organizations:

- **Community**: User explicitly invokes `cmdai "do something"`
- **Enterprise**: All terminal activity is inspected, cmdai or not

This shift enables monitoring of:
- Commands generated by cmdai
- Commands executed directly by developers (bypassing cmdai)
- Commands executed by scripts and automation
- Commands executed by autonomous agents

**Key principle**: The opt-out decision belongs to the CISO, not individual developers.

### Business Context

**Market drivers**:
- **Compliance mandates**: SOC2, ISO27001 require audit trails
- **Zero trust architecture**: "Trust but verify" â†’ "Never trust, always verify"
- **AI governance regulations**: Emerging regulations around AI system oversight
- **Insider threat programs**: Need to detect anomalous developer behavior
- **Cyber insurance**: Insurers requiring proof of monitoring and controls

**Competitive landscape**: No existing tool provides terminal-level command monitoring integrated with AI governance.

## Decision

We will build a **comprehensive monitoring and audit trail system** with the following components:

### 1. Terminal Injection for Universal Monitoring

**Shell Integration**: Inject cmdai monitoring into the terminal prompt itself

```bash
# Enterprise plugin modifies shell initialization
# In ~/.bashrc or ~/.zshrc (auto-added on first cmdai enterprise install)

# cmdai enterprise monitoring hook
if command -v cmdai-enterprise-monitor &> /dev/null; then
    # Intercept all commands before execution
    preexec_cmdai_monitor() {
        local cmd="$1"
        cmdai-enterprise-monitor inspect "$cmd"
    }

    # ZSH hook
    [[ -n "$ZSH_VERSION" ]] && preexec_functions+=(preexec_cmdai_monitor)

    # Bash hook (requires DEBUG trap)
    [[ -n "$BASH_VERSION" ]] && trap 'cmdai-enterprise-monitor inspect "$BASH_COMMAND"' DEBUG
fi
```

**How it works**:
1. Developer opens terminal on provisioned machine
2. Shell initialization loads cmdai enterprise hooks
3. Every command (before execution) is inspected
4. Monitoring agent evaluates command against policy
5. Events logged locally and sent to central collector
6. Terminal continues normally (sub-millisecond overhead)

**Capabilities**:
- Monitor cmdai-generated commands
- Monitor manually typed commands
- Monitor script-executed commands
- Monitor agent-executed commands
- Flag policy violations in real-time
- Optional blocking mode (prevent execution)

### 2. Event Collection and Logging

**Event Schema**: Structured events for all terminal activity

```json
{
  "event_id": "evt_9f3a8b2c",
  "timestamp": "2025-11-29T14:32:18.392Z",
  "event_type": "command_executed",

  "machine": {
    "machine_id": "dev-machine-3f8a2b",
    "hostname": "alice-macbook-pro",
    "platform": "darwin-arm64",
    "ip_address": "10.0.5.42"
  },

  "user": {
    "email": "alice@acme-corp.com",
    "user_id": "user_alice_123",
    "department": "engineering",
    "team": "platform"
  },

  "command": {
    "text": "kubectl delete pod suspicious-pod -n production",
    "source": "manual",  // manual | cmdai | script | agent
    "working_directory": "/home/alice/projects/infrastructure",
    "shell": "zsh"
  },

  "policy_evaluation": {
    "decision": "blocked",
    "reason": "Production operations require approval",
    "violated_rules": [
      "require_approval_for_production",
      "kubectl_production_context_restricted"
    ],
    "risk_level": "high"
  },

  "approval": {
    "required": true,
    "workflow_id": "wf_abc123",
    "status": "pending",
    "approver": "manager@acme-corp.com"
  },

  "execution": {
    "allowed": false,
    "exit_code": null,
    "duration_ms": null
  },

  "context": {
    "session_id": "sess_xyz789",
    "parent_process": "iTerm2",
    "cmdai_version": "1.5.0",
    "enterprise_version": "1.0.3",
    "policy_version": "v2.3.1"
  }
}
```

**Event Types**:
- `command_generated`: cmdai generated a command
- `command_executed`: Command was executed
- `command_blocked`: Command was blocked by policy
- `policy_violation`: Policy violation detected
- `approval_requested`: Approval workflow initiated
- `approval_granted`: Approval received
- `approval_denied`: Approval denied
- `tool_installed`: New tool installed on machine
- `agent_activity`: Autonomous agent command
- `policy_updated`: Local policy updated
- `cmdai_disabled`: Enterprise plugin disabled (tamper alert)

### 3. Local Event Buffer with Resilient Sync

**Architecture**: Handle offline/disconnected scenarios

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Developer Machine               â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Terminal (cmdai monitor)  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚             â”‚                        â”‚
â”‚             â”‚ Events                 â”‚
â”‚             â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Local Event Buffer       â”‚     â”‚
â”‚  â”‚   - SQLite database        â”‚     â”‚
â”‚  â”‚   - 7-day retention        â”‚     â”‚
â”‚  â”‚   - Encrypted at rest      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚             â”‚                        â”‚
â”‚             â”‚ Async Sync             â”‚
â”‚             â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Sync Agent               â”‚     â”‚
â”‚  â”‚   - Batched uploads        â”‚     â”‚
â”‚  â”‚   - Retry logic            â”‚     â”‚
â”‚  â”‚   - Compression            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ HTTPS + mTLS
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Event Collection Service         â”‚
â”‚   - Kafka / Kinesis / PubSub      â”‚
â”‚   - Load balancing                â”‚
â”‚   - Authentication                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Event Storage & Processing       â”‚
â”‚   - Time-series database           â”‚
â”‚   - Search index (Elasticsearch)   â”‚
â”‚   - Analytics engine              â”‚
â”‚   - Alerting system               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Resilience Features**:
- Events buffered locally if collector unreachable
- Automatic retry with exponential backoff
- Compression to minimize bandwidth
- Batched uploads for efficiency
- Local encryption for sensitive data
- Graceful degradation if quota exceeded

### 4. Centralized CISO Dashboard

**Real-time Monitoring Interface**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Acme Corp - cmdai Enterprise Dashboard                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ðŸ“Š Overview (Last 24 Hours)                           â”‚
â”‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ 12,847       â”‚  â”‚ 143          â”‚  â”‚ 3           â”‚ â”‚
â”‚   â”‚ Commands     â”‚  â”‚ Blocked      â”‚  â”‚ Rogue       â”‚ â”‚
â”‚   â”‚ Executed     â”‚  â”‚ Commands     â”‚  â”‚ Machines    â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚  ðŸš¨ Active Alerts                                      â”‚
â”‚                                                         â”‚
â”‚   [HIGH] Machine dev-23 executing unapproved tools     â”‚
â”‚           User: bob@acme-corp.com                      â”‚
â”‚           Last: kubectl delete ns production (blocked) â”‚
â”‚           Action: [Investigate] [Quarantine] [Dismiss] â”‚
â”‚                                                         â”‚
â”‚   [MEDIUM] Unusual agent activity on ci-runner-05      â”‚
â”‚           Pattern: 50 terraform apply in 10 minutes    â”‚
â”‚           Action: [Investigate] [Shutdown] [Dismiss]   â”‚
â”‚                                                         â”‚
â”‚  ðŸ“ˆ Policy Compliance Trend                            â”‚
â”‚                                                         â”‚
â”‚   [Graph showing compliance rate over time]            â”‚
â”‚   Current: 99.2% compliance                            â”‚
â”‚   Target:  99.5%                                       â”‚
â”‚                                                         â”‚
â”‚  ðŸ” Recent Policy Violations                           â”‚
â”‚                                                         â”‚
â”‚   [TABLE]                                              â”‚
â”‚   Time    | User           | Command        | Policy  â”‚
â”‚   2:34 PM | alice@acme.com | rm -rf /data/* | blocked â”‚
â”‚   2:15 PM | bob@acme.com   | curl|bash      | blocked â”‚
â”‚   1:58 PM | agent_ci_3     | docker run -p  | flagged â”‚
â”‚                                                         â”‚
â”‚  [Search Commands] [Export Audit] [Policy Settings]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Dashboard Features**:

1. **Real-time Monitoring**
   - Live feed of command executions
   - Policy violation alerts
   - Rogue machine detection
   - Agent activity monitoring

2. **Search and Forensics**
   - Full-text search across all commands
   - Filter by user, machine, time, policy
   - Reconstruct sessions and timelines
   - Export for external analysis

3. **Analytics and Reporting**
   - Compliance rate trending
   - Policy effectiveness metrics
   - Top violated policies
   - User/team compliance scores
   - Custom reports for auditors

4. **Incident Response**
   - One-click machine quarantine
   - Revoke machine certificates
   - Force policy updates
   - Coordinate approval workflows

5. **Configuration**
   - Alert rule management
   - Notification channels (Slack, PagerDuty, email)
   - Retention policies
   - Data export settings

### 5. Intelligent Alerting and Anomaly Detection

**Alert Rules Engine**:

```yaml
# Example alert rules
alerts:
  - name: "High-Risk Command Blocked"
    condition: "event_type == 'command_blocked' AND risk_level == 'critical'"
    severity: "high"
    notify:
      - channel: "security-ops-slack"
      - email: "ciso@acme-corp.com"
    cooldown: "5m"

  - name: "Rogue Machine Detection"
    condition: "policy_violations > 10 in last 1 hour"
    severity: "critical"
    actions:
      - notify: "security-team"
      - quarantine_machine: true
    cooldown: "1h"

  - name: "Agent Anomaly"
    condition: |
      source == 'agent' AND
      (commands_per_minute > 100 OR
       failed_commands > 50%)
    severity: "medium"
    notify:
      - channel: "devops-alerts"
    cooldown: "15m"

  - name: "Production Database Access"
    condition: |
      command CONTAINS 'psql production' OR
      command CONTAINS 'mysql -h prod'
    severity: "medium"
    notify:
      - channel: "dba-team"
    require_approval: true
```

**Anomaly Detection**:

Machine learning-based detection of unusual patterns:
- Sudden spike in command volume from a user
- Commands executed at unusual times (e.g., 3 AM)
- New tool usage not seen in user's history
- Deviation from team/department norms
- Rapid succession of failed authentication attempts
- Geographic anomalies (IP address changes)

### 6. Compliance and Audit Export

**Audit Report Generation**:

```bash
# Generate compliance report
cmdai-enterprise audit-export \
  --start-date 2024-10-01 \
  --end-date 2024-12-31 \
  --format pdf \
  --include-evidence \
  --compliance-framework SOC2 \
  --output Q4-2024-SOC2-Audit.pdf

# Query specific events
cmdai-enterprise query \
  --user "alice@acme-corp.com" \
  --command-contains "terraform apply" \
  --time-range "last 90 days" \
  --format json
```

**Compliance Mappings**:

| Compliance Control | Evidence Provided |
|--------------------|-------------------|
| SOC2 CC6.1 (Logical Access) | All command executions with user attribution |
| SOC2 CC7.2 (Detection) | Policy violation alerts and responses |
| ISO27001 A.12.4.1 (Event Logging) | Complete audit trail with timestamps |
| HIPAA Â§164.308(a)(1)(ii)(D) (Access Audit) | Database access queries and approval records |
| PCI-DSS 10.2 (Audit Trails) | All administrative actions logged |

## Rationale

### Why Terminal Injection?

**Alternative**: Only monitor cmdai-generated commands

**Chosen approach**: Monitor all terminal activity

**Rationale**:
1. **Bypass prevention**: Developers can't circumvent by not using cmdai
2. **Comprehensive visibility**: See everything, not just AI-generated commands
3. **Agent detection**: Catch rogue agents regardless of tool used
4. **True compliance**: Auditors want complete picture, not partial
5. **Behavioral context**: Understand developer patterns holistically

### Why Local Buffering?

**Alternative**: Stream directly to cloud collector

**Chosen approach**: Local SQLite buffer with async sync

**Rationale**:
1. **Offline resilience**: Developers may work without network
2. **Performance**: No blocking waits for network I/O
3. **Data sovereignty**: Sensitive data doesn't leave network until synced
4. **Cost efficiency**: Batch uploads cheaper than individual events
5. **Privacy**: Can filter sensitive data before upload

### Why Opt-Out (Not Opt-In)?

**Alternative**: Developers opt in to monitoring

**Chosen approach**: Organization-wide monitoring, opt-out controlled by CISO

**Rationale**:
1. **Compliance requirement**: Mandatory controls can't be optional
2. **Security effectiveness**: Attackers don't opt in to monitoring
3. **Audit completeness**: Can't have gaps in audit trail
4. **CISO authority**: Security decisions made by security team, not individuals
5. **Legal basis**: Employer-provided machines, monitoring is standard

**Important**: Clear communication to developers that monitoring is active, what is collected, and privacy protections.

### Alignment with Enterprise Needs

This system addresses:
- **Detective controls**: Complement preventive governance with detection
- **Compliance requirements**: Meet audit trail and logging mandates
- **Incident response**: Enable fast investigation and remediation
- **Risk management**: Identify and mitigate threats proactively
- **Policy optimization**: Data-driven insights into policy effectiveness

## Consequences

### Benefits

1. **Complete visibility**: No blind spots in developer command activity
2. **Rapid threat detection**: Rogue machines identified within minutes
3. **Compliance automation**: Audit trails automatically generated
4. **Incident forensics**: Full reconstruction capability for security events
5. **Policy optimization**: Data-driven refinement of governance rules
6. **Agent safety**: Monitor and control autonomous agent behavior
7. **Risk quantification**: Measure and report on security posture
8. **Insider threat detection**: Identify anomalous developer behavior

### Trade-offs

1. **Privacy concerns**: Monitoring all developer commands raises privacy questions
   - **Mitigation**: Transparent communication, PII filtering, access controls

2. **Performance overhead**: Every command inspected adds latency
   - **Mitigation**: Async processing, local buffering, <1ms overhead target

3. **Storage costs**: Large volumes of event data to store
   - **Mitigation**: Retention policies, data aggregation, efficient compression

4. **Network bandwidth**: Continuous event sync consumes bandwidth
   - **Mitigation**: Batching, compression, delta uploads, local caching

5. **Developer trust**: Monitoring can feel invasive if not communicated well
   - **Mitigation**: Transparency, clear policies, privacy protections, opt-out option

6. **Alert fatigue**: Too many alerts reduce effectiveness
   - **Mitigation**: Intelligent thresholds, ML-based anomaly detection, alert tuning

7. **Data security**: Audit logs contain sensitive commands and data
   - **Mitigation**: Encryption at rest and in transit, access controls, PII redaction

### Risks

1. **Monitoring bypass**: Developers disable or circumvent monitoring
   - **Mitigation**: Tamper detection, system-level installation, quarantine on disable

2. **Data breach**: Audit logs stolen, exposing organization secrets
   - **Mitigation**: Encryption, access controls, network segmentation, monitoring of monitors

3. **False positives**: Legitimate commands flagged as violations
   - **Mitigation**: Machine learning tuning, exception workflows, feedback loops

4. **Scalability**: Event volume overwhelms collection infrastructure
   - **Mitigation**: Horizontal scaling, efficient storage, data sampling options

5. **Compliance gaps**: Audit logs don't meet specific regulatory requirements
   - **Mitigation**: Configurable retention, immutable logs, compliance expert review

6. **Privacy violations**: Monitoring captures personal/sensitive information
   - **Mitigation**: PII detection and redaction, clear policies, legal review

## Alternatives Considered

### Alternative 1: Monitoring Only cmdai Commands
- **Description**: Only log commands generated by cmdai, not all terminal activity
- **Pros**: Less invasive, simpler implementation, lower data volume
- **Cons**: Easy to bypass, incomplete audit trail, doesn't meet compliance needs
- **Why not chosen**: Doesn't solve the core visibility problem

### Alternative 2: Agent-Based Monitoring (No Terminal Injection)
- **Description**: Separate monitoring agent, no shell integration
- **Pros**: Clean separation, easier to disable, less intrusive
- **Cons**: Can be bypassed, requires separate invocation, not automatic
- **Why not chosen**: Doesn't provide comprehensive coverage

### Alternative 3: Network-Level Monitoring
- **Description**: Monitor commands via network traffic analysis
- **Pros**: Can't be disabled by user, no client installation
- **Cons**: Encrypted traffic is opaque, can't see local commands, privacy issues
- **Why not chosen**: Incomplete visibility, significant privacy concerns

### Alternative 4: SaaS-Only Event Collection
- **Description**: All events stream directly to cloud, no local buffering
- **Pros**: Simpler architecture, real-time visibility, no local storage
- **Cons**: Requires constant connectivity, data sovereignty issues, higher bandwidth
- **Why not chosen**: Conflicts with offline work and data sovereignty requirements

### Alternative 5: Manual Audit Log Reviews
- **Description**: Developers manually report significant commands
- **Pros**: Very low overhead, developer autonomy
- **Cons**: Unreliable, easily forgotten, not suitable for compliance
- **Why not chosen**: Doesn't meet audit or security requirements

## Implementation Notes

### Phase 1: Local Monitoring Agent (3 months)

**Deliverables**:
- Shell integration hooks (bash, zsh, fish)
- Local event collection daemon
- SQLite event buffer
- Basic policy evaluation on command execution
- Local event viewer CLI

**Technical Components**:
```rust
// Monitoring daemon
pub struct MonitoringAgent {
    event_buffer: SqliteEventStore,
    policy_evaluator: PolicyEvaluator,
    sync_client: Option<SyncClient>,
}

impl MonitoringAgent {
    pub async fn inspect_command(&self, cmd: &str) -> MonitorDecision {
        // 1. Parse command
        // 2. Evaluate against policy
        // 3. Log event to buffer
        // 4. Return decision (allow/block/flag)
    }
}
```

**Testing**:
- Unit tests for event capture
- Integration tests with various shells
- Performance benchmarks (< 1ms overhead)

### Phase 2: Event Collection Infrastructure (3 months)

**Deliverables**:
- Event collection API (REST + gRPC)
- Kafka/Kinesis message queue
- Time-series database (InfluxDB or TimescaleDB)
- Elasticsearch for search indexing
- Basic dashboard for event viewing

**Infrastructure**:
```yaml
# Kubernetes deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cmdai-event-collector
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: collector
        image: cmdai/event-collector:1.0
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
        env:
        - name: KAFKA_BROKERS
          value: "kafka:9092"
        - name: STORAGE_BACKEND
          value: "timescaledb"
```

### Phase 3: CISO Dashboard and Alerting (3 months)

**Deliverables**:
- Web-based dashboard (React/Next.js)
- Real-time event streaming (WebSockets)
- Alert rule engine
- Notification integrations (Slack, PagerDuty, email)
- Search and filtering UI
- Compliance report generation

**Features**:
- Live monitoring view
- Historical search and replay
- Alert configuration interface
- User/machine drill-down views
- Custom report builder

### Phase 4: Advanced Analytics (3 months)

**Deliverables**:
- Machine learning anomaly detection
- Behavioral baselining per user/team
- Risk scoring engine
- Trend analysis and forecasting
- Compliance dashboards (SOC2, ISO27001)
- Integration with SIEM platforms

**ML Models**:
- Unusual command frequency detection
- Anomalous command patterns
- Time-of-day anomalies
- User behavior profiling
- Threat intelligence correlation

### Rollout Strategy

1. **Alpha**: Internal testing with cmdai team (1 month)
   - Validate monitoring overhead
   - Test event collection at scale
   - Refine alert rules

2. **Beta**: 5 design partner enterprises (3 months)
   - Deploy to subset of developers
   - Gather feedback on privacy and UX
   - Tune anomaly detection models

3. **Limited GA**: 20 early adopters (3 months)
   - Full organizational deployments
   - Validate compliance use cases
   - Optimize infrastructure costs

4. **General Availability**: Broad release
   - Self-service onboarding
   - Comprehensive documentation
   - Scalability testing (10,000+ developers)

### Privacy and Legal Considerations

**Developer Communication**:
- Clear notification that monitoring is active
- Documentation of what is collected and why
- Explanation of data retention and access controls
- Contact for privacy questions or concerns

**Data Minimization**:
- Filter out PII before upload (credit cards, SSNs, passwords)
- Redact sensitive arguments (API keys, tokens)
- Configurable sensitive path exclusions
- Option to disable monitoring for specific directories

**Access Controls**:
- Role-based access to audit logs (CISO, Security Team, Compliance)
- Audit trail of who accessed audit logs (meta-monitoring)
- Time-limited access grants
- Legal hold capabilities for investigations

**Data Retention**:
- Configurable retention periods (default: 1 year)
- Automated deletion after retention period
- Compliance hold exceptions
- Secure deletion verification

## Success Metrics

### Technical Metrics
- **Event capture rate**: 100% of terminal commands (no drops)
- **Monitoring overhead**: < 1ms latency added to command execution (p95)
- **Event sync reliability**: 99.9% of events successfully synced within 5 minutes
- **Dashboard performance**: < 2 seconds to load real-time view
- **Search performance**: < 1 second for most queries, < 10 seconds for complex

### Security Metrics
- **Rogue machine detection time**: < 10 minutes from first violation to alert
- **False positive rate**: < 1% of alerts are false positives (after tuning)
- **Incident investigation time**: 80% reduction in time to identify patient zero
- **Policy violation rate**: < 0.5% of commands violate policy (after stabilization)

### Business Metrics
- **Compliance pass rate**: 100% of audits pass with cmdai audit evidence
- **Customer satisfaction**: NPS > 50 for monitoring features
- **Adoption rate**: 90% of enterprise customers enable monitoring
- **Renewal correlation**: Customers using monitoring have 95%+ renewal rate

### Privacy Metrics
- **PII detection accuracy**: > 99% of known PII patterns detected and redacted
- **Developer complaints**: < 5% of developers report privacy concerns
- **Transparency score**: > 90% of developers understand what is monitored

## Business Implications

### Revenue Impact

**Monitoring as Premium Tier**:
- **Basic** (no monitoring): $5K/year
- **Standard** (monitoring + basic alerts): $50K/year
- **Enterprise** (monitoring + advanced analytics + SIEM): $250K+/year

**Attach Rate**: Expect 80%+ of enterprise customers to adopt monitoring (key differentiator)

**Upsell Opportunity**: Customers start with governance, upgrade to monitoring for compliance

### Market Differentiation

**Unique Positioning**:
- **Only solution** combining AI governance + terminal monitoring + audit trails
- **Comprehensive coverage**: Commands generated by AI or typed manually
- **Agent-aware**: First tool to monitor autonomous agent behavior
- **Compliance-ready**: Pre-mapped to SOC2, ISO27001, HIPAA controls

### Customer Value Proposition

**ROI Calculation**:
- **Cost of security incident**: $4M average (IBM Security Report 2024)
- **Cost of cmdai enterprise**: $50K-$250K/year
- **Payback period**: Prevent one incident every 16-80 years to break even
- **Realistic**: 1-2 prevented incidents per year = 20-40x ROI

**Compliance Cost Savings**:
- **Manual audit log collection**: 40 hours/quarter (analyst time)
- **cmdai automation**: < 1 hour/quarter (generate reports)
- **Savings**: $15K-$30K/year in audit prep costs

### Competitive Moats

1. **First-mover advantage**: No competitors in AI command monitoring space
2. **Data network effects**: More usage â†’ better anomaly detection models
3. **Compliance head start**: Pre-built compliance mappings and reports
4. **Integration depth**: Terminal-level integration difficult to replicate
5. **Community foundation**: Trust advantage from open-source heritage

## References

- **Industry Standards**:
  - [NIST SP 800-92: Guide to Computer Security Log Management](https://csrc.nist.gov/publications/detail/sp/800-92/final)
  - [ISO/IEC 27001:2022 - A.12.4: Logging and Monitoring](https://www.iso.org/standard/27001)
  - [CIS Controls v8 - Control 8: Audit Log Management](https://www.cisecurity.org/controls/)

- **Compliance Frameworks**:
  - [SOC 2 Trust Service Criteria](https://www.aicpa.org/soc)
  - [HIPAA Security Rule Â§164.308(a)(5)(ii)(C)](https://www.hhs.gov/hipaa/for-professionals/security/index.html)
  - [PCI-DSS v4.0 - Requirement 10](https://www.pcisecuritystandards.org/)

- **Research and Inspiration**:
  - [Splunk: Security Information and Event Management](https://www.splunk.com/en_us/software/enterprise-security.html)
  - [Datadog: Security Monitoring](https://www.datadoghq.com/product/security-monitoring/)
  - [Osquery: SQL-based Operating System Instrumentation](https://osquery.io/)

- **Related ADRs**:
  - ADR-001: Enterprise vs Community Architecture (defines plugin model)
  - ADR-002: Governance and Provisioning System (preventive controls)

- **Privacy and Legal**:
  - [GDPR: Employee Monitoring Guidelines](https://gdpr.eu/employee-monitoring/)
  - [CCPA: California Consumer Privacy Act](https://oag.ca.gov/privacy/ccpa)

## Revision History

| Date | Author | Changes |
|------|--------|---------|
| 2025-11-29 | cmdai core team | Initial draft |
