---
description: "Work package task list for feature 002-unquoted-cli-arguments"
---

# Work Packages: Unquoted CLI Arguments

**Inputs**: Design documents from `kitty-specs/002-unquoted-cli-arguments/`
**Prerequisites**: plan.md, spec.md, research.md, data-model.md, contracts/, quickstart.md

**Tests**: Comprehensive test coverage required per constitution (TDD with RED-GREEN-REFACTOR).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; keep deep implementation detail inside the prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Single project**: `src/main.rs`, `src/cli/mod.rs`, `tests/`
- Adjust paths to match the implementation plan.

---

## Work Package WP01: CLI Argument Parsing Setup (Priority: P0)

**Goal**: Configure clap to accept trailing variable arguments for unquoted prompts.
**Independent Test**: `caro list files` successfully parses arguments without errors, collecting ["list", "files"] in trailing_args.
**Prompt**: `tasks/planned/WP01-cli-argument-parsing-setup.md`

### Included Subtasks
- [x] T001 Update CliArgs struct with trailing_var_arg configuration in `src/cli/mod.rs`
- [x] T002 Add `trailing_args: Vec<String>` field to CliArgs
- [x] T003 Configure clap with `#[arg(trailing_var_arg = true, num_args = 0..)]`
- [x] T004 [P] Write contract tests for basic argument parsing in `tests/cli_interface_contract.rs`

### Implementation Notes
- Follow contract: `contracts/cli-argument-parsing.contract.md`
- Use TDD: Write failing tests first (RED), then implement (GREEN), then refactor
- Verify clap version is 4.5+ in Cargo.toml

### Parallel Opportunities
- T004 (tests) can be written while T001-T003 are being implemented

### Dependencies
- None (starting package).

### Risks & Mitigations
- **Risk**: clap version compatibility â†’ **Mitigation**: Verify 4.5+ before starting
- **Risk**: Breaking existing flags â†’ **Mitigation**: Run existing tests after changes

---

## Work Package WP02: User Story 1 & 2 - Basic Prompts & Backward Compatibility (Priority: P1) ðŸŽ¯ MVP

**Goal**: Enable basic unquoted prompts while maintaining 100% backward compatibility with quoted prompts.
**Independent Test**: Both `caro list files` (unquoted) and `caro "list files"` (quoted) generate commands successfully.
**Prompt**: `tasks/planned/WP02-basic-prompts-and-backward-compat.md`

### Included Subtasks
- [x] T005 Implement trailing args collection and joining with spaces in `src/main.rs`
- [x] T006 Verify quoted prompts still work (shell removes quotes before passing to program)
- [x] T007 [P] Test unquoted prompt: `caro list files` in `tests/e2e_cli_tests.rs`
- [x] T008 [P] Test quoted prompt: `caro "list files"` (backward compatibility)
- [x] T009 [P] Test flags before prompt: `caro --verbose list files`
- [x] T010 [P] Test multi-word prompts: `caro find large files in current directory`
- [x] T011 Run all existing tests to verify no regressions

### Implementation Notes
- Follow contract: `contracts/cli-argument-parsing.contract.md` Rules 1-3, 6
- Join trailing args with spaces: `trailing_args.join(" ")`
- Ensure existing test suite passes unchanged

### Parallel Opportunities
- T007-T010 (tests) can be written and run in parallel

### Dependencies
- Depends on WP01.

### Risks & Mitigations
- **Risk**: Breaking existing workflows â†’ **Mitigation**: T011 validates all existing tests pass
- **Risk**: Special character handling â†’ **Mitigation**: Preserve characters as-is (contract FR-010)

---

## Work Package WP03: Prompt Source Resolution (Priority: P0)

**Goal**: Implement input prioritization logic (flag > stdin > trailing args) with clean separation.
**Independent Test**: Providing multiple input sources respects priority order correctly.
**Prompt**: `tasks/planned/WP03-prompt-source-resolution.md`

### Included Subtasks
- [x] T012 Create `PromptSource` enum (Flag, Stdin, TrailingArgs) in `src/main.rs`
- [x] T013 Implement `resolve_prompt()` function with prioritization logic
- [x] T014 Add stdin availability check using `std::io::IsTerminal`
- [x] T015 [P] Write unit tests for source resolution priority

### Implementation Notes
- Follow contract: `contracts/prompt-source-resolution.contract.md`
- Priority: `-p`/`--prompt` flag (highest) > stdin > trailing arguments
- Make resolution logic a pure function for testability (Library-First principle)

### Parallel Opportunities
- T015 (tests) can be written while implementing T012-T014

### Dependencies
- Depends on WP01 (CliArgs structure must exist).

### Risks & Mitigations
- **Risk**: stdin blocking on non-piped input â†’ **Mitigation**: Use `is_terminal()` check first
- **Risk**: Platform-specific stdin behavior â†’ **Mitigation**: Test on all platforms (WP07)

---

## Work Package WP04: User Story 3 & 4 - Flag and Stdin Input (Priority: P2)

**Goal**: Implement `-p`/`--prompt` flag and stdin piping for automation and pipeline use cases.
**Independent Test**: `caro -p "list files"` and `echo "list files" | caro` both generate commands correctly.
**Prompt**: `tasks/planned/WP04-flag-and-stdin-input.md`

### Included Subtasks
- [x] T016 Add `-p`/`--prompt` flag to CliArgs in `src/cli/mod.rs`
- [x] T017 Implement stdin reading logic (`stdin().read_to_string()`) in `src/main.rs`
- [x] T018 Integrate prompt source resolution in `src/main.rs` main function
- [x] T019 [P] Test `-p` flag: `caro -p "list files"` in `tests/e2e_cli_tests.rs`
- [x] T020 [P] Test stdin: `echo "list files" | caro`
- [x] T021 [P] Test precedence: flag > stdin > trailing args (all combinations)
- [x] T022 Test non-interactive mode (flag skips confirmation per FR-005)

### Implementation Notes
- Follow contracts: `contracts/prompt-source-resolution.contract.md` Rules 2-4
- stdin reading should handle EOF gracefully
- Non-interactive mode: when source is Flag or Stdin, skip confirmation prompts

### Parallel Opportunities
- T019-T021 (tests) can be written and run in parallel

### Dependencies
- Depends on WP03 (prompt source resolution must exist).

### Risks & Mitigations
- **Risk**: stdin hanging on interactive terminals â†’ **Mitigation**: T014 stdin availability check
- **Risk**: Empty stdin edge case â†’ **Mitigation**: Validation layer handles (WP05)

---

## Work Package WP05: Validation & Help Display (Priority: P0)

**Goal**: Validate prompts and show help for empty/whitespace-only input (non-error, user-friendly).
**Independent Test**: `caro` (no args) and `caro   ` (whitespace) both display help message without error.
**Prompt**: `tasks/planned/WP05-validation-and-help-display.md`

### Included Subtasks
- [x] T023 Implement `validate_prompt()` function in `src/main.rs`
- [x] T024 Handle empty string â†’ show help (FR-004)
- [x] T025 Handle whitespace-only â†’ show help (FR-004)
- [x] T026 Preserve special characters (*, ?, ~) per FR-010
- [x] T027 [P] Write validation tests in `tests/execution_prompt_behavior.rs`
- [x] T028 Integrate help display for empty/whitespace cases

### Implementation Notes
- Follow contract: `contracts/validation.contract.md`
- Use `.trim()` to detect whitespace-only
- Help display is not an error (exit code 0, friendly UX)

### Parallel Opportunities
- T027 (tests) can be written while implementing T023-T026

### Dependencies
- Depends on WP03 (needs resolved prompt to validate).

### Risks & Mitigations
- **Risk**: Overly restrictive validation â†’ **Mitigation**: Validation is permissive; only reject empty/whitespace
- **Risk**: Breaking help message format â†’ **Mitigation**: Use existing `print_help()` function

---

## Work Package WP06: User Story 5 - Shell Operator Handling (Priority: P3)

**Goal**: Detect POSIX shell operators and truncate prompt parsing correctly.
**Independent Test**: `caro list files > output.txt` treats "list files" as prompt (shell handles redirection).
**Prompt**: `tasks/planned/WP06-shell-operator-handling.md`

### Included Subtasks
- [x] T029 Implement `truncate_at_shell_operator()` function in `src/cli/mod.rs`
- [x] T030 Define POSIX shell operators array: `&[">", "|", "<", ">>", "2>", "&", ";"]`
- [x] T031 [P] Test all 7 shell operators independently
- [x] T032 [P] Test embedded operators (e.g., "files>output.txt" should NOT truncate)
- [x] T033 [P] Test operator as first argument (should return empty vec)
- [x] T034 [P] Test multiple operators (should stop at first)

### Implementation Notes
- Follow contract: `contracts/shell-operator-detection.contract.md`
- Use `take_while(|arg| !SHELL_OPERATORS.contains(&arg.as_str()))`
- Note: In normal usage, shell handles operators before args reach caro (this is edge case handling)

### Parallel Opportunities
- T031-T034 (tests) can all be written and run in parallel

### Dependencies
- Depends on WP01 (needs trailing_args structure).

### Risks & Mitigations
- **Risk**: Over-detection of operators in prompt text â†’ **Mitigation**: Only detect standalone args, not embedded
- **Risk**: Missing operator variants â†’ **Mitigation**: Follow POSIX spec exactly (7 operators documented)

---

## Work Package WP07: Cross-Platform Testing & PR #68 Fixes (Priority: P1)

**Goal**: Validate all functionality works on Linux, macOS, Windows; fix any identified test failures.
**Independent Test**: Full test suite passes on all platforms without failures.
**Prompt**: `tasks/planned/WP07-cross-platform-testing.md`

### Included Subtasks
- [x] T035 Run full test suite on Linux: `cargo test`
- [x] T036 Run full test suite on macOS (x86_64 + aarch64)
- [x] T037 Run full test suite on Windows
- [x] T038 Investigate and fix any PR #68 test failures identified
- [x] T039 Validate backward compatibility: all existing tests pass unchanged
- [x] T040 Performance benchmark: verify arg parsing < 10ms

### Implementation Notes
- Use CI platform (GitHub Actions) for cross-platform validation
- Reference research.md: PR #68 had failures on all platforms - ensure our implementation avoids same issues
- Run performance benchmarks with `cargo bench` or `hyperfine`

### Parallel Opportunities
- T035-T037 can run in parallel on different CI runners

### Dependencies
- Depends on WP01-WP06 (all implementation must be complete).

### Risks & Mitigations
- **Risk**: Platform-specific arg parsing differences â†’ **Mitigation**: Test stdin, flags, operators on all platforms
- **Risk**: Performance regression â†’ **Mitigation**: T040 benchmarks with <10ms target

---

## Work Package WP08: Documentation & Final Polish (Priority: P2)

**Goal**: Complete documentation, code cleanup, and prepare for merge.
**Independent Test**: CHANGELOG.md accurately describes feature; code passes clippy/fmt checks.
**Prompt**: `tasks/planned/WP08-documentation-and-polish.md`

### Included Subtasks
- [x] T041 Update CHANGELOG.md with feature details and FR/SC references
- [x] T042 [P] Code cleanup: remove dead code, improve readability
- [x] T043 [P] Add inline documentation comments for new functions
- [x] T044 Final review: run `cargo clippy` and `cargo fmt`
- [x] T045 Verify all acceptance criteria from spec.md are met

### Implementation Notes
- CHANGELOG format: Follow existing project conventions
- Code style: Match existing caro patterns (no emojis, clear naming)
- Documentation: Focus on public APIs and non-obvious logic

### Parallel Opportunities
- T042-T043 can proceed in parallel

### Dependencies
- Depends on WP07 (all functionality complete and tested).

### Risks & Mitigations
- **Risk**: Incomplete documentation â†’ **Mitigation**: T045 checklist validates all SC-001 through SC-007
- **Risk**: Clippy warnings â†’ **Mitigation**: Fix all warnings before merge

---

## Dependency & Execution Summary

- **Sequence**:
  - WP01 â†’ WP02 (MVP) â†’ WP03 â†’ WP04 â†’ WP05 â†’ WP06 â†’ WP07 â†’ WP08
  - Foundation packages (WP01, WP03, WP05) enable parallel story work

- **Parallelization**:
  - After WP01: WP02 and WP03 can start (independent concerns)
  - After WP03: WP04, WP05, WP06 can proceed in parallel (different files)
  - Tests within each WP can run in parallel (marked with [P])

- **MVP Scope**:
  - **WP01 + WP02** constitute the minimal viable release
  - Delivers User Story 1 (unquoted prompts) and User Story 2 (backward compatibility)
  - Estimated ~50-75 LOC, ~2-3 hours of focused work

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Update CliArgs struct with trailing_var_arg | WP01 | P0 | No |
| T002 | Add trailing_args field | WP01 | P0 | No |
| T003 | Configure clap | WP01 | P0 | No |
| T004 | Write parsing tests | WP01 | P0 | Yes |
| T005 | Implement arg joining | WP02 | P1 | No |
| T006 | Verify quoted compatibility | WP02 | P1 | No |
| T007 | Test unquoted prompt | WP02 | P1 | Yes |
| T008 | Test quoted prompt | WP02 | P1 | Yes |
| T009 | Test flags before prompt | WP02 | P1 | Yes |
| T010 | Test multi-word prompts | WP02 | P1 | Yes |
| T011 | Run existing tests | WP02 | P1 | No |
| T012 | Create PromptSource enum | WP03 | P0 | No |
| T013 | Implement resolve_prompt | WP03 | P0 | No |
| T014 | Add stdin availability check | WP03 | P0 | No |
| T015 | Write resolution tests | WP03 | P0 | Yes |
| T016 | Add -p/--prompt flag | WP04 | P2 | No |
| T017 | Implement stdin reading | WP04 | P2 | No |
| T018 | Integrate source resolution | WP04 | P2 | No |
| T019 | Test -p flag | WP04 | P2 | Yes |
| T020 | Test stdin | WP04 | P2 | Yes |
| T021 | Test precedence | WP04 | P2 | Yes |
| T022 | Test non-interactive mode | WP04 | P2 | Yes |
| T023 | Implement validate_prompt | WP05 | P0 | No |
| T024 | Handle empty string | WP05 | P0 | No |
| T025 | Handle whitespace-only | WP05 | P0 | No |
| T026 | Preserve special chars | WP05 | P0 | No |
| T027 | Write validation tests | WP05 | P0 | Yes |
| T028 | Integrate help display | WP05 | P0 | No |
| T029 | Implement truncate function | WP06 | P3 | No |
| T030 | Define operators array | WP06 | P3 | No |
| T031 | Test all 7 operators | WP06 | P3 | Yes |
| T032 | Test embedded operators | WP06 | P3 | Yes |
| T033 | Test operator first | WP06 | P3 | Yes |
| T034 | Test multiple operators | WP06 | P3 | Yes |
| T035 | Test on Linux | WP07 | P1 | Yes |
| T036 | Test on macOS | WP07 | P1 | Yes |
| T037 | Test on Windows | WP07 | P1 | Yes |
| T038 | Fix PR #68 failures | WP07 | P1 | No |
| T039 | Validate backward compat | WP07 | P1 | No |
| T040 | Performance benchmark | WP07 | P1 | Yes |
| T041 | Update CHANGELOG | WP08 | P2 | No |
| T042 | Code cleanup | WP08 | P2 | Yes |
| T043 | Add documentation | WP08 | P2 | Yes |
| T044 | Run clippy/fmt | WP08 | P2 | No |
| T045 | Verify acceptance criteria | WP08 | P2 | No |

---

> This task list represents the complete implementation plan for feature 002-unquoted-cli-arguments. Each work package has a corresponding detailed prompt file in `tasks/planned/`. Follow TDD principles (RED-GREEN-REFACTOR) throughout implementation.
