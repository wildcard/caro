# GitHub Action Workflow Contract
# Defines the expected structure and behavior of the translation automation workflow

name: Translate Website Content

on:
  push:
    branches: [main]
    paths:
      - 'website/src/i18n/locales/en/**/*.json'
  workflow_dispatch:
    inputs:
      force_retranslate:
        description: 'Force retranslate all content'
        required: false
        default: 'false'
        type: boolean
      target_locales:
        description: 'Comma-separated locales to translate (empty = all)'
        required: false
        default: ''
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: "translations"
  cancel-in-progress: false

jobs:
  # Job 1: Detect which translation files changed
  detect-changes:
    name: Detect Changed Translation Files
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.changes.outputs.files }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2
      - name: Get changed files
        id: changes
        run: |
          # Git diff to find changed English translation files
          # Output: comma-separated list of file paths
          # Contract: changed_files contains paths relative to repo root

  # Job 2: Translate content for each locale in parallel
  translate:
    name: Translate to ${{ matrix.locale }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      max-parallel: 3  # Rate limiting for OpenAI API
      matrix:
        locale: [es, fr, pt, de, he, ar, uk, ru, ja, ko, hi, ur, fil, id]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: './website/package-lock.json'

      - name: Cache translations
        uses: actions/cache@v5
        with:
          path: .translation-cache
          key: translations-${{ matrix.locale }}-${{ hashFiles('website/src/i18n/locales/en/**') }}

      - name: Install dependencies
        run: npm install openai

      - name: Translate content
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TARGET_LOCALE: ${{ matrix.locale }}
          CHANGED_FILES: ${{ needs.detect-changes.outputs.changed_files }}
        run: node .github/scripts/translate.js

      - name: Upload translation artifacts
        uses: actions/upload-artifact@v6
        with:
          name: translations-${{ matrix.locale }}
          path: website/src/i18n/locales/${{ matrix.locale }}/
          retention-days: 1

  # Job 3: Create pull request with all translations
  create-pr:
    name: Create Translation PR
    runs-on: ubuntu-latest
    needs: translate
    steps:
      - uses: actions/checkout@v6

      - name: Download all translation artifacts
        uses: actions/download-artifact@v6
        with:
          path: translations/
          pattern: translations-*

      - name: Move translations to correct locations
        run: |
          for dir in translations/translations-*; do
            locale=$(basename "$dir" | sed 's/translations-//')
            mkdir -p "website/src/i18n/locales/$locale"
            cp -r "$dir"/* "website/src/i18n/locales/$locale/"
          done

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(i18n): Update translations'
          title: '[i18n] Update translations from English source'
          body: |
            ## Translation Update

            This PR contains automated translations generated by OpenAI GPT-4.

            ### Review Checklist
            - [ ] Spot-check 2-3 translations per language
            - [ ] Verify RTL languages render correctly
            - [ ] Check for placeholder/variable preservation
            - [ ] Review cultural appropriateness
          branch: i18n/update-translations
          delete-branch: true
          labels: |
            i18n
            automated

# Secrets Required:
# - OPENAI_API_KEY: OpenAI API key for GPT-4 access

# Expected Behavior:
# 1. Triggers when English translation files change in main branch
# 2. Detects which files changed
# 3. Runs 14 parallel jobs (one per non-English locale)
# 4. Calls OpenAI GPT-4 API to translate changed strings
# 5. Creates PR with all translations
# 6. PR requires spot-check review before merge
# 7. Estimated run time: 5-10 minutes
# 8. Estimated cost: $4-6 per full translation run
