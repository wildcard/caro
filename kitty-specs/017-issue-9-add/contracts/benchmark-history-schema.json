{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/wildcard/caro/schemas/benchmark-history.json",
  "title": "Benchmark Historical Data",
  "description": "Schema for historical benchmark data storage (FR2.2 - hybrid storage approach)",
  "oneOf": [
    { "$ref": "#/definitions/dailyArtifact" },
    { "$ref": "#/definitions/monthlyAggregate" }
  ],
  "definitions": {
    "dailyArtifact": {
      "title": "Daily Benchmark Artifact",
      "description": "Single-day benchmark results (90-day retention)",
      "type": "object",
      "required": ["artifact_type", "date", "suite"],
      "properties": {
        "artifact_type": {
          "description": "Discriminator for artifact type",
          "type": "string",
          "const": "daily"
        },
        "date": {
          "description": "Execution date (YYYY-MM-DD)",
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
        },
        "suite": {
          "description": "Full benchmark suite results",
          "$ref": "#/definitions/benchmarkSuite"
        }
      }
    },
    "monthlyAggregate": {
      "title": "Monthly Benchmark Aggregate",
      "description": "Month-aggregated historical data (indefinite retention)",
      "type": "object",
      "required": ["artifact_type", "month", "runs", "summary"],
      "properties": {
        "artifact_type": {
          "description": "Discriminator for artifact type",
          "type": "string",
          "const": "monthly"
        },
        "month": {
          "description": "Month identifier (YYYY-MM)",
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}$"
        },
        "runs": {
          "description": "All daily runs for the month (sorted by date)",
          "type": "array",
          "items": {
            "$ref": "#/definitions/dailyRun"
          },
          "minItems": 1
        },
        "summary": {
          "description": "Monthly summary statistics",
          "$ref": "#/definitions/monthlySummary"
        }
      }
    },
    "benchmarkSuite": {
      "type": "object",
      "required": [
        "timestamp",
        "commit",
        "branch",
        "environment",
        "benchmarks",
        "total_duration"
      ],
      "properties": {
        "timestamp": {
          "description": "ISO 8601 timestamp",
          "type": "string",
          "format": "date-time"
        },
        "commit": {
          "description": "Git commit SHA",
          "type": "string",
          "pattern": "^[0-9a-f]{40}$"
        },
        "branch": {
          "description": "Git branch name",
          "type": "string"
        },
        "environment": {
          "description": "Execution environment",
          "$ref": "#/definitions/environment"
        },
        "benchmarks": {
          "description": "All benchmark results",
          "type": "array",
          "items": {
            "$ref": "#/definitions/benchmarkResult"
          },
          "minItems": 1
        },
        "total_duration": {
          "description": "Total suite execution time",
          "$ref": "#/definitions/duration"
        }
      }
    },
    "benchmarkResult": {
      "type": "object",
      "required": ["id", "mean", "std_dev", "median", "sample_size"],
      "properties": {
        "id": {
          "description": "Benchmark identifier (e.g., 'cache/get_model')",
          "type": "string"
        },
        "mean": {
          "description": "Mean execution time",
          "$ref": "#/definitions/duration"
        },
        "std_dev": {
          "description": "Standard deviation",
          "$ref": "#/definitions/duration"
        },
        "median": {
          "description": "Median execution time",
          "$ref": "#/definitions/duration"
        },
        "percentiles": {
          "description": "Performance percentiles",
          "$ref": "#/definitions/percentiles"
        },
        "memory": {
          "description": "Memory statistics (optional, for context benchmarks)",
          "$ref": "#/definitions/memoryStats"
        },
        "sample_size": {
          "description": "Number of samples",
          "type": "integer",
          "minimum": 100
        },
        "outliers": {
          "description": "Outlier statistics",
          "$ref": "#/definitions/outlierStats"
        }
      }
    },
    "dailyRun": {
      "type": "object",
      "required": ["date", "commit", "benchmarks"],
      "properties": {
        "date": {
          "description": "Run date (YYYY-MM-DD)",
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
        },
        "commit": {
          "description": "Git commit SHA",
          "type": "string",
          "pattern": "^[0-9a-f]{40}$"
        },
        "benchmarks": {
          "description": "Benchmark results (abbreviated)",
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/benchmarkSummary"
          }
        }
      }
    },
    "benchmarkSummary": {
      "description": "Abbreviated benchmark result for monthly aggregates",
      "type": "object",
      "required": ["mean", "stddev"],
      "properties": {
        "mean": {
          "$ref": "#/definitions/duration"
        },
        "stddev": {
          "$ref": "#/definitions/duration"
        }
      }
    },
    "monthlySummary": {
      "type": "object",
      "required": ["total_runs", "benchmarks"],
      "properties": {
        "total_runs": {
          "description": "Number of runs in the month",
          "type": "integer",
          "minimum": 1
        },
        "benchmarks": {
          "description": "Trend analysis per benchmark",
          "type": "array",
          "items": {
            "$ref": "#/definitions/benchmarkTrend"
          }
        }
      }
    },
    "benchmarkTrend": {
      "type": "object",
      "required": [
        "id",
        "mean_of_means",
        "trend_direction",
        "max_regression",
        "max_improvement"
      ],
      "properties": {
        "id": {
          "description": "Benchmark identifier",
          "type": "string"
        },
        "mean_of_means": {
          "description": "Average of all means for the month",
          "$ref": "#/definitions/duration"
        },
        "trend_direction": {
          "description": "Overall trend",
          "type": "string",
          "enum": ["improving", "stable", "degrading"]
        },
        "max_regression": {
          "description": "Largest regression percentage in month",
          "type": "number",
          "minimum": 0
        },
        "max_improvement": {
          "description": "Largest improvement percentage in month",
          "type": "number",
          "minimum": 0
        },
        "variance": {
          "description": "Variance across all runs",
          "type": "number",
          "minimum": 0
        }
      }
    },
    "duration": {
      "type": "object",
      "required": ["value", "unit"],
      "properties": {
        "value": {
          "type": "number",
          "exclusiveMinimum": 0
        },
        "unit": {
          "type": "string",
          "enum": ["ns", "us", "ms", "s", "min"]
        }
      }
    },
    "percentiles": {
      "type": "object",
      "required": ["p50", "p75", "p95", "p99"],
      "properties": {
        "p50": { "$ref": "#/definitions/duration" },
        "p75": { "$ref": "#/definitions/duration" },
        "p95": { "$ref": "#/definitions/duration" },
        "p99": { "$ref": "#/definitions/duration" }
      }
    },
    "memoryStats": {
      "type": "object",
      "required": ["total_allocations", "total_bytes", "peak_bytes"],
      "properties": {
        "total_allocations": {
          "type": "integer",
          "minimum": 0
        },
        "total_bytes": {
          "type": "integer",
          "minimum": 0
        },
        "peak_bytes": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "outlierStats": {
      "type": "object",
      "required": ["low_severe", "low_mild", "high_mild", "high_severe"],
      "properties": {
        "low_severe": { "type": "integer", "minimum": 0 },
        "low_mild": { "type": "integer", "minimum": 0 },
        "high_mild": { "type": "integer", "minimum": 0 },
        "high_severe": { "type": "integer", "minimum": 0 }
      }
    },
    "environment": {
      "type": "object",
      "required": ["os", "os_version", "cpu", "cpu_cores", "memory_gb", "rust_version"],
      "properties": {
        "os": {
          "type": "string"
        },
        "os_version": {
          "type": "string"
        },
        "cpu": {
          "type": "string"
        },
        "cpu_cores": {
          "type": "integer",
          "minimum": 1
        },
        "memory_gb": {
          "type": "integer",
          "minimum": 1
        },
        "rust_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        }
      }
    }
  },
  "examples": [
    {
      "_comment": "Example 1: Daily Artifact",
      "artifact_type": "daily",
      "date": "2026-01-08",
      "suite": {
        "timestamp": "2026-01-08T15:30:00Z",
        "commit": "abc123def456789012345678901234567890abcd",
        "branch": "main",
        "environment": {
          "os": "macos",
          "os_version": "14.2",
          "cpu": "Apple M1",
          "cpu_cores": 8,
          "memory_gb": 16,
          "rust_version": "1.75.0"
        },
        "benchmarks": [
          {
            "id": "cache/get_model",
            "mean": { "value": 45.2, "unit": "ns" },
            "std_dev": { "value": 2.1, "unit": "ns" },
            "median": { "value": 44.8, "unit": "ns" },
            "sample_size": 10000
          }
        ],
        "total_duration": { "value": 8.5, "unit": "min" }
      }
    },
    {
      "_comment": "Example 2: Monthly Aggregate",
      "artifact_type": "monthly",
      "month": "2026-01",
      "runs": [
        {
          "date": "2026-01-01",
          "commit": "abc123def456789012345678901234567890abcd",
          "benchmarks": {
            "cache/get_model": {
              "mean": { "value": 46.3, "unit": "ns" },
              "stddev": { "value": 2.3, "unit": "ns" }
            }
          }
        },
        {
          "date": "2026-01-08",
          "commit": "def456abc789012345678901234567890abcdef12",
          "benchmarks": {
            "cache/get_model": {
              "mean": { "value": 45.2, "unit": "ns" },
              "stddev": { "value": 2.1, "unit": "ns" }
            }
          }
        }
      ],
      "summary": {
        "total_runs": 5,
        "benchmarks": [
          {
            "id": "cache/get_model",
            "mean_of_means": { "value": 46.3, "unit": "ns" },
            "trend_direction": "stable",
            "max_regression": 3.2,
            "max_improvement": 2.1,
            "variance": 1.8
          }
        ]
      }
    }
  ]
}
