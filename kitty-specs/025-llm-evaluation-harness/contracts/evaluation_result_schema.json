{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/wildcard/caro/schemas/evaluation_result.json",
  "title": "EvaluationResult",
  "description": "Complete evaluation metrics and failed case details from LLM evaluation harness",
  "type": "object",
  "required": [
    "timestamp",
    "caro_version",
    "backend",
    "csr",
    "safety_accuracy",
    "posix_compliance_rate",
    "per_category",
    "failed_cases"
  ],
  "properties": {
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of evaluation run (e.g., 2026-01-09T12:34:56Z)",
      "examples": ["2026-01-09T12:34:56Z"]
    },
    "caro_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of caro (from Cargo.toml)",
      "examples": ["1.1.0", "1.2.0"]
    },
    "backend": {
      "type": "string",
      "enum": ["mlx", "vllm", "ollama"],
      "description": "Backend used for command generation",
      "examples": ["mlx"]
    },
    "csr": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0,
      "description": "Command Success Rate (0.0-1.0) - north star metric from ROADMAP.md (baseline: 0.948)",
      "examples": [0.948, 0.92, 0.88]
    },
    "safety_accuracy": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0,
      "description": "Safety detection accuracy (0.0-1.0) - percentage of correct safety classifications (target: 1.0)",
      "examples": [1.0, 0.95]
    },
    "posix_compliance_rate": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0,
      "description": "POSIX compliance detection accuracy (0.0-1.0) - percentage of correct POSIX validation (target: â‰¥0.95)",
      "examples": [0.96, 0.92]
    },
    "per_category": {
      "type": "object",
      "description": "Per-category breakdown of test results",
      "additionalProperties": {
        "type": "object",
        "required": ["total", "passed", "rate"],
        "properties": {
          "total": {
            "type": "integer",
            "minimum": 0,
            "description": "Total number of tests in this category"
          },
          "passed": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of tests that passed in this category"
          },
          "rate": {
            "type": "number",
            "minimum": 0.0,
            "maximum": 1.0,
            "description": "Success rate for this category (passed / total)"
          }
        }
      },
      "examples": [
        {
          "correctness": {
            "total": 40,
            "passed": 38,
            "rate": 0.95
          },
          "safety": {
            "total": 8,
            "passed": 8,
            "rate": 1.0
          },
          "posix": {
            "total": 12,
            "passed": 11,
            "rate": 0.917
          }
        }
      ]
    },
    "failed_cases": {
      "type": "array",
      "description": "Detailed information about each failed test case",
      "items": {
        "type": "object",
        "required": ["test_id", "prompt", "expected", "actual", "reason"],
        "properties": {
          "test_id": {
            "type": "string",
            "description": "Unique identifier from test dataset (e.g., 'find_text_02')",
            "examples": ["list_all_files_01", "dangerous_rm_01", "bash_array_01"]
          },
          "prompt": {
            "type": "string",
            "description": "Natural language prompt given to LLM",
            "examples": ["list all files", "delete everything", "find error in logs"]
          },
          "expected": {
            "type": "string",
            "description": "Expected shell command from test dataset",
            "examples": ["ls -la", "rm -rf /", "grep -r 'error' logs/"]
          },
          "actual": {
            "type": "string",
            "description": "Actual command generated by LLM backend",
            "examples": ["ls -l -a", "rm -rf /*", "find logs/ -type f -exec grep 'error' {} \\;"]
          },
          "reason": {
            "type": "object",
            "description": "Failure reason with discriminator type field",
            "required": ["type"],
            "oneOf": [
              {
                "type": "object",
                "properties": {
                  "type": {
                    "const": "incorrect_command",
                    "description": "Generated command doesn't match expected (after normalization)"
                  }
                },
                "required": ["type"]
              },
              {
                "type": "object",
                "properties": {
                  "type": {
                    "const": "safety_mismatch",
                    "description": "Safety detection mismatch (false positive or false negative)"
                  },
                  "expected": {
                    "type": "boolean",
                    "description": "Expected safety label (true = safe, false = unsafe)"
                  },
                  "actual": {
                    "type": "boolean",
                    "description": "Actual safety detection result"
                  }
                },
                "required": ["type", "expected", "actual"]
              },
              {
                "type": "object",
                "properties": {
                  "type": {
                    "const": "posix_mismatch",
                    "description": "POSIX compliance detection mismatch"
                  },
                  "expected": {
                    "type": "boolean",
                    "description": "Expected POSIX compliance (true = compliant, false = shell-specific)"
                  },
                  "actual": {
                    "type": "boolean",
                    "description": "Actual POSIX compliance detection result"
                  }
                },
                "required": ["type", "expected", "actual"]
              },
              {
                "type": "object",
                "properties": {
                  "type": {
                    "const": "backend_error",
                    "description": "Backend error (timeout, API failure, etc.)"
                  },
                  "message": {
                    "type": "string",
                    "description": "Error message from backend"
                  }
                },
                "required": ["type", "message"]
              }
            ],
            "examples": [
              { "type": "incorrect_command" },
              { "type": "safety_mismatch", "expected": false, "actual": true },
              { "type": "posix_mismatch", "expected": true, "actual": false },
              { "type": "backend_error", "message": "Request timeout after 30s" }
            ]
          }
        }
      },
      "examples": [
        [
          {
            "test_id": "find_text_02",
            "prompt": "find error in logs recursively",
            "expected": "grep -r 'error' logs/",
            "actual": "find logs/ -type f -exec grep 'error' {} \\;",
            "reason": { "type": "incorrect_command" }
          }
        ]
      ]
    }
  },
  "examples": [
    {
      "timestamp": "2026-01-09T12:34:56Z",
      "caro_version": "1.1.0",
      "backend": "mlx",
      "csr": 0.948,
      "safety_accuracy": 1.0,
      "posix_compliance_rate": 0.917,
      "per_category": {
        "correctness": {
          "total": 40,
          "passed": 38,
          "rate": 0.95
        },
        "safety": {
          "total": 8,
          "passed": 8,
          "rate": 1.0
        },
        "posix": {
          "total": 12,
          "passed": 11,
          "rate": 0.917
        }
      },
      "failed_cases": [
        {
          "test_id": "find_text_02",
          "prompt": "find error in logs recursively",
          "expected": "grep -r 'error' logs/",
          "actual": "find logs/ -type f -exec grep 'error' {} \\;",
          "reason": { "type": "incorrect_command" }
        }
      ]
    }
  ]
}
