---
// CaroGame.astro - Atari-style arcade game where Caro catches falling commands
---

<section id="game" class="game-section">
  <div class="container">
    <h2>Play with Caro</h2>
    <p class="section-subtitle">
      Help Caro fetch the safe commands! Avoid the dangerous ones.
    </p>

    <div class="game-wrapper">
      <div class="arcade-cabinet">
        <div class="cabinet-top">
          <div class="score-display">
            <span class="label">SCORE</span>
            <span id="score" class="value">0000</span>
          </div>
          <div class="title-display">CARO FETCH</div>
          <div class="score-display">
            <span class="label">HIGH</span>
            <span id="high-score" class="value">0000</span>
          </div>
        </div>

        <div class="lives-display">
          <span id="lives">
            <span class="life">üêï</span>
            <span class="life">üêï</span>
            <span class="life">üêï</span>
          </span>
        </div>

        <div id="game-screen" class="game-screen">
          <div class="scanlines"></div>
          <div id="caro" class="caro"></div>

          <div id="overlay" class="overlay">
            <div class="overlay-box">
              <div id="overlay-title" class="title">CARO FETCH</div>
              <div class="instructions">
                <p>Catch safe commands, avoid dangerous ones!</p>
              </div>
              <div class="command-legend">
                <div class="legend-row"><span class="cmd-preview safe">$ ls -la</span><span>+10</span></div>
                <div class="legend-row"><span class="cmd-preview bonus">$ git commit</span><span>+25</span></div>
                <div class="legend-row"><span class="cmd-preview danger">$ rm -rf /</span><span>-1 ‚ù§Ô∏è</span></div>
              </div>
              <button id="start-btn" class="start-btn">INSERT COIN</button>
              <p class="hint">‚Üê ‚Üí or A/D to move | SPACE to start</p>
            </div>
          </div>
        </div>

        <div class="game-controls">
          <button id="left-btn" class="ctrl-btn">‚óÄ</button>
          <button id="right-btn" class="ctrl-btn">‚ñ∂</button>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .game-section {
    background: var(--color-bg-secondary);
    padding: 80px 20px;
  }

  .game-wrapper {
    display: flex;
    justify-content: center;
  }

  .arcade-cabinet {
    background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 0 0 4px #ff8c42, 0 0 40px rgba(255, 140, 66, 0.3);
    max-width: 700px;
    width: 100%;
  }

  .cabinet-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    margin-bottom: 8px;
  }

  .score-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: 'Courier New', monospace;
  }

  .score-display .label {
    font-size: 11px;
    color: #ff8c42;
    letter-spacing: 2px;
  }

  .score-display .value {
    font-size: 22px;
    color: #fff;
    font-weight: bold;
    text-shadow: 0 0 10px rgba(255, 140, 66, 0.8);
  }

  .title-display {
    font-size: 24px;
    font-weight: bold;
    color: #ff8c42;
    text-shadow: 0 0 15px rgba(255, 140, 66, 0.8);
    letter-spacing: 4px;
    font-family: 'Courier New', monospace;
  }

  .lives-display {
    text-align: center;
    padding: 6px;
    font-size: 22px;
  }

  .lives-display .life {
    margin: 0 3px;
    transition: all 0.3s;
    display: inline-block;
  }

  .lives-display .life.lost {
    opacity: 0.15;
    transform: scale(0.6);
  }

  .game-screen {
    position: relative;
    width: 100%;
    height: 480px;
    background: radial-gradient(ellipse at center, #0a0a12 0%, #000 100%);
    border: 3px solid #333;
    border-radius: 6px;
    overflow: hidden;
  }

  .scanlines {
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent 0px,
      transparent 2px,
      rgba(0, 0, 0, 0.1) 2px,
      rgba(0, 0, 0, 0.1) 4px
    );
    pointer-events: none;
    z-index: 1000;
  }

  .caro {
    position: absolute;
    bottom: 15px;
    width: 64px;
    height: 64px;
    background-image: url('/caro-pixel.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    image-rendering: pixelated;
    filter: drop-shadow(0 0 12px rgba(255, 140, 66, 0.6));
    z-index: 10;
    transition: left 0.05s linear;
  }

  .caro.flash {
    filter: drop-shadow(0 0 20px #fff) brightness(1.5);
  }

  .caro.hurt {
    animation: shake 0.3s ease-out;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }

  /* Falling command items */
  .falling-cmd {
    position: absolute;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    font-weight: bold;
    padding: 8px 14px;
    border-radius: 6px;
    white-space: nowrap;
    z-index: 5;
    pointer-events: none;
  }

  .falling-cmd.safe {
    background: linear-gradient(180deg, #252530 0%, #15151f 100%);
    border: 2px solid #ff8c42;
    color: #ff8c42;
    box-shadow: 0 0 12px rgba(255, 140, 66, 0.5), inset 0 1px 0 rgba(255,255,255,0.1);
  }

  .falling-cmd.bonus {
    background: linear-gradient(180deg, #1a2f1a 0%, #0a1f0a 100%);
    border: 2px solid #2ecc71;
    color: #2ecc71;
    box-shadow: 0 0 16px rgba(46, 204, 113, 0.6), inset 0 1px 0 rgba(255,255,255,0.1);
    animation: glow-green 0.5s ease-in-out infinite alternate;
  }

  @keyframes glow-green {
    from { box-shadow: 0 0 12px rgba(46, 204, 113, 0.5); }
    to { box-shadow: 0 0 22px rgba(46, 204, 113, 0.9); }
  }

  .falling-cmd.danger {
    background: linear-gradient(180deg, #2f1a1a 0%, #1f0a0a 100%);
    border: 2px solid #e74c3c;
    color: #e74c3c;
    box-shadow: 0 0 16px rgba(231, 76, 60, 0.6), inset 0 1px 0 rgba(255,255,255,0.1);
    animation: glow-red 0.3s ease-in-out infinite alternate;
  }

  @keyframes glow-red {
    from { box-shadow: 0 0 12px rgba(231, 76, 60, 0.5); }
    to { box-shadow: 0 0 24px rgba(231, 76, 60, 1); }
  }

  .falling-cmd::before {
    content: '$ ';
    opacity: 0.6;
  }

  /* Score popup */
  .popup {
    position: absolute;
    font-family: 'Courier New', monospace;
    font-size: 22px;
    font-weight: bold;
    pointer-events: none;
    z-index: 100;
    text-shadow: 0 0 10px currentColor;
  }

  /* Overlay */
  .overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 500;
  }

  .overlay.hidden { display: none; }

  .overlay-box {
    text-align: center;
    color: #fff;
    font-family: 'Courier New', monospace;
  }

  .overlay-box .title {
    font-size: 32px;
    color: #ff8c42;
    margin-bottom: 15px;
    text-shadow: 0 0 20px rgba(255, 140, 66, 0.8);
    letter-spacing: 3px;
  }

  .overlay-box .instructions {
    margin-bottom: 20px;
    color: #aaa;
  }

  .command-legend {
    margin-bottom: 25px;
  }

  .legend-row {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin: 8px 0;
    font-size: 14px;
  }

  .cmd-preview {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 4px;
    min-width: 90px;
    text-align: left;
  }

  .cmd-preview.safe {
    background: #15151f;
    border: 2px solid #ff8c42;
    color: #ff8c42;
  }

  .cmd-preview.bonus {
    background: #0a1f0a;
    border: 2px solid #2ecc71;
    color: #2ecc71;
  }

  .cmd-preview.danger {
    background: #1f0a0a;
    border: 2px solid #e74c3c;
    color: #e74c3c;
  }

  .start-btn {
    background: linear-gradient(180deg, #ff8c42 0%, #e67635 100%);
    border: none;
    color: #fff;
    font-family: 'Courier New', monospace;
    font-size: 18px;
    font-weight: bold;
    padding: 14px 36px;
    border-radius: 8px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 2px;
    box-shadow: 0 4px 0 #b35c20, 0 0 20px rgba(255, 140, 66, 0.4);
    transition: all 0.1s;
  }

  .start-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 0 #b35c20, 0 0 30px rgba(255, 140, 66, 0.6);
  }

  .start-btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 #b35c20;
  }

  .hint {
    margin-top: 16px;
    color: #555;
    font-size: 11px;
  }

  .game-controls {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 16px;
  }

  .ctrl-btn {
    width: 70px;
    height: 50px;
    font-size: 24px;
    background: linear-gradient(180deg, #2a2a3a 0%, #1a1a2a 100%);
    color: #ff8c42;
    border: 2px solid #ff8c42;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 3px 0 #111;
    transition: all 0.1s;
  }

  .ctrl-btn:active {
    transform: translateY(2px);
    box-shadow: 0 1px 0 #111;
  }

  @media (max-width: 600px) {
    .game-screen { height: 380px; }
    .caro { width: 50px; height: 50px; }
    .title-display { font-size: 18px; letter-spacing: 2px; }
    .falling-cmd { font-size: 11px; padding: 6px 10px; }
  }
</style>

<script>
  (function() {
    const screen = document.getElementById('game-screen');
    const caroEl = document.getElementById('caro');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlay-title');
    const startBtn = document.getElementById('start-btn');
    const scoreEl = document.getElementById('score');
    const highScoreEl = document.getElementById('high-score');
    const livesEl = document.getElementById('lives');
    const leftBtn = document.getElementById('left-btn');
    const rightBtn = document.getElementById('right-btn');

    if (!screen || !caroEl || !overlay || !startBtn) return;

    // Config
    const CARO_W = 64;
    let screenW = screen.offsetWidth;
    let screenH = screen.offsetHeight;

    // State
    let running = false;
    let score = 0;
    let lives = 3;
    let caroX = screenW / 2 - CARO_W / 2;
    let highScore = parseInt(localStorage.getItem('caroHigh') || '0');
    let commands: { el: HTMLElement; x: number; y: number; w: number; h: number; speed: number; type: string }[] = [];
    let lastSpawn = 0;
    let spawnInterval = 1500;
    let baseSpeed = 2.5;
    let lastTime = 0;

    // Commands
    const safeCmds = ['ls -la', 'pwd', 'cat file', 'mkdir dir', 'grep hi', 'find .', 'echo hi', 'cd ~', 'touch f', 'head -5', 'tail -f', 'wc -l', 'chmod +x', 'ps aux', 'df -h', 'curl', 'wget'];
    const dangerCmds = ['rm -rf /', 'rm -rf ~', 'sudo rm', ':(){:|:&};:', 'mkfs', 'dd zero'];
    const bonusCmds = ['git commit', 'cargo build', 'npm run', 'docker up'];

    // Init display
    highScoreEl!.textContent = String(highScore).padStart(4, '0');
    caroEl.style.left = caroX + 'px';

    function resize() {
      screenW = screen.offsetWidth;
      screenH = screen.offsetHeight;
      if (caroX > screenW - CARO_W - 10) {
        caroX = screenW - CARO_W - 10;
        caroEl.style.left = caroX + 'px';
      }
    }
    window.addEventListener('resize', resize);

    function updateLives() {
      const dogs = livesEl!.querySelectorAll('.life');
      dogs.forEach((d, i) => d.classList.toggle('lost', i >= lives));
    }

    function spawn(time: number) {
      if (time - lastSpawn < spawnInterval) return;
      lastSpawn = time;

      // Increase difficulty
      if (spawnInterval > 600) spawnInterval -= 15;
      if (baseSpeed < 6) baseSpeed += 0.03;

      const r = Math.random();
      let type: string, list: string[];
      if (r < 0.12) { type = 'danger'; list = dangerCmds; }
      else if (r < 0.22) { type = 'bonus'; list = bonusCmds; }
      else { type = 'safe'; list = safeCmds; }

      const text = list[Math.floor(Math.random() * list.length)];
      const el = document.createElement('div');
      el.className = `falling-cmd ${type}`;
      el.textContent = text;
      screen.appendChild(el);

      const w = el.offsetWidth;
      const h = el.offsetHeight;
      const x = 20 + Math.random() * (screenW - w - 40);
      const speed = baseSpeed + Math.random() * 1.5;

      el.style.left = x + 'px';
      el.style.top = '-50px';

      commands.push({ el, x, y: -50, w, h, speed, type });
    }

    function showPopup(text: string, color: string, x: number, y: number) {
      const p = document.createElement('div');
      p.className = 'popup';
      p.textContent = text;
      p.style.left = x + 'px';
      p.style.top = y + 'px';
      p.style.color = color;
      p.style.animation = 'popAnim 0.5s ease-out forwards';
      screen.appendChild(p);
      setTimeout(() => p.remove(), 500);
    }

    function collides(cmd: typeof commands[0]): boolean {
      const caroTop = screenH - 64 - 15;
      const caroBottom = screenH - 15;
      const caroLeft = caroX;
      const caroRight = caroX + CARO_W;

      const cmdBottom = cmd.y + cmd.h;
      const cmdRight = cmd.x + cmd.w;

      return cmdBottom >= caroTop && cmd.y <= caroBottom && cmdRight >= caroLeft && cmd.x <= caroRight;
    }

    function gameLoop(time: number) {
      if (!running) return;

      const dt = Math.min((time - lastTime) / 16.67, 3); // normalize to ~60fps
      lastTime = time;

      spawn(time);

      commands = commands.filter(cmd => {
        cmd.y += cmd.speed * dt;
        cmd.el.style.top = cmd.y + 'px';

        if (collides(cmd)) {
          if (cmd.type === 'safe') {
            score += 10;
            showPopup('+10', '#ff8c42', cmd.x + cmd.w/2 - 15, cmd.y);
            caroEl.classList.add('flash');
            setTimeout(() => caroEl.classList.remove('flash'), 150);
          } else if (cmd.type === 'bonus') {
            score += 25;
            showPopup('+25', '#2ecc71', cmd.x + cmd.w/2 - 15, cmd.y);
            caroEl.classList.add('flash');
            setTimeout(() => caroEl.classList.remove('flash'), 150);
          } else {
            lives--;
            showPopup('OUCH!', '#e74c3c', cmd.x + cmd.w/2 - 25, cmd.y);
            caroEl.classList.add('hurt');
            setTimeout(() => caroEl.classList.remove('hurt'), 300);
            updateLives();
            if (lives <= 0) { endGame(); return false; }
          }
          scoreEl!.textContent = String(score).padStart(4, '0');
          cmd.el.remove();
          return false;
        }

        if (cmd.y > screenH + 20) {
          if (cmd.type !== 'danger') {
            lives--;
            updateLives();
            if (lives <= 0) endGame();
          }
          cmd.el.remove();
          return false;
        }

        return true;
      });

      requestAnimationFrame(gameLoop);
    }

    function startGame() {
      resize();
      running = true;
      score = 0;
      lives = 3;
      spawnInterval = 1500;
      baseSpeed = 2.5;
      lastSpawn = 0;
      lastTime = performance.now();

      caroX = screenW / 2 - CARO_W / 2;
      caroEl.style.left = caroX + 'px';

      commands.forEach(c => c.el.remove());
      commands = [];

      scoreEl!.textContent = '0000';
      updateLives();
      overlay.classList.add('hidden');

      requestAnimationFrame(gameLoop);
    }

    function endGame() {
      running = false;
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('caroHigh', String(highScore));
        highScoreEl!.textContent = String(highScore).padStart(4, '0');
        overlayTitle!.textContent = 'NEW HIGH!';
      } else {
        overlayTitle!.textContent = 'GAME OVER';
      }
      startBtn!.textContent = 'PLAY AGAIN';
      overlay.classList.remove('hidden');
    }

    function move(dir: number) {
      if (!running) return;
      caroX += dir * 18;
      if (caroX < 10) caroX = 10;
      if (caroX > screenW - CARO_W - 10) caroX = screenW - CARO_W - 10;
      caroEl.style.left = caroX + 'px';
    }

    // Keyboard with continuous movement
    const keys: Record<string, boolean> = {};
    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') { e.preventDefault(); keys.left = true; }
      if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') { e.preventDefault(); keys.right = true; }
      if (e.key === ' ' && !running) { e.preventDefault(); startGame(); }
    });
    document.addEventListener('keyup', e => {
      if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') keys.left = false;
      if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') keys.right = false;
    });

    // Key polling loop
    function keyPoll() {
      if (keys.left) move(-1);
      if (keys.right) move(1);
      requestAnimationFrame(keyPoll);
    }
    keyPoll();

    // Button controls
    startBtn.addEventListener('click', startGame);

    let btnInt: number | null = null;
    function startBtn_(dir: number) { move(dir); btnInt = window.setInterval(() => move(dir), 50); }
    function stopBtn_() { if (btnInt) { clearInterval(btnInt); btnInt = null; } }

    leftBtn?.addEventListener('mousedown', () => startBtn_(-1));
    leftBtn?.addEventListener('touchstart', e => { e.preventDefault(); startBtn_(-1); });
    rightBtn?.addEventListener('mousedown', () => startBtn_(1));
    rightBtn?.addEventListener('touchstart', e => { e.preventDefault(); startBtn_(1); });
    document.addEventListener('mouseup', stopBtn_);
    document.addEventListener('touchend', stopBtn_);
  })();
</script>

<style is:global>
  @keyframes popAnim {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-30px) scale(1.3); }
  }
</style>
