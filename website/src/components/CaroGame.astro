---
// CaroGame.astro - Atari-style "fetch" game featuring Caro
---

<section id="game" class="game-section">
  <div class="container">
    <h2>Play with Caro</h2>
    <p class="section-subtitle">
      Help Caro fetch the safe commands! Avoid the dangerous ones.
    </p>

    <div class="game-wrapper">
      <div class="arcade-cabinet">
        <div class="cabinet-top">
          <div class="score-display">
            <span class="label">SCORE</span>
            <span id="score" class="value">0000</span>
          </div>
          <div class="title-display">CARO FETCH</div>
          <div class="score-display">
            <span class="label">HIGH</span>
            <span id="high-score" class="value">0000</span>
          </div>
        </div>

        <div class="lives-display">
          <span id="lives">
            <span class="life">üêï</span>
            <span class="life">üêï</span>
            <span class="life">üêï</span>
          </span>
        </div>

        <div id="game-screen" class="game-screen">
          <!-- Scanline effect -->
          <div class="scanlines"></div>

          <!-- Caro at the bottom -->
          <div id="caro" class="caro">
            <img src="/caro-pixel.png" alt="Caro" />
          </div>

          <!-- Commands will spawn here -->
          <div id="commands-layer" class="commands-layer"></div>

          <!-- Game overlay -->
          <div id="overlay" class="overlay">
            <div class="overlay-box">
              <div id="overlay-title" class="title">CARO FETCH</div>
              <div class="instructions">
                <p>Catch safe commands</p>
                <p>Avoid dangerous ones!</p>
              </div>
              <div class="command-legend">
                <div class="legend-row">
                  <span class="terminal-preview safe">$ ls -la</span>
                  <span class="pts">+10 PTS</span>
                </div>
                <div class="legend-row">
                  <span class="terminal-preview bonus">$ git commit</span>
                  <span class="pts">+25 PTS</span>
                </div>
                <div class="legend-row">
                  <span class="terminal-preview danger">$ rm -rf /</span>
                  <span class="pts">-1 LIFE</span>
                </div>
              </div>
              <button id="start-btn" class="start-btn">
                <span>INSERT COIN</span>
              </button>
              <p class="controls-hint">‚Üê ‚Üí or A D to move</p>
            </div>
          </div>
        </div>

        <div class="game-controls">
          <button id="left-btn" class="ctrl-btn">‚óÄ</button>
          <button id="right-btn" class="ctrl-btn">‚ñ∂</button>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .game-section {
    background: var(--color-bg-secondary);
    padding: 80px 20px;
  }

  .game-wrapper {
    display: flex;
    justify-content: center;
  }

  .arcade-cabinet {
    background: #1a1a2e;
    border-radius: 20px;
    padding: 20px;
    box-shadow:
      0 0 0 4px #ff8c42,
      0 0 30px rgba(255, 140, 66, 0.3),
      inset 0 0 60px rgba(0, 0, 0, 0.5);
    max-width: 700px;
    width: 100%;
  }

  .cabinet-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    margin-bottom: 10px;
  }

  .score-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: 'Courier New', monospace;
  }

  .score-display .label {
    font-size: 12px;
    color: #ff8c42;
    letter-spacing: 2px;
  }

  .score-display .value {
    font-size: 24px;
    color: #fff;
    font-weight: bold;
    text-shadow: 0 0 10px rgba(255, 140, 66, 0.8);
  }

  .title-display {
    font-size: 28px;
    font-weight: bold;
    color: #ff8c42;
    text-shadow:
      0 0 10px rgba(255, 140, 66, 0.8),
      0 0 20px rgba(255, 140, 66, 0.4);
    letter-spacing: 3px;
    font-family: 'Courier New', monospace;
  }

  .lives-display {
    text-align: center;
    padding: 8px;
    font-size: 24px;
  }

  .lives-display .life {
    margin: 0 4px;
    transition: opacity 0.3s, transform 0.3s;
  }

  .lives-display .life.lost {
    opacity: 0.2;
    transform: scale(0.7);
  }

  .game-screen {
    position: relative;
    width: 100%;
    height: 500px;
    background: #0a0a0a;
    border: 4px solid #333;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: inset 0 0 100px rgba(0, 50, 0, 0.3);
  }

  .scanlines {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
      0deg,
      rgba(0, 0, 0, 0.1) 0px,
      rgba(0, 0, 0, 0.1) 1px,
      transparent 1px,
      transparent 3px
    );
    pointer-events: none;
    z-index: 100;
  }

  .caro {
    position: absolute;
    bottom: 20px;
    width: 70px;
    height: 70px;
    z-index: 10;
    transition: left 0.05s linear;
  }

  .caro img {
    width: 100%;
    height: 100%;
    image-rendering: pixelated;
    filter: drop-shadow(0 0 15px rgba(255, 140, 66, 0.7));
  }

  .caro.flash {
    animation: flash 0.15s ease-out 2;
  }

  @keyframes flash {
    0%, 100% { filter: drop-shadow(0 0 15px rgba(255, 140, 66, 0.7)); }
    50% { filter: drop-shadow(0 0 30px #fff) brightness(2); }
  }

  .caro.hurt {
    animation: hurt 0.4s ease-out;
  }

  @keyframes hurt {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-8px); }
    40%, 80% { transform: translateX(8px); }
  }

  .commands-layer {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
  }

  /* Terminal-styled falling commands */
  .cmd {
    position: absolute;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    font-weight: bold;
    padding: 6px 10px;
    border-radius: 4px;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .cmd::before {
    content: '$';
    opacity: 0.7;
  }

  .cmd.safe {
    background: linear-gradient(180deg, #2a2a3a 0%, #1a1a2a 100%);
    border: 2px solid #ff8c42;
    color: #ff8c42;
    box-shadow:
      0 0 10px rgba(255, 140, 66, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  .cmd.bonus {
    background: linear-gradient(180deg, #1a3a2a 0%, #0a2a1a 100%);
    border: 2px solid #2ecc71;
    color: #2ecc71;
    box-shadow:
      0 0 15px rgba(46, 204, 113, 0.5),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    animation: bonusPulse 0.6s ease-in-out infinite;
  }

  @keyframes bonusPulse {
    0%, 100% { box-shadow: 0 0 15px rgba(46, 204, 113, 0.5); }
    50% { box-shadow: 0 0 25px rgba(46, 204, 113, 0.8); }
  }

  .cmd.danger {
    background: linear-gradient(180deg, #3a1a1a 0%, #2a0a0a 100%);
    border: 2px solid #e74c3c;
    color: #e74c3c;
    box-shadow:
      0 0 15px rgba(231, 76, 60, 0.5),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    animation: dangerPulse 0.4s ease-in-out infinite;
  }

  @keyframes dangerPulse {
    0%, 100% { box-shadow: 0 0 15px rgba(231, 76, 60, 0.5); }
    50% { box-shadow: 0 0 25px rgba(231, 76, 60, 0.9); }
  }

  .cmd.caught {
    transition: all 0.15s ease-out;
    transform: scale(1.3);
    opacity: 0;
  }

  /* Score popup */
  .score-popup {
    position: absolute;
    font-family: 'Courier New', monospace;
    font-size: 20px;
    font-weight: bold;
    pointer-events: none;
    z-index: 50;
    text-shadow: 0 0 10px currentColor;
    animation: popUp 0.6s ease-out forwards;
  }

  @keyframes popUp {
    0% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    100% {
      opacity: 0;
      transform: translateY(-40px) scale(1.2);
    }
  }

  /* Overlay */
  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.92);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }

  .overlay.hidden {
    display: none;
  }

  .overlay-box {
    text-align: center;
    color: #fff;
    font-family: 'Courier New', monospace;
  }

  .overlay-box .title {
    font-size: 36px;
    color: #ff8c42;
    margin-bottom: 20px;
    text-shadow: 0 0 20px rgba(255, 140, 66, 0.8);
    letter-spacing: 4px;
  }

  .overlay-box .instructions {
    margin-bottom: 25px;
    line-height: 1.8;
    color: #aaa;
  }

  .command-legend {
    margin-bottom: 30px;
  }

  .legend-row {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin: 10px 0;
  }

  .terminal-preview {
    font-family: 'Courier New', monospace;
    font-size: 12px;
    padding: 5px 10px;
    border-radius: 4px;
    min-width: 100px;
    text-align: left;
  }

  .terminal-preview.safe {
    background: #1a1a2a;
    border: 2px solid #ff8c42;
    color: #ff8c42;
  }

  .terminal-preview.bonus {
    background: #0a2a1a;
    border: 2px solid #2ecc71;
    color: #2ecc71;
  }

  .terminal-preview.danger {
    background: #2a0a0a;
    border: 2px solid #e74c3c;
    color: #e74c3c;
  }

  .pts {
    font-size: 14px;
    color: #888;
    min-width: 70px;
  }

  .start-btn {
    background: linear-gradient(180deg, #ff8c42 0%, #ff6b35 100%);
    border: none;
    color: #fff;
    font-family: 'Courier New', monospace;
    font-size: 18px;
    font-weight: bold;
    padding: 15px 40px;
    border-radius: 8px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 2px;
    box-shadow: 0 0 20px rgba(255, 140, 66, 0.5);
    transition: transform 0.1s, box-shadow 0.2s;
  }

  .start-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 30px rgba(255, 140, 66, 0.8);
  }

  .start-btn:active {
    transform: scale(0.98);
  }

  .controls-hint {
    margin-top: 20px;
    color: #666;
    font-size: 12px;
  }

  .game-controls {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 20px;
  }

  .ctrl-btn {
    width: 80px;
    height: 60px;
    font-size: 28px;
    background: linear-gradient(180deg, #333 0%, #222 100%);
    color: #ff8c42;
    border: 3px solid #ff8c42;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.1s;
    box-shadow: 0 4px 0 #111;
  }

  .ctrl-btn:hover {
    background: linear-gradient(180deg, #444 0%, #333 100%);
  }

  .ctrl-btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 #111;
  }

  @media (max-width: 600px) {
    .arcade-cabinet {
      padding: 15px;
    }

    .game-screen {
      height: 400px;
    }

    .title-display {
      font-size: 18px;
    }

    .score-display .value {
      font-size: 18px;
    }

    .caro {
      width: 55px;
      height: 55px;
    }

    .cmd {
      font-size: 11px;
      padding: 5px 8px;
    }

    .overlay-box .title {
      font-size: 28px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Elements
    const screen = document.getElementById('game-screen') as HTMLElement;
    const caro = document.getElementById('caro') as HTMLElement;
    const layer = document.getElementById('commands-layer') as HTMLElement;
    const overlay = document.getElementById('overlay') as HTMLElement;
    const overlayTitle = document.getElementById('overlay-title') as HTMLElement;
    const startBtn = document.getElementById('start-btn') as HTMLElement;
    const scoreEl = document.getElementById('score') as HTMLElement;
    const highScoreEl = document.getElementById('high-score') as HTMLElement;
    const livesEl = document.getElementById('lives') as HTMLElement;
    const leftBtn = document.getElementById('left-btn') as HTMLElement;
    const rightBtn = document.getElementById('right-btn') as HTMLElement;

    if (!screen || !caro || !layer || !overlay || !startBtn) return;

    // Game config
    const CARO_SIZE = 70;
    const CMD_HEIGHT = 32;
    const SPAWN_INTERVAL = 1200;
    const BASE_SPEED = 3;

    // Game state
    let running = false;
    let score = 0;
    let lives = 3;
    let caroX = 0;
    let screenW = 0;
    let screenH = 0;
    let highScore = parseInt(localStorage.getItem('caroFetchHigh') || '0');
    let spawnTimer: number | null = null;
    let animFrame: number | null = null;

    // Commands data
    interface Cmd {
      el: HTMLElement;
      x: number;
      y: number;
      w: number;
      speed: number;
      type: 'safe' | 'bonus' | 'danger';
    }
    let commands: Cmd[] = [];

    const safeCommands = [
      'ls -la', 'pwd', 'cat file', 'mkdir dir', 'cp a b',
      'grep text', 'find .', 'echo hi', 'cd ~', 'touch f',
      'head -5', 'tail -f', 'wc -l', 'sort', 'chmod +x',
      'ps aux', 'df -h', 'curl url', 'wget', 'tar -xf'
    ];

    const dangerCommands = [
      'rm -rf /', 'rm -rf ~', 'sudo rm', ':(){:|:&};:', 'mkfs', 'dd zero'
    ];

    const bonusCommands = [
      'git commit', 'cargo build', 'npm run', 'docker up'
    ];

    // Initialize
    highScoreEl.textContent = String(highScore).padStart(4, '0');

    function updateSize() {
      screenW = screen.offsetWidth;
      screenH = screen.offsetHeight;
    }

    function updateLives() {
      const dogs = livesEl.querySelectorAll('.life');
      dogs.forEach((d, i) => d.classList.toggle('lost', i >= lives));
    }

    function formatScore(n: number): string {
      return String(n).padStart(4, '0');
    }

    function spawnCommand() {
      if (!running) return;
      updateSize();

      // Determine type
      const r = Math.random();
      let type: 'safe' | 'bonus' | 'danger';
      let cmdList: string[];

      if (r < 0.12) {
        type = 'danger';
        cmdList = dangerCommands;
      } else if (r < 0.22) {
        type = 'bonus';
        cmdList = bonusCommands;
      } else {
        type = 'safe';
        cmdList = safeCommands;
      }

      const text = cmdList[Math.floor(Math.random() * cmdList.length)];

      // Create element
      const el = document.createElement('div');
      el.className = `cmd ${type}`;
      el.textContent = text;
      layer.appendChild(el);

      // Get width after render
      const w = el.offsetWidth;

      // Random X position across full width
      const padding = 15;
      const maxX = screenW - w - padding * 2;
      const x = padding + Math.random() * maxX;

      el.style.left = `${x}px`;
      el.style.top = `-${CMD_HEIGHT + 10}px`;

      // Speed increases slightly with score
      const speedBoost = Math.min(score / 200, 2);
      const speed = BASE_SPEED + speedBoost + Math.random() * 0.8;

      commands.push({ el, x, y: -CMD_HEIGHT - 10, w, speed, type });
    }

    function showPopup(text: string, color: string, x: number, y: number) {
      const popup = document.createElement('div');
      popup.className = 'score-popup';
      popup.textContent = text;
      popup.style.left = `${x}px`;
      popup.style.top = `${y}px`;
      popup.style.color = color;
      screen.appendChild(popup);
      setTimeout(() => popup.remove(), 600);
    }

    function checkCollision(cmd: Cmd): boolean {
      const caroLeft = caroX;
      const caroRight = caroX + CARO_SIZE;
      const caroTop = screenH - CARO_SIZE - 20;

      const cmdLeft = cmd.x;
      const cmdRight = cmd.x + cmd.w;
      const cmdBottom = cmd.y + CMD_HEIGHT;

      // Check overlap
      return cmdBottom >= caroTop &&
             cmd.y < screenH - 10 &&
             cmdRight > caroLeft &&
             cmdLeft < caroRight;
    }

    function gameLoop() {
      if (!running) return;
      updateSize();

      commands = commands.filter(cmd => {
        // Move down
        cmd.y += cmd.speed;
        cmd.el.style.top = `${cmd.y}px`;

        // Check collision with Caro
        if (checkCollision(cmd)) {
          cmd.el.classList.add('caught');

          if (cmd.type === 'safe') {
            score += 10;
            showPopup('+10', '#ff8c42', cmd.x + cmd.w / 2, cmd.y);
            caro.classList.add('flash');
            setTimeout(() => caro.classList.remove('flash'), 300);
          } else if (cmd.type === 'bonus') {
            score += 25;
            showPopup('+25', '#2ecc71', cmd.x + cmd.w / 2, cmd.y);
            caro.classList.add('flash');
            setTimeout(() => caro.classList.remove('flash'), 300);
          } else {
            lives--;
            showPopup('OUCH!', '#e74c3c', cmd.x + cmd.w / 2, cmd.y);
            caro.classList.add('hurt');
            setTimeout(() => caro.classList.remove('hurt'), 400);
            updateLives();
            if (lives <= 0) {
              endGame();
              return false;
            }
          }

          scoreEl.textContent = formatScore(score);
          setTimeout(() => cmd.el.remove(), 150);
          return false;
        }

        // Fell off screen
        if (cmd.y > screenH + 20) {
          // Only lose life for missed safe/bonus commands
          if (cmd.type !== 'danger') {
            lives--;
            updateLives();
            if (lives <= 0) {
              endGame();
            }
          }
          cmd.el.remove();
          return false;
        }

        return true;
      });

      animFrame = requestAnimationFrame(gameLoop);
    }

    function startGame() {
      updateSize();
      running = true;
      score = 0;
      lives = 3;

      // Center Caro
      caroX = (screenW - CARO_SIZE) / 2;
      caro.style.left = `${caroX}px`;

      // Clear old commands
      commands.forEach(c => c.el.remove());
      commands = [];

      scoreEl.textContent = '0000';
      updateLives();
      overlay.classList.add('hidden');

      // Start spawning
      spawnTimer = window.setInterval(spawnCommand, SPAWN_INTERVAL);

      // Start game loop
      animFrame = requestAnimationFrame(gameLoop);
    }

    function endGame() {
      running = false;
      if (spawnTimer) clearInterval(spawnTimer);
      if (animFrame) cancelAnimationFrame(animFrame);

      // Update high score
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('caroFetchHigh', String(highScore));
        highScoreEl.textContent = formatScore(highScore);
        overlayTitle.textContent = 'NEW HIGH!';
      } else {
        overlayTitle.textContent = 'GAME OVER';
      }

      startBtn.innerHTML = '<span>PLAY AGAIN</span>';
      overlay.classList.remove('hidden');
    }

    function moveCaro(dir: 'left' | 'right') {
      if (!running) return;
      updateSize();

      const step = 20;
      if (dir === 'left') {
        caroX = Math.max(10, caroX - step);
      } else {
        caroX = Math.min(screenW - CARO_SIZE - 10, caroX + step);
      }
      caro.style.left = `${caroX}px`;
    }

    // Keyboard
    const keys: Record<string, boolean> = {};

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
        e.preventDefault();
        keys['left'] = true;
      }
      if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
        e.preventDefault();
        keys['right'] = true;
      }
      if (e.key === ' ' && !running) {
        e.preventDefault();
        startGame();
      }
    });

    document.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
        keys['left'] = false;
      }
      if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
        keys['right'] = false;
      }
    });

    // Continuous keyboard movement
    function keyboardLoop() {
      if (keys['left']) moveCaro('left');
      if (keys['right']) moveCaro('right');
      requestAnimationFrame(keyboardLoop);
    }
    keyboardLoop();

    // Button controls
    startBtn.addEventListener('click', startGame);

    let moveInt: number | null = null;

    function startMove(dir: 'left' | 'right') {
      moveCaro(dir);
      if (moveInt) clearInterval(moveInt);
      moveInt = window.setInterval(() => moveCaro(dir), 40);
    }

    function stopMove() {
      if (moveInt) {
        clearInterval(moveInt);
        moveInt = null;
      }
    }

    leftBtn.addEventListener('mousedown', () => startMove('left'));
    leftBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startMove('left'); });
    rightBtn.addEventListener('mousedown', () => startMove('right'));
    rightBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startMove('right'); });

    document.addEventListener('mouseup', stopMove);
    document.addEventListener('touchend', stopMove);
    document.addEventListener('touchcancel', stopMove);

    // Resize handler
    window.addEventListener('resize', () => {
      updateSize();
      if (caroX > screenW - CARO_SIZE - 10) {
        caroX = screenW - CARO_SIZE - 10;
        caro.style.left = `${caroX}px`;
      }
    });

    updateSize();
  });
</script>
