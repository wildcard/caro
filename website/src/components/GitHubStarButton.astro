---
---

<a
  href="https://github.com/wildcard/caro"
  class="github-star-button"
  id="github-star-button"
  aria-label="Star wildcard/caro repository on GitHub"
>
  <svg class="star-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path d="M12 .587l3.668 7.431 8.2 1.191-5.934 5.787 1.4 8.173L12 18.896l-7.334 3.857 1.4-8.173L.132 9.209l8.2-1.191z"/>
  </svg>
  <span class="star-text">Star</span>
  <span class="star-count" id="star-count">
    <span class="loading-spinner"></span>
  </span>
</a>

<style>
  .github-star-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    background: var(--color-bg);
    color: var(--color-text);
    border: 2px solid var(--color-border);
    border-radius: 8px;
    text-decoration: none;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .github-star-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 140, 66, 0.1), transparent);
    transition: left 0.5s;
  }

  .github-star-button:hover::before {
    left: 100%;
  }

  .github-star-button:hover {
    transform: translateY(-2px);
    border-color: #ff8c42;
    box-shadow: 0 8px 20px rgba(255, 140, 66, 0.25);
  }

  .github-star-button:active {
    transform: translateY(0);
  }

  .star-icon {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: #ff8c42;
  }

  .github-star-button:hover .star-icon {
    transform: rotate(72deg) scale(1.1);
  }

  .star-text {
    font-weight: 600;
  }

  .star-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    height: 24px;
    padding: 0 8px;
    background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
    color: white;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 700;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .github-star-button:hover .star-count {
    transform: scale(1.05);
  }

  .loading-spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .star-count.loaded .loading-spinner {
    display: none;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .github-star-button {
      font-size: 14px;
      padding: 8px 14px;
      gap: 6px;
    }

    .star-icon {
      width: 16px;
      height: 16px;
    }

    .star-count {
      min-width: 28px;
      height: 20px;
      font-size: 12px;
      padding: 0 6px;
    }
  }
</style>

<script>
  import confetti from 'canvas-confetti';

  const CACHE_KEY = 'github_star_count_wildcard_caro';
  const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes
  const FIRST_STAR_KEY = 'caro_first_star_clicked';
  const STAR_CLICK_COUNT_KEY = 'caro_star_click_count';

  /**
   * Get cached star count data from localStorage
   * @returns {Object|null} Cached data or null if expired/not found
   */
  function getCachedData() {
    try {
      const cached = localStorage.getItem(CACHE_KEY);
      if (!cached) return null;

      const data = JSON.parse(cached);
      const now = Date.now();

      if (now - data.timestamp < CACHE_DURATION) {
        return data;
      }

      // Cache expired, remove it
      localStorage.removeItem(CACHE_KEY);
      return null;
    } catch (error) {
      console.error('Error reading cache:', error);
      return null;
    }
  }

  /**
   * Save star count to localStorage cache
   * @param {number} count - The star count to cache
   */
  function setCachedData(count) {
    try {
      const data = {
        count: count,
        timestamp: Date.now()
      };
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
    } catch (error) {
      console.error('Error writing cache:', error);
    }
  }

  /**
   * Format star count for display
   * @param {number} count - The star count to format
   * @returns {string} Formatted count (e.g., "1.2k")
   */
  function formatCount(count) {
    if (count >= 1000) {
      return (count / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
    }
    return count.toString();
  }

  /**
   * Update the UI with star count
   * @param {number} count - The star count to display
   */
  function updateStarCount(count) {
    const starCountElement = document.getElementById('star-count');
    if (starCountElement) {
      starCountElement.classList.add('loaded');
      starCountElement.textContent = formatCount(count);
    }
  }

  /**
   * Show error state in UI
   * @param {string} message - Error message for console
   */
  function showError(message) {
    console.error(message);
    const starCountElement = document.getElementById('star-count');
    if (starCountElement) {
      starCountElement.classList.add('loaded');
      starCountElement.textContent = 'N/A';
    }
  }

  /**
   * Fetch GitHub star count from API
   */
  async function fetchStarCount() {
    // Check cache first to avoid rate limiting
    const cached = getCachedData();
    if (cached) {
      updateStarCount(cached.count);
      return;
    }

    try {
      const response = await fetch('https://api.github.com/repos/wildcard/caro');

      // Check for HTTP errors
      if (!response.ok) {
        // Handle rate limiting specifically
        if (response.status === 403) {
          const rateLimitRemaining = response.headers.get('X-RateLimit-Remaining');
          if (rateLimitRemaining === '0') {
            throw new Error('GitHub API rate limit exceeded. Try again later.');
          }
        }
        throw new Error(`GitHub API request failed with status ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      const starCount = data.stargazers_count;

      // Validate the star count
      if (typeof starCount !== 'number' || !Number.isFinite(starCount)) {
        throw new Error('GitHub API response does not contain a valid stargazers_count');
      }

      // Cache the result
      setCachedData(starCount);

      // Update UI
      updateStarCount(starCount);
    } catch (error) {
      showError('Failed to fetch GitHub stars: ' + error.message);
    }
  }

  /**
   * Calculate Fibonacci number for given position
   * @param {number} n - Position in Fibonacci sequence
   * @returns {number} Fibonacci number
   */
  function fibonacci(n) {
    if (n <= 1) return n;
    let a = 0, b = 1;
    for (let i = 2; i <= n; i++) {
      const temp = a + b;
      a = b;
      b = temp;
    }
    return b;
  }

  /**
   * Check if current click count is a Fibonacci number
   * @param {number} num - Number to check
   * @returns {boolean} True if number is in Fibonacci sequence
   */
  function isFibonacci(num) {
    if (num <= 0) return false;
    let a = 0, b = 1;
    while (b < num) {
      const temp = a + b;
      a = b;
      b = temp;
    }
    return b === num;
  }

  /**
   * Get current click count and increment
   * @returns {number} Current click count before incrementing
   */
  function getAndIncrementClickCount() {
    try {
      const count = parseInt(localStorage.getItem(STAR_CLICK_COUNT_KEY) || '0', 10);
      localStorage.setItem(STAR_CLICK_COUNT_KEY, (count + 1).toString());
      return count + 1;
    } catch (error) {
      console.error('Error managing click count:', error);
      return 1;
    }
  }

  /**
   * Show thank you message from Caro
   */
  function showThankYouMessage() {
    const messages = [
      "Woof! Thank you for starring! ðŸ•",
      "You're pawsome! Thanks for the star! ðŸŒŸ",
      "Tail wagging intensifies! Thank you! ðŸ’«",
      "A loyal friend like you deserves the best! Thanks! âœ¨",
      "Caro appreciates your support! Woof woof! ðŸŽ‰"
    ];

    const randomMessage = messages[Math.floor(Math.random() * messages.length)];

    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'caro-thank-you-toast';
    toast.textContent = randomMessage;
    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => toast.classList.add('show'), 10);

    // Remove after 4 seconds
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  /**
   * Get random element from array
   */
  function randomFromArray(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  /**
   * Fire confetti with Fibonacci-seeded randomization
   * @param {number} clickCount - Current click count
   */
  function fireConfetti(clickCount) {
    const isFib = isFibonacci(clickCount);

    // Use Fibonacci number as seed for variation
    const fibIndex = isFib ? clickCount : 0;
    const seed = fibonacci(Math.min(fibIndex, 20)); // Cap to prevent huge numbers

    // Normalize seed for random values (0-1 range)
    const normalizedSeed = (seed % 100) / 100;

    // Color palettes for variety
    const colorPalettes = [
      ['#ff8c42', '#ff6b35', '#ffd700', '#ff1493', '#00ff00', '#00bfff'], // Rainbow
      ['#ff8c42', '#ff6b35', '#ff4500', '#ffa500', '#ffd700'], // Warm sunset
      ['#00bfff', '#1e90ff', '#4169e1', '#0000ff', '#8a2be2'], // Cool blues
      ['#ff1493', '#ff69b4', '#ff00ff', '#da70d6', '#ba55d3'], // Pink/purple
      ['#00ff00', '#32cd32', '#00fa9a', '#7fff00', '#adff2f'], // Green garden
      ['#ffd700', '#ffff00', '#ffffe0', '#fffacd', '#fff8dc'], // Golden
    ];

    if (isFib) {
      // Special Fibonacci confetti - DRAMATIC MULTI-PATTERN CELEBRATION!
      const particleCount = Math.min(50 + seed, 200);
      const spread = 60 + (normalizedSeed * 100);
      const startVelocity = 30 + (normalizedSeed * 30);
      const palette = colorPalettes[seed % colorPalettes.length];

      // Main center burst
      confetti({
        particleCount,
        spread,
        startVelocity,
        origin: { x: 0.5, y: 0.6 },
        colors: palette,
        shapes: ['star', 'circle', 'square'],
        scalar: 1.2 + (normalizedSeed * 0.5),
        gravity: 1 + (normalizedSeed * 0.5),
        drift: (normalizedSeed - 0.5) * 2,
        ticks: 200 + seed,
        decay: 0.9
      });

      // Left side burst (delayed)
      setTimeout(() => {
        confetti({
          particleCount: 40,
          angle: 60,
          spread: 80,
          origin: { x: 0, y: 0.8 },
          colors: palette.slice(0, 3),
          shapes: ['star', 'circle'],
          startVelocity: 35,
          gravity: 1.2,
          drift: 1
        });
      }, 100);

      // Right side burst (delayed)
      setTimeout(() => {
        confetti({
          particleCount: 40,
          angle: 120,
          spread: 80,
          origin: { x: 1, y: 0.8 },
          colors: palette.slice(3),
          shapes: ['star', 'circle'],
          startVelocity: 35,
          gravity: 1.2,
          drift: -1
        });
      }, 100);

      // Top rain (delayed)
      setTimeout(() => {
        confetti({
          particleCount: 30,
          angle: 90,
          spread: 180,
          origin: { x: 0.5, y: 0 },
          colors: palette,
          shapes: ['square', 'circle'],
          startVelocity: 20,
          gravity: 0.8,
          scalar: 0.8
        });
      }, 300);

      // Spiral effect (for higher Fibonacci numbers)
      if (seed > 5) {
        for (let i = 0; i < 3; i++) {
          setTimeout(() => {
            const angle = 90 + (i * 30);
            confetti({
              particleCount: 20,
              angle: angle,
              spread: 45,
              origin: { x: 0.5, y: 0.5 },
              colors: [palette[i % palette.length]],
              shapes: ['star'],
              startVelocity: 25,
              scalar: 1.5
            });
          }, 200 + (i * 100));
        }
      }

    } else {
      // Regular confetti - still diverse but less intense
      const variation = clickCount % 5;
      const palette = colorPalettes[clickCount % colorPalettes.length];

      switch(variation) {
        case 0:
          // Classic center burst
          confetti({
            particleCount: 60,
            spread: 70,
            origin: { x: 0.5, y: 0.6 },
            colors: palette,
            startVelocity: 25 + (normalizedSeed * 10),
            gravity: 1,
            drift: (normalizedSeed - 0.5),
            shapes: ['circle', 'square']
          });
          break;

        case 1:
          // Dual side cannons
          confetti({
            particleCount: 35,
            angle: 60,
            spread: 55,
            origin: { x: 0 },
            colors: palette.slice(0, 3),
            shapes: ['star', 'circle']
          });
          confetti({
            particleCount: 35,
            angle: 120,
            spread: 55,
            origin: { x: 1 },
            colors: palette.slice(3),
            shapes: ['star', 'circle']
          });
          break;

        case 2:
          // Fountain from bottom
          confetti({
            particleCount: 50,
            angle: 90,
            spread: 120,
            origin: { x: 0.5, y: 1 },
            colors: palette,
            startVelocity: 40,
            shapes: ['star', 'circle', 'square']
          });
          break;

        case 3:
          // Rain from top
          confetti({
            particleCount: 50,
            angle: 90,
            spread: 180,
            origin: { x: 0.5, y: 0 },
            colors: palette,
            startVelocity: 20,
            gravity: 0.6,
            shapes: ['circle', 'square'],
            scalar: 0.7
          });
          break;

        case 4:
          // Diagonal sweep
          for (let i = 0; i < 3; i++) {
            setTimeout(() => {
              confetti({
                particleCount: 25,
                angle: 135,
                spread: 50,
                origin: { x: i * 0.3, y: 0 },
                colors: palette,
                shapes: ['star', 'circle']
              });
            }, i * 100);
          }
          break;
      }
    }
  }

  /**
   * Handle star button click for confetti effect
   */
  function handleStarClick(event) {
    const targetUrl = event.currentTarget.href;

    // Allow modified clicks (Cmd/Ctrl+click) to open new tab normally
    if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey || event.button !== 0) {
      return; // Let browser handle it
    }

    // Prevent default same-tab navigation so we can show confetti first
    event.preventDefault();

    const clickCount = getAndIncrementClickCount();
    const isFirstClick = localStorage.getItem(FIRST_STAR_KEY) !== 'true';

    if (isFirstClick) {
      // First time ever - special treatment
      localStorage.setItem(FIRST_STAR_KEY, 'true');

      // Delay for 800ms before showing confetti and message
      setTimeout(() => {
        fireConfetti(clickCount);
        showThankYouMessage();

        // Navigate after 4 seconds to let user enjoy the full celebration
        setTimeout(() => {
          window.location.assign(targetUrl);
        }, 4000);
      }, 800);
    } else {
      // Subsequent clicks - immediate confetti with Fibonacci variations
      fireConfetti(clickCount);

      const isFib = isFibonacci(clickCount);

      if (isFib) {
        // Fibonacci clicks get message and longer delay
        showThankYouMessage();
        setTimeout(() => {
          window.location.assign(targetUrl);
        }, 3500);
      } else {
        // Regular clicks - moderate delay to see confetti
        setTimeout(() => {
          window.location.assign(targetUrl);
        }, 2500);
      }
    }
  }

  // Run when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchStarCount);
  } else {
    fetchStarCount();
  }

  // Add click handler
  const starButton = document.getElementById('github-star-button');
  if (starButton) {
    starButton.addEventListener('click', handleStarClick);
  }
</script>

<style is:global>
  .caro-thank-you-toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
    color: white;
    padding: 32px 48px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 28px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(255, 140, 66, 0.6),
                0 0 0 4px rgba(255, 255, 255, 0.3);
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 10000;
    pointer-events: none;
    max-width: 90vw;
    line-height: 1.4;
    backdrop-filter: blur(10px);
    border: 3px solid rgba(255, 255, 255, 0.5);
  }

  .caro-thank-you-toast.show {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
    animation: pulse 1s ease-in-out;
  }

  @keyframes pulse {
    0%, 100% {
      transform: translate(-50%, -50%) scale(1);
    }
    50% {
      transform: translate(-50%, -50%) scale(1.05);
    }
  }

  @media (max-width: 768px) {
    .caro-thank-you-toast {
      font-size: 20px;
      padding: 24px 32px;
      max-width: 85vw;
    }
  }

  @media (max-width: 480px) {
    .caro-thank-you-toast {
      font-size: 18px;
      padding: 20px 24px;
    }
  }
</style>
