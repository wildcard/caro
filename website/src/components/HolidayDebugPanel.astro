---
/**
 * Holiday Debug Panel
 *
 * A developer panel for testing holiday themes. Accessible via:
 * - Cmd+Shift+\ (Mac) or Ctrl+Shift+\ (Windows/Linux)
 * - ?holidayDebug=true query parameter
 *
 * Features:
 * - Test any date to see which themes would be active
 * - Override locale for testing locale-specific themes
 * - Preview all holiday themes instantly
 * - View engine state and debug info
 */
---

<div id="holiday-debug-panel" class="debug-panel hidden">
  <div class="debug-header">
    <h3>ğŸ„ Holiday Theme Debug</h3>
    <button id="debug-close" class="debug-close">Ã—</button>
  </div>

  <div class="debug-content">
    <!-- Date Override -->
    <div class="debug-section">
      <label class="debug-label">Test Date</label>
      <div class="debug-row">
        <input type="date" id="debug-date" class="debug-input" />
        <button id="debug-apply-date" class="debug-btn">Apply</button>
        <button id="debug-reset-date" class="debug-btn secondary">Reset</button>
      </div>
    </div>

    <!-- Quick Date Presets -->
    <div class="debug-section">
      <label class="debug-label">Quick Dates</label>
      <div class="debug-presets">
        <button class="preset-btn" data-date="2025-12-24">Christmas Eve</button>
        <button class="preset-btn" data-date="2025-12-15">Hanukkah '25</button>
        <button class="preset-btn" data-date="2026-01-01">New Year</button>
        <button class="preset-btn" data-date="2025-10-20">Diwali '25</button>
        <button class="preset-btn" data-date="2025-01-29">Lunar NY '25</button>
        <button class="preset-btn" data-date="2025-07-04">July 4th</button>
        <button class="preset-btn" data-date="2025-07-14">Bastille Day</button>
        <button class="preset-btn" data-date="2025-05-01">Yom Ha'atzmaut</button>
      </div>
    </div>

    <!-- Locale Override -->
    <div class="debug-section">
      <label class="debug-label">Test Locale</label>
      <select id="debug-locale" class="debug-select">
        <option value="">Auto-detect</option>
        <option value="US">ğŸ‡ºğŸ‡¸ United States</option>
        <option value="IL">ğŸ‡®ğŸ‡± Israel</option>
        <option value="FR">ğŸ‡«ğŸ‡· France</option>
        <option value="DE">ğŸ‡©ğŸ‡ª Germany</option>
        <option value="IN">ğŸ‡®ğŸ‡³ India</option>
        <option value="CN">ğŸ‡¨ğŸ‡³ China</option>
        <option value="JP">ğŸ‡¯ğŸ‡µ Japan</option>
        <option value="AE">ğŸ‡¦ğŸ‡ª UAE</option>
        <option value="ID">ğŸ‡®ğŸ‡© Indonesia</option>
        <option value="PH">ğŸ‡µğŸ‡­ Philippines</option>
      </select>
    </div>

    <!-- Theme Preview -->
    <div class="debug-section">
      <label class="debug-label">Preview Theme</label>
      <div class="debug-themes">
        <button class="theme-preview-btn" data-theme="none">None</button>
        <button class="theme-preview-btn" data-theme="christmas">ğŸ„ Christmas</button>
        <button class="theme-preview-btn" data-theme="hanukkah">ğŸ• Hanukkah</button>
        <button class="theme-preview-btn" data-theme="newyear">ğŸŠ New Year</button>
        <button class="theme-preview-btn" data-theme="diwali">ğŸª” Diwali</button>
        <button class="theme-preview-btn" data-theme="lunar-new-year">ğŸ‰ Lunar NY</button>
      </div>
    </div>

    <!-- Engine State -->
    <div class="debug-section">
      <label class="debug-label">Engine State</label>
      <pre id="debug-state" class="debug-state"></pre>
    </div>
  </div>
</div>

<style>
  .debug-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 380px;
    max-height: 80vh;
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    overflow: hidden;
  }

  .debug-panel.hidden {
    display: none;
  }

  .debug-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: linear-gradient(135deg, #c41e3a 0%, #228b22 100%);
    color: white;
  }

  .debug-header h3 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
  }

  .debug-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    opacity: 0.8;
  }

  .debug-close:hover {
    opacity: 1;
  }

  .debug-content {
    padding: 16px;
    max-height: calc(80vh - 50px);
    overflow-y: auto;
  }

  .debug-section {
    margin-bottom: 16px;
  }

  .debug-section:last-child {
    margin-bottom: 0;
  }

  .debug-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-text-secondary);
    margin-bottom: 8px;
  }

  .debug-row {
    display: flex;
    gap: 8px;
  }

  .debug-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 14px;
    background: var(--color-bg);
    color: var(--color-text);
  }

  .debug-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 14px;
    background: var(--color-bg);
    color: var(--color-text);
  }

  .debug-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    background: #228b22;
    color: white;
    transition: all 0.2s;
  }

  .debug-btn:hover {
    background: #1a6b1a;
  }

  .debug-btn.secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .debug-btn.secondary:hover {
    background: var(--color-border);
  }

  .debug-presets {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .preset-btn {
    padding: 6px 10px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 11px;
    background: var(--color-bg);
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.2s;
  }

  .preset-btn:hover {
    background: var(--color-bg-secondary);
    border-color: #c41e3a;
  }

  .debug-themes {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .theme-preview-btn {
    padding: 8px 12px;
    border: 2px solid var(--color-border);
    border-radius: 6px;
    font-size: 12px;
    background: var(--color-bg);
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.2s;
  }

  .theme-preview-btn:hover {
    border-color: #c41e3a;
  }

  .theme-preview-btn.active {
    border-color: #228b22;
    background: rgba(34, 139, 34, 0.1);
  }

  .debug-state {
    padding: 12px;
    background: var(--color-bg-secondary);
    border-radius: 6px;
    font-size: 11px;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 200px;
    margin: 0;
    color: var(--color-text);
  }

  /* Dark mode adjustments */
  .dark .debug-panel {
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  }

  /* Hotkey hint */
  .debug-panel::after {
    content: 'Press Cmd+Shift+\\ to toggle';
    position: absolute;
    bottom: -24px;
    right: 0;
    font-size: 10px;
    color: var(--color-text-secondary);
    opacity: 0.7;
  }
</style>

<script is:inline>
  // Self-executing function to handle both DOM ready states
  (function() {
    function initDebugPanel() {
      const panel = document.getElementById('holiday-debug-panel');
      const closeBtn = document.getElementById('debug-close');
      const dateInput = document.getElementById('debug-date');
      const applyDateBtn = document.getElementById('debug-apply-date');
      const resetDateBtn = document.getElementById('debug-reset-date');
      const localeSelect = document.getElementById('debug-locale');
      const stateDisplay = document.getElementById('debug-state');

      // =========================================================================
      // CONSTANTS
      // =========================================================================

      const ALL_THEMES = [
        'christmas', 'hanukkah', 'newyear', 'diwali', 'lunar-new-year',
        'holi', 'eid', 'july-4th', 'bastille-day', 'german-unity', 'yom-haatzmaut'
      ];

      const HOLIDAY_DATES = [
        // Global holidays
        { id: 'christmas', start: [12, 20], end: [12, 26], theme: 'christmas' },
        { id: 'newyear', start: [1, 1], end: [1, 3], theme: 'newyear' },

        // Year-specific holidays
        { id: 'hanukkah-2025', start: [12, 14], end: [12, 22], theme: 'hanukkah', years: [2025] },
        { id: 'hanukkah-2026', start: [12, 5], end: [12, 13], theme: 'hanukkah', years: [2026] },
        { id: 'diwali-2025', start: [10, 18], end: [10, 24], theme: 'diwali', years: [2025] },
        { id: 'diwali-2026', start: [11, 7], end: [11, 13], theme: 'diwali', years: [2026] },
        { id: 'lunar-ny-2025', start: [1, 26], end: [2, 9], theme: 'lunar-new-year', years: [2025] },
        { id: 'lunar-ny-2026', start: [2, 14], end: [2, 28], theme: 'lunar-new-year', years: [2026] },
        { id: 'holi-2025', start: [3, 12], end: [3, 16], theme: 'holi', years: [2025] },
        { id: 'holi-2026', start: [3, 1], end: [3, 5], theme: 'holi', years: [2026] },

        // Locale-specific holidays
        { id: 'july-4th', start: [7, 1], end: [7, 7], theme: 'july-4th', locales: ['US'] },
        { id: 'bastille', start: [7, 12], end: [7, 16], theme: 'bastille-day', locales: ['FR'] },
        { id: 'german-unity', start: [10, 1], end: [10, 5], theme: 'german-unity', locales: ['DE'] },
        { id: 'yom-haatzmaut', start: [5, 1], end: [5, 3], theme: 'yom-haatzmaut', locales: ['IL'] },
      ];

      // =========================================================================
      // HELPER FUNCTIONS
      // =========================================================================

      function isDateInRange(month, day, start, end) {
        var startMonth = start[0], startDay = start[1];
        var endMonth = end[0], endDay = end[1];
        var dateVal = month * 100 + day;
        var startVal = startMonth * 100 + startDay;
        var endVal = endMonth * 100 + endDay;

        if (startVal <= endVal) {
          return dateVal >= startVal && dateVal <= endVal;
        } else {
          return dateVal >= startVal || dateVal <= endVal;
        }
      }

      function getThemeForDate(date, localeOverride) {
        var month = date.getMonth() + 1;
        var day = date.getDate();
        var year = date.getFullYear();

        console.log('ğŸ” Checking theme for: ' + year + '-' + month + '-' + day + ', locale: ' + (localeOverride || 'auto'));

        for (var i = 0; i < HOLIDAY_DATES.length; i++) {
          var holiday = HOLIDAY_DATES[i];

          // Skip if year-specific and doesn't match
          if (holiday.years && holiday.years.indexOf(year) === -1) {
            continue;
          }

          // Check if date is in range
          if (!isDateInRange(month, day, holiday.start, holiday.end)) {
            continue;
          }

          console.log('ğŸ“… Date matches: ' + holiday.id);

          // Check locale restrictions
          if (holiday.locales && holiday.locales.length > 0) {
            if (!localeOverride || holiday.locales.indexOf(localeOverride) === -1) {
              console.log('ğŸŒ Locale mismatch, skipping');
              continue;
            }
          }

          console.log('âœ… Theme selected: ' + holiday.theme);
          return holiday.theme;
        }

        console.log('âŒ No matching theme found');
        return null;
      }

      function applyTheme(theme) {
        console.log('ğŸ¨ Applying theme: ' + (theme || 'none'));

        // Remove all theme classes
        for (var i = 0; i < ALL_THEMES.length; i++) {
          document.documentElement.classList.remove(ALL_THEMES[i]);
        }

        // Apply new theme
        if (theme && theme !== 'none') {
          document.documentElement.classList.add(theme);
          console.log('âœ“ Added class: ' + theme);
        }

        // Update preview button states
        var buttons = document.querySelectorAll('.theme-preview-btn');
        for (var i = 0; i < buttons.length; i++) {
          var btn = buttons[i];
          var btnTheme = btn.dataset.theme || 'none';
          if (btnTheme === (theme || 'none')) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        }

        // Save to localStorage
        localStorage.setItem('holidayTheme', theme || 'none');
      }

      function setTestDateAndApplyTheme(dateStr) {
        console.log('ğŸ“† Setting test date: ' + dateStr);

        var match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!match) {
          console.error('Invalid date format:', dateStr);
          return;
        }

        var year = parseInt(match[1], 10);
        var month = parseInt(match[2], 10);
        var day = parseInt(match[3], 10);
        var date = new Date(year, month - 1, day);

        if (isNaN(date.getTime())) {
          console.error('Invalid date:', dateStr);
          return;
        }

        // Set the test date globally
        window.__CARO_TEST_DATE = date.toISOString();

        // Update date input
        if (dateInput) {
          dateInput.value = dateStr;
        }

        // Determine and apply the appropriate theme
        var localeOverride = localStorage.getItem('debug_locale_override') || null;
        var theme = getThemeForDate(date, localeOverride);
        applyTheme(theme);

        // Update state display
        updateDebugState();
      }

      function updateDebugState() {
        if (!stateDisplay) return;

        var now = window.__CARO_TEST_DATE
          ? new Date(window.__CARO_TEST_DATE)
          : new Date();

        var timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        var language = navigator.language;
        var localeOverride = localStorage.getItem('debug_locale_override');
        var detectedTheme = getThemeForDate(now, localeOverride);

        var state = {
          date: now.toISOString().split('T')[0],
          timezone: timezone,
          language: language,
          localeOverride: localeOverride || 'none',
          detectedTheme: detectedTheme || 'none',
          savedTheme: localStorage.getItem('holidayTheme') || 'none',
          appliedClasses: Array.from(document.documentElement.classList)
        };

        stateDisplay.textContent = JSON.stringify(state, null, 2);
      }

      // =========================================================================
      // ACCESS CONTROL
      // =========================================================================

      function shouldShowDebug() {
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          return true;
        }
        var params = new URLSearchParams(window.location.search);
        return params.has('holidayDebug');
      }

      if (!shouldShowDebug()) {
        if (panel) panel.remove();
        return;
      }

      // =========================================================================
      // EVENT HANDLERS
      // =========================================================================

      // Toggle panel with hotkey
      document.addEventListener('keydown', function(e) {
        var isBackslash = e.code === 'Backslash' || e.key === '|' || e.key === '\\';
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && isBackslash) {
          e.preventDefault();
          if (panel) {
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
              updateDebugState();
            }
          }
        }
      });

      // Close button
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          if (panel) panel.classList.add('hidden');
        });
      }

      // Initialize date input
      if (dateInput) {
        var testDate = window.__CARO_TEST_DATE;
        if (testDate) {
          dateInput.value = new Date(testDate).toISOString().split('T')[0];
        } else {
          dateInput.value = new Date().toISOString().split('T')[0];
        }
      }

      // Apply date button
      if (applyDateBtn) {
        applyDateBtn.addEventListener('click', function() {
          if (dateInput && dateInput.value) {
            setTestDateAndApplyTheme(dateInput.value);
          }
        });
      }

      // Reset date button
      if (resetDateBtn) {
        resetDateBtn.addEventListener('click', function() {
          delete window.__CARO_TEST_DATE;
          var now = new Date();
          if (dateInput) {
            dateInput.value = now.toISOString().split('T')[0];
          }
          var localeOverride = localStorage.getItem('debug_locale_override') || null;
          var theme = getThemeForDate(now, localeOverride);
          applyTheme(theme);
          updateDebugState();
          console.log('ğŸ§ª Test date reset to today');
        });
      }

      // Quick date presets
      var presetBtns = document.querySelectorAll('.preset-btn');
      for (var i = 0; i < presetBtns.length; i++) {
        (function(btn) {
          btn.addEventListener('click', function() {
            var date = btn.dataset.date;
            if (date) {
              setTestDateAndApplyTheme(date);
            }
          });
        })(presetBtns[i]);
      }

      // Locale selector
      if (localeSelect) {
        localeSelect.addEventListener('change', function() {
          var locale = localeSelect.value;
          if (locale) {
            localStorage.setItem('debug_locale_override', locale);
          } else {
            localStorage.removeItem('debug_locale_override');
          }

          var now = window.__CARO_TEST_DATE
            ? new Date(window.__CARO_TEST_DATE)
            : new Date();
          var theme = getThemeForDate(now, locale || null);
          applyTheme(theme);
          updateDebugState();
          console.log('ğŸŒ Locale set to: ' + (locale || 'auto-detect'));
        });

        // Restore saved locale
        var savedLocale = localStorage.getItem('debug_locale_override');
        if (savedLocale) {
          localeSelect.value = savedLocale;
        }
      }

      // Theme preview buttons
      var themeBtns = document.querySelectorAll('.theme-preview-btn');
      for (var i = 0; i < themeBtns.length; i++) {
        (function(btn) {
          btn.addEventListener('click', function() {
            var theme = btn.dataset.theme || null;
            applyTheme(theme === 'none' ? null : theme);
            updateDebugState();
            console.log('ğŸ¨ Theme manually set to: ' + (theme || 'none'));
          });
        })(themeBtns[i]);
      }

      // Initialize button states
      var currentTheme = localStorage.getItem('holidayTheme') || 'none';
      for (var i = 0; i < themeBtns.length; i++) {
        var btn = themeBtns[i];
        if (btn.dataset.theme === currentTheme) {
          btn.classList.add('active');
        }
      }

      // =========================================================================
      // INITIALIZATION
      // =========================================================================

      updateDebugState();

      // Show panel if query param is set
      var params = new URLSearchParams(window.location.search);
      if (params.has('holidayDebug') && panel) {
        panel.classList.remove('hidden');
      }

      console.log('ğŸ„ Holiday Debug Panel loaded. Press Cmd+Shift+\\ to toggle.');
    }

    // Run immediately if DOM is ready, otherwise wait
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDebugPanel);
    } else {
      initDebugPanel();
    }
  })();
</script>
