---
/**
 * Holiday Debug Panel
 *
 * A developer panel for testing holiday themes. Accessible via:
 * - Cmd+Shift+\ (Mac) or Ctrl+Shift+\ (Windows/Linux)
 * - ?holidayDebug=true query parameter
 *
 * Features:
 * - Test any date to see which themes would be active
 * - Override locale for testing locale-specific themes
 * - Preview all holiday themes instantly
 * - View engine state and debug info
 */
---

<div id="holiday-debug-panel" class="debug-panel hidden">
  <div class="debug-header">
    <h3>ğŸ„ Holiday Theme Debug</h3>
    <button id="debug-close" class="debug-close">Ã—</button>
  </div>

  <div class="debug-content">
    <!-- Date Override -->
    <div class="debug-section">
      <label class="debug-label">Test Date</label>
      <div class="debug-row">
        <input type="date" id="debug-date" class="debug-input" />
        <button id="debug-apply-date" class="debug-btn">Apply</button>
        <button id="debug-reset-date" class="debug-btn secondary">Reset</button>
      </div>
    </div>

    <!-- Quick Date Presets -->
    <div class="debug-section">
      <label class="debug-label">Quick Dates</label>
      <div class="debug-presets">
        <button class="preset-btn" data-date="2025-12-24">Christmas Eve</button>
        <button class="preset-btn" data-date="2025-12-15">Hanukkah '25</button>
        <button class="preset-btn" data-date="2026-01-01">New Year</button>
        <button class="preset-btn" data-date="2025-10-20">Diwali '25</button>
        <button class="preset-btn" data-date="2025-01-29">Lunar NY '25</button>
        <button class="preset-btn" data-date="2025-07-04">July 4th</button>
        <button class="preset-btn" data-date="2025-07-14">Bastille Day</button>
        <button class="preset-btn" data-date="2025-05-01">Yom Ha'atzmaut</button>
      </div>
    </div>

    <!-- Locale Override -->
    <div class="debug-section">
      <label class="debug-label">Test Locale</label>
      <select id="debug-locale" class="debug-select">
        <option value="">Auto-detect</option>
        <option value="US">ğŸ‡ºğŸ‡¸ United States</option>
        <option value="IL">ğŸ‡®ğŸ‡± Israel</option>
        <option value="FR">ğŸ‡«ğŸ‡· France</option>
        <option value="DE">ğŸ‡©ğŸ‡ª Germany</option>
        <option value="IN">ğŸ‡®ğŸ‡³ India</option>
        <option value="CN">ğŸ‡¨ğŸ‡³ China</option>
        <option value="JP">ğŸ‡¯ğŸ‡µ Japan</option>
        <option value="AE">ğŸ‡¦ğŸ‡ª UAE</option>
        <option value="ID">ğŸ‡®ğŸ‡© Indonesia</option>
        <option value="PH">ğŸ‡µğŸ‡­ Philippines</option>
      </select>
    </div>

    <!-- Theme Preview -->
    <div class="debug-section">
      <label class="debug-label">Preview Theme</label>
      <div class="debug-themes">
        <button class="theme-preview-btn" data-theme="none">None</button>
        <button class="theme-preview-btn" data-theme="christmas">ğŸ„ Christmas</button>
        <button class="theme-preview-btn" data-theme="hanukkah">ğŸ• Hanukkah</button>
        <button class="theme-preview-btn" data-theme="newyear">ğŸŠ New Year</button>
        <button class="theme-preview-btn" data-theme="diwali">ğŸª” Diwali</button>
        <button class="theme-preview-btn" data-theme="lunar-new-year">ğŸ‰ Lunar NY</button>
      </div>
    </div>

    <!-- Engine State -->
    <div class="debug-section">
      <label class="debug-label">Engine State</label>
      <pre id="debug-state" class="debug-state"></pre>
    </div>
  </div>
</div>

<style>
  .debug-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 380px;
    max-height: 80vh;
    background: var(--color-bg);
    border: 2px solid var(--color-border);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    overflow: hidden;
  }

  .debug-panel.hidden {
    display: none;
  }

  .debug-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: linear-gradient(135deg, #c41e3a 0%, #228b22 100%);
    color: white;
  }

  .debug-header h3 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
  }

  .debug-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    opacity: 0.8;
  }

  .debug-close:hover {
    opacity: 1;
  }

  .debug-content {
    padding: 16px;
    max-height: calc(80vh - 50px);
    overflow-y: auto;
  }

  .debug-section {
    margin-bottom: 16px;
  }

  .debug-section:last-child {
    margin-bottom: 0;
  }

  .debug-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-text-secondary);
    margin-bottom: 8px;
  }

  .debug-row {
    display: flex;
    gap: 8px;
  }

  .debug-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 14px;
    background: var(--color-bg);
    color: var(--color-text);
  }

  .debug-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 14px;
    background: var(--color-bg);
    color: var(--color-text);
  }

  .debug-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    background: #228b22;
    color: white;
    transition: all 0.2s;
  }

  .debug-btn:hover {
    background: #1a6b1a;
  }

  .debug-btn.secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .debug-btn.secondary:hover {
    background: var(--color-border);
  }

  .debug-presets {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .preset-btn {
    padding: 6px 10px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 11px;
    background: var(--color-bg);
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.2s;
  }

  .preset-btn:hover {
    background: var(--color-bg-secondary);
    border-color: #c41e3a;
  }

  .debug-themes {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .theme-preview-btn {
    padding: 8px 12px;
    border: 2px solid var(--color-border);
    border-radius: 6px;
    font-size: 12px;
    background: var(--color-bg);
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.2s;
  }

  .theme-preview-btn:hover {
    border-color: #c41e3a;
  }

  .theme-preview-btn.active {
    border-color: #228b22;
    background: rgba(34, 139, 34, 0.1);
  }

  .debug-state {
    padding: 12px;
    background: var(--color-bg-secondary);
    border-radius: 6px;
    font-size: 11px;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 200px;
    margin: 0;
    color: var(--color-text);
  }

  /* Dark mode adjustments */
  .dark .debug-panel {
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  }

  /* Hotkey hint */
  .debug-panel::after {
    content: 'Press Cmd+Shift+\\ to toggle';
    position: absolute;
    bottom: -24px;
    right: 0;
    font-size: 10px;
    color: var(--color-text-secondary);
    opacity: 0.7;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const panel = document.getElementById('holiday-debug-panel');
    const closeBtn = document.getElementById('debug-close');
    const dateInput = document.getElementById('debug-date') as HTMLInputElement;
    const applyDateBtn = document.getElementById('debug-apply-date');
    const resetDateBtn = document.getElementById('debug-reset-date');
    const localeSelect = document.getElementById('debug-locale') as HTMLSelectElement;
    const stateDisplay = document.getElementById('debug-state');

    // =========================================================================
    // CONSTANTS - Must be defined before functions that use them
    // =========================================================================

    // All possible theme classes
    const ALL_THEMES = [
      'christmas', 'hanukkah', 'newyear', 'diwali', 'lunar-new-year',
      'holi', 'eid', 'july-4th', 'bastille-day', 'german-unity', 'yom-haatzmaut'
    ];

    // Holiday definitions for client-side matching
    // Month is 1-indexed for readability
    const HOLIDAY_DATES: Array<{
      id: string;
      start: [number, number];
      end: [number, number];
      theme: string;
      years?: number[];
      locales?: string[];
    }> = [
      // Global holidays
      { id: 'christmas', start: [12, 20], end: [12, 26], theme: 'christmas' },
      { id: 'newyear', start: [1, 1], end: [1, 3], theme: 'newyear' },

      // Year-specific holidays (lunar calendar based)
      { id: 'hanukkah-2025', start: [12, 14], end: [12, 22], theme: 'hanukkah', years: [2025] },
      { id: 'hanukkah-2026', start: [12, 5], end: [12, 13], theme: 'hanukkah', years: [2026] },
      { id: 'diwali-2025', start: [10, 18], end: [10, 24], theme: 'diwali', years: [2025] },
      { id: 'diwali-2026', start: [11, 7], end: [11, 13], theme: 'diwali', years: [2026] },
      { id: 'lunar-ny-2025', start: [1, 26], end: [2, 9], theme: 'lunar-new-year', years: [2025] },
      { id: 'lunar-ny-2026', start: [2, 14], end: [2, 28], theme: 'lunar-new-year', years: [2026] },
      { id: 'holi-2025', start: [3, 12], end: [3, 16], theme: 'holi', years: [2025] },
      { id: 'holi-2026', start: [3, 1], end: [3, 5], theme: 'holi', years: [2026] },

      // Locale-specific holidays
      { id: 'july-4th', start: [7, 1], end: [7, 7], theme: 'july-4th', locales: ['US'] },
      { id: 'bastille', start: [7, 12], end: [7, 16], theme: 'bastille-day', locales: ['FR'] },
      { id: 'german-unity', start: [10, 1], end: [10, 5], theme: 'german-unity', locales: ['DE'] },
      { id: 'yom-haatzmaut', start: [5, 1], end: [5, 3], theme: 'yom-haatzmaut', locales: ['IL'] },
    ];

    // =========================================================================
    // HELPER FUNCTIONS - Defined before they're used
    // =========================================================================

    // Check if a date falls within a range (month is 1-indexed)
    function isDateInRange(month: number, day: number, start: [number, number], end: [number, number]): boolean {
      const [startMonth, startDay] = start;
      const [endMonth, endDay] = end;

      // Create comparable numbers (month * 100 + day)
      const dateVal = month * 100 + day;
      const startVal = startMonth * 100 + startDay;
      const endVal = endMonth * 100 + endDay;

      if (startVal <= endVal) {
        // Normal range within same year (e.g., Jan 1-3, Oct 1-5)
        return dateVal >= startVal && dateVal <= endVal;
      } else {
        // Range crosses year boundary (e.g., Dec 20 - Jan 3)
        return dateVal >= startVal || dateVal <= endVal;
      }
    }

    // Determine which theme should be active for a given date
    function getThemeForDate(date: Date, localeOverride?: string): string | null {
      const month = date.getMonth() + 1; // Convert to 1-indexed
      const day = date.getDate();
      const year = date.getFullYear();

      console.log(`ğŸ” Checking theme for: ${year}-${month}-${day}, locale: ${localeOverride || 'auto'}`);

      for (const holiday of HOLIDAY_DATES) {
        // Skip if year-specific and doesn't match
        if (holiday.years && !holiday.years.includes(year)) {
          continue;
        }

        // Check if date is in range
        if (!isDateInRange(month, day, holiday.start, holiday.end)) {
          continue;
        }

        console.log(`ğŸ“… Date matches: ${holiday.id}`);

        // Check locale restrictions
        if (holiday.locales && holiday.locales.length > 0) {
          if (!localeOverride || !holiday.locales.includes(localeOverride)) {
            console.log(`ğŸŒ Locale ${localeOverride} doesn't match required: ${holiday.locales.join(', ')}`);
            continue;
          }
        }

        console.log(`âœ… Theme selected: ${holiday.theme}`);
        return holiday.theme;
      }

      console.log('âŒ No matching theme found');
      return null;
    }

    // Apply a theme (removing all others first)
    function applyTheme(theme: string | null): void {
      console.log(`ğŸ¨ Applying theme: ${theme || 'none'}`);

      // Remove all theme classes
      ALL_THEMES.forEach(t => document.documentElement.classList.remove(t));

      // Apply new theme
      if (theme && theme !== 'none') {
        document.documentElement.classList.add(theme);
        console.log(`âœ“ Added class: ${theme}`);
      }

      // Update preview button states
      document.querySelectorAll('.theme-preview-btn').forEach(btn => {
        const btnTheme = (btn as HTMLElement).dataset.theme || 'none';
        btn.classList.toggle('active', btnTheme === (theme || 'none'));
      });

      // Save to localStorage
      localStorage.setItem('holidayTheme', theme || 'none');
    }

    // Set test date and apply appropriate theme
    function setTestDateAndApplyTheme(dateStr: string): void {
      console.log(`ğŸ“† Setting test date: ${dateStr}`);

      const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!match) {
        console.error('Invalid date format:', dateStr);
        return;
      }

      const [, yearStr, monthStr, dayStr] = match;
      const date = new Date(parseInt(yearStr), parseInt(monthStr) - 1, parseInt(dayStr));

      if (isNaN(date.getTime())) {
        console.error('Invalid date:', dateStr);
        return;
      }

      // Set the test date globally
      (window as any).__CARO_TEST_DATE = date.toISOString();

      // Update date input
      if (dateInput) {
        dateInput.value = dateStr;
      }

      // Determine and apply the appropriate theme
      const localeOverride = localStorage.getItem('debug_locale_override') || undefined;
      const theme = getThemeForDate(date, localeOverride);
      applyTheme(theme);

      // Update state display
      updateDebugState();
    }

    // Update debug state display
    function updateDebugState(): void {
      if (!stateDisplay) return;

      const now = (window as any).__CARO_TEST_DATE
        ? new Date((window as any).__CARO_TEST_DATE)
        : new Date();

      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const language = navigator.language;
      const localeOverride = localStorage.getItem('debug_locale_override');
      const detectedTheme = getThemeForDate(now, localeOverride || undefined);

      const state = {
        date: now.toISOString().split('T')[0],
        timezone,
        language,
        localeOverride: localeOverride || 'none',
        detectedTheme: detectedTheme || 'none',
        savedTheme: localStorage.getItem('holidayTheme') || 'none',
        appliedClasses: Array.from(document.documentElement.classList),
      };

      stateDisplay.textContent = JSON.stringify(state, null, 2);
    }

    // =========================================================================
    // ACCESS CONTROL
    // =========================================================================

    function shouldShowDebug(): boolean {
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return true;
      }
      const params = new URLSearchParams(window.location.search);
      return params.has('holidayDebug');
    }

    if (!shouldShowDebug()) {
      panel?.remove();
      return;
    }

    // =========================================================================
    // EVENT HANDLERS
    // =========================================================================

    // Toggle panel with hotkey (Cmd+Shift+\ or Ctrl+Shift+\)
    document.addEventListener('keydown', (e) => {
      const isBackslash = e.code === 'Backslash' || e.key === '|' || e.key === '\\';
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && isBackslash) {
        e.preventDefault();
        panel?.classList.toggle('hidden');
        if (!panel?.classList.contains('hidden')) {
          updateDebugState();
        }
      }
    });

    // Close button
    closeBtn?.addEventListener('click', () => {
      panel?.classList.add('hidden');
    });

    // Initialize date input with current or test date
    if (dateInput) {
      const testDate = (window as any).__CARO_TEST_DATE;
      if (testDate) {
        dateInput.value = new Date(testDate).toISOString().split('T')[0];
      } else {
        dateInput.value = new Date().toISOString().split('T')[0];
      }
    }

    // Apply date button
    applyDateBtn?.addEventListener('click', () => {
      if (dateInput?.value) {
        setTestDateAndApplyTheme(dateInput.value);
      }
    });

    // Reset date button
    resetDateBtn?.addEventListener('click', () => {
      delete (window as any).__CARO_TEST_DATE;
      const now = new Date();
      if (dateInput) {
        dateInput.value = now.toISOString().split('T')[0];
      }
      const localeOverride = localStorage.getItem('debug_locale_override') || undefined;
      const theme = getThemeForDate(now, localeOverride);
      applyTheme(theme);
      updateDebugState();
      console.log('ğŸ§ª Test date reset to today');
    });

    // Quick date presets
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const date = (btn as HTMLElement).dataset.date;
        if (date) {
          setTestDateAndApplyTheme(date);
        }
      });
    });

    // Locale selector
    localeSelect?.addEventListener('change', () => {
      const locale = localeSelect.value;
      if (locale) {
        localStorage.setItem('debug_locale_override', locale);
      } else {
        localStorage.removeItem('debug_locale_override');
      }

      const now = (window as any).__CARO_TEST_DATE
        ? new Date((window as any).__CARO_TEST_DATE)
        : new Date();
      const theme = getThemeForDate(now, locale || undefined);
      applyTheme(theme);
      updateDebugState();
      console.log(`ğŸŒ Locale set to: ${locale || 'auto-detect'}`);
    });

    // Restore saved locale override
    const savedLocale = localStorage.getItem('debug_locale_override');
    if (savedLocale && localeSelect) {
      localeSelect.value = savedLocale;
    }

    // Theme preview buttons (manual override)
    document.querySelectorAll('.theme-preview-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const theme = (btn as HTMLElement).dataset.theme || null;
        applyTheme(theme === 'none' ? null : theme);
        updateDebugState();
        console.log(`ğŸ¨ Theme manually set to: ${theme || 'none'}`);
      });
    });

    // Initialize button states
    const currentTheme = localStorage.getItem('holidayTheme') || 'none';
    document.querySelectorAll('.theme-preview-btn').forEach(btn => {
      btn.classList.toggle('active', (btn as HTMLElement).dataset.theme === currentTheme);
    });

    // =========================================================================
    // INITIALIZATION
    // =========================================================================

    // Initial state update
    updateDebugState();

    // Show panel if query param is set
    const params = new URLSearchParams(window.location.search);
    if (params.has('holidayDebug')) {
      panel?.classList.remove('hidden');
    }

    console.log('ğŸ„ Holiday Debug Panel loaded. Press Cmd+Shift+\\ to toggle.');
  });
</script>
