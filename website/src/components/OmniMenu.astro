---
/**
 * OmniMenu - Cmd+/ quick navigation menu
 *
 * Simple, fast page search with fuzzy matching.
 * Built at compile time, no runtime dependencies.
 */

import { PAGES_INDEX } from '../config/pages';

// Feature flag: enabled on preview, disabled on production unless explicit
const isPreview = import.meta.env.VERCEL_ENV === 'preview';
const isExplicit = import.meta.env.ENABLE_OMNI_MENU === 'true';
const isProd = import.meta.env.VERCEL_ENV === 'production';
const isEnabled = isPreview || isExplicit || !isProd;

// Pre-build search index at compile time
const searchIndex = PAGES_INDEX.map(p => ({
  ...p,
  // Pre-compute searchable text (lowercase, combined)
  _search: [p.title, p.description || '', p.path, ...(p.keywords || [])].join(' ').toLowerCase()
}));
---

{isEnabled && (
  <div id="omni-overlay" class="omni-overlay" data-pages={JSON.stringify(searchIndex)}>
    <div class="omni-backdrop"></div>
    <div class="omni-dialog">
      <div class="omni-search-box">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" id="omni-input" placeholder="Search pages..." autocomplete="off" spellcheck="false" />
        <kbd>esc</kbd>
      </div>
      <div id="omni-list" class="omni-list"></div>
      <div class="omni-footer">
        <span><kbd>â†‘â†“</kbd> navigate</span>
        <span><kbd>â†µ</kbd> open</span>
        <span><kbd>esc</kbd> close</span>
      </div>
    </div>
  </div>
)}

<style is:global>
  .omni-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 99999;
    padding: 12vh 16px 16px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
  }
  .omni-overlay.open { display: flex; justify-content: center; }

  .omni-backdrop {
    position: absolute;
    inset: 0;
  }

  .omni-dialog {
    position: relative;
    width: 100%;
    max-width: 520px;
    max-height: 70vh;
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #e0e0e0);
    border-radius: 12px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: omni-in 0.15s ease-out;
  }

  @keyframes omni-in {
    from { opacity: 0; transform: scale(0.96) translateY(-8px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .omni-search-box {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--color-border, #e0e0e0);
  }
  .omni-search-box svg {
    flex-shrink: 0;
    color: var(--color-text-secondary, #666);
  }
  .omni-search-box input {
    flex: 1;
    border: none;
    background: none;
    font-size: 16px;
    color: var(--color-text, #333);
    outline: none;
  }
  .omni-search-box input::placeholder {
    color: var(--color-text-secondary, #999);
  }
  .omni-search-box kbd {
    padding: 2px 6px;
    font-size: 11px;
    font-family: inherit;
    background: var(--color-bg-secondary, #f5f5f5);
    border: 1px solid var(--color-border, #ddd);
    border-radius: 4px;
    color: var(--color-text-secondary, #666);
  }

  .omni-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .omni-group-label {
    padding: 8px 10px 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-secondary, #888);
  }

  .omni-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    margin: 2px 0;
    border-radius: 8px;
    text-decoration: none;
    color: var(--color-text, #333);
    cursor: pointer;
    transition: background 0.1s;
  }
  .omni-item:hover { background: var(--color-bg-secondary, #f5f5f5); }
  .omni-item.active {
    background: rgba(255,140,66,0.12);
  }
  .omni-item.active .omni-title { color: #ff8c42; }

  .omni-icon {
    font-size: 18px;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
  }

  .omni-info { flex: 1; min-width: 0; }

  .omni-title {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .omni-desc {
    font-size: 12px;
    color: var(--color-text-secondary, #888);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .omni-arrow {
    color: var(--color-text-secondary, #aaa);
    opacity: 0;
    transition: opacity 0.1s;
  }
  .omni-item:hover .omni-arrow,
  .omni-item.active .omni-arrow { opacity: 1; }

  .omni-empty {
    padding: 32px 16px;
    text-align: center;
    color: var(--color-text-secondary, #888);
  }

  .omni-footer {
    display: flex;
    justify-content: center;
    gap: 16px;
    padding: 10px 16px;
    border-top: 1px solid var(--color-border, #e0e0e0);
    background: var(--color-bg-secondary, #f9f9f9);
    font-size: 12px;
    color: var(--color-text-secondary, #888);
  }
  .omni-footer kbd {
    padding: 1px 5px;
    font-size: 10px;
    font-family: inherit;
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #ddd);
    border-radius: 3px;
  }

  .omni-match {
    background: rgba(255,140,66,0.25);
    border-radius: 2px;
  }

  @media (max-width: 600px) {
    .omni-overlay { padding: 8vh 12px 12px; }
    .omni-footer { display: none; }
  }
</style>

<script>
  const overlay = document.getElementById('omni-overlay');
  if (!overlay) throw new Error('OmniMenu: overlay not found');

  const input = document.getElementById('omni-input') as HTMLInputElement;
  const list = document.getElementById('omni-list')!;
  const pages = JSON.parse(overlay.dataset.pages || '[]');

  let activeIdx = 0;
  let filtered = pages;

  // Simple fuzzy search: all query tokens must appear in searchable text
  function fuzzyMatch(text: string, query: string): boolean {
    if (!query) return true;
    const tokens = query.toLowerCase().split(/\s+/).filter(Boolean);
    return tokens.every(t => text.includes(t));
  }

  function search(query: string) {
    const q = query.trim().toLowerCase();
    if (!q) return pages;

    return pages.filter((p: any) => fuzzyMatch(p._search, q)).sort((a: any, b: any) => {
      const aTitle = a.title.toLowerCase();
      const bTitle = b.title.toLowerCase();
      // Exact title match first
      if (aTitle === q && bTitle !== q) return -1;
      if (bTitle === q && aTitle !== q) return 1;
      // Title starts with query
      if (aTitle.startsWith(q) && !bTitle.startsWith(q)) return -1;
      if (bTitle.startsWith(q) && !aTitle.startsWith(q)) return 1;
      // Title contains query
      if (aTitle.includes(q) && !bTitle.includes(q)) return -1;
      if (bTitle.includes(q) && !aTitle.includes(q)) return 1;
      return 0;
    });
  }

  function highlight(text: string, query: string): string {
    if (!query) return escHtml(text);
    const tokens = query.toLowerCase().split(/\s+/).filter(Boolean);
    let result = escHtml(text);
    tokens.forEach(t => {
      const re = new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      result = result.replace(re, '<span class="omni-match">$1</span>');
    });
    return result;
  }

  function escHtml(s: string): string {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function render(query: string) {
    filtered = search(query);
    activeIdx = 0;

    if (filtered.length === 0) {
      list.innerHTML = `<div class="omni-empty">No results for "${escHtml(query)}"</div>`;
      return;
    }

    // Group by category
    const groups: Record<string, any[]> = {};
    const order = ['main', 'use-cases', 'compare', 'blog', 'docs'];
    const labels: Record<string, string> = {
      main: 'Pages', 'use-cases': 'Use Cases', compare: 'Compare', blog: 'Blog', docs: 'Docs'
    };

    filtered.forEach((p: any) => {
      if (!groups[p.category]) groups[p.category] = [];
      groups[p.category].push(p);
    });

    let html = '';
    let idx = 0;

    order.forEach(cat => {
      if (!groups[cat]) return;
      html += `<div class="omni-group-label">${labels[cat] || cat}</div>`;
      groups[cat].forEach((p: any) => {
        const cls = idx === 0 ? 'omni-item active' : 'omni-item';
        html += `<a href="${p.path}" class="${cls}" data-idx="${idx}">
          <span class="omni-icon">${p.icon || 'ðŸ“„'}</span>
          <div class="omni-info">
            <div class="omni-title">${highlight(p.title, query)}</div>
            ${p.description ? `<div class="omni-desc">${highlight(p.description, query)}</div>` : ''}
          </div>
          <span class="omni-arrow">â†’</span>
        </a>`;
        idx++;
      });
    });

    list.innerHTML = html;
  }

  function setActive(idx: number) {
    const items = list.querySelectorAll('.omni-item');
    if (items.length === 0) return;
    activeIdx = Math.max(0, Math.min(idx, items.length - 1));
    items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
    items[activeIdx]?.scrollIntoView({ block: 'nearest' });
  }

  function open() {
    overlay.classList.add('open');
    input.value = '';
    render('');
    input.focus();
    document.body.style.overflow = 'hidden';
  }

  function close() {
    overlay.classList.remove('open');
    document.body.style.overflow = '';
  }

  function go() {
    const item = list.querySelectorAll('.omni-item')[activeIdx] as HTMLAnchorElement;
    if (item?.href) {
      close();
      window.location.href = item.href;
    }
  }

  // Event listeners
  document.addEventListener('keydown', e => {
    if ((e.metaKey || e.ctrlKey) && e.key === '/') {
      e.preventDefault();
      overlay.classList.contains('open') ? close() : open();
    }
    if (e.key === 'Escape' && overlay.classList.contains('open')) {
      e.preventDefault();
      close();
    }
  });

  overlay.querySelector('.omni-backdrop')?.addEventListener('click', close);

  input.addEventListener('input', () => render(input.value));

  input.addEventListener('keydown', e => {
    if (e.key === 'ArrowDown') { e.preventDefault(); setActive(activeIdx + 1); }
    if (e.key === 'ArrowUp') { e.preventDefault(); setActive(activeIdx - 1); }
    if (e.key === 'Enter') { e.preventDefault(); go(); }
  });

  list.addEventListener('click', e => {
    const item = (e.target as HTMLElement).closest('.omni-item');
    if (item) close();
  });
</script>
